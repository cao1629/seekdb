#owner: shenyunlong.syl
#owner group: shenzhen

### root
connection default;

--error 0,11118
call DBMS_AI_SERVICE.DROP_AI_MODEL('my_ai_model_1');
--error 0,11118
call DBMS_AI_SERVICE.DROP_AI_MODEL('my_ai_model_2');
--error 0,11118
call DBMS_AI_SERVICE.DROP_AI_MODEL('my_ai_model_3');
--error 0,11118
call DBMS_AI_SERVICE.DROP_AI_MODEL('my_ai_model_4');

### positive cases
call DBMS_AI_SERVICE.CREATE_AI_MODEL(
  'my_ai_model_1', '{
    "type": "dense_embedding",
    "model_name": "text-embedding-v1"
  }');

select NAME, TYPE, MODEL_NAME from oceanbase.DBA_OB_AI_MODELS where NAME = 'my_ai_model_1';

call DBMS_AI_SERVICE.CREATE_AI_MODEL(
  'my_ai_model_2', '{
    "type": "sparse_embedding",
    "model_name": "text-embedding-v4"
  }');
select NAME, TYPE, MODEL_NAME from oceanbase.DBA_OB_AI_MODELS where NAME = 'my_ai_model_2';

call DBMS_AI_SERVICE.CREATE_AI_MODEL(
  'my_ai_model_3', '{
    "type": "completion",
    "model_name": "hunyuan-t1-20250711"
  }');
select NAME, TYPE, MODEL_NAME from oceanbase.DBA_OB_AI_MODELS where NAME = 'my_ai_model_3';

call DBMS_AI_SERVICE.CREATE_AI_MODEL(
  'my_ai_model_4', '{
    "type": "rerank",
    "model_name": "Qwen/Qwen3-Reranker-0.6B"
  }');
select NAME, TYPE, MODEL_NAME from oceanbase.DBA_OB_AI_MODELS where NAME = 'my_ai_model_4';

call DBMS_AI_SERVICE.DROP_AI_MODEL('my_ai_model_1');
call DBMS_AI_SERVICE.DROP_AI_MODEL('my_ai_model_2');
call DBMS_AI_SERVICE.DROP_AI_MODEL('my_ai_model_3');

### negative cases
--error 11116
call DBMS_AI_SERVICE.CREATE_AI_MODEL(
  'my_ai_model_1', '{
    "type": "unknow",
    "model_name": "Qwen/Qwen3-Reranker-0.6B"
  }');

--error 11114
call DBMS_AI_SERVICE.CREATE_AI_MODEL(
  'my_ai_model_1', '{
    "model_name": "Qwen/Qwen3-Reranker-0.6B"
  }');

--error 11116
call DBMS_AI_SERVICE.CREATE_AI_MODEL(
  'my_ai_model_1', '{
    "type": "",
    "model_name": "Qwen/Qwen3-Reranker-0.6B"
  }');

--error 11114
call DBMS_AI_SERVICE.CREATE_AI_MODEL(
  'my_ai_model_1', '{
    "type": "dense_embedding",
    "model_name": ""
  }');

--error 11114
call DBMS_AI_SERVICE.CREATE_AI_MODEL(
  'my_ai_model_1', '{
    "type": "dense_embedding"
  }');

--error 11114
call DBMS_AI_SERVICE.CREATE_AI_MODEL(
  'my_ai_model_1', '{
  }');

--error 11119
call DBMS_AI_SERVICE.CREATE_AI_MODEL(
  'my_ai_model_4', '{
    "type": "rerank",
    "model_name": "Qwen/Qwen3-Reranker-0.6B"
  }');

--error 11114
call DBMS_AI_SERVICE.DROP_AI_MODEL('');

### test cdb view
connect (sys_conn,$OBMYSQL_MS0,root,,oceanbase,$OBMYSQL_PORT);
connection sys_conn;
--error 0,11118
call DBMS_AI_SERVICE.DROP_AI_MODEL('my_ai_model_3');

call DBMS_AI_SERVICE.CREATE_AI_MODEL(
  'my_ai_model_3', '{
    "type": "completion",
    "model_name": "hunyuan-t1-20250711"
  }');

select NAME, TYPE, MODEL_NAME from oceanbase.CDB_OB_AI_MODELS WHERE NAME in ('my_ai_model_3', 'my_ai_model_4') ORDER BY TENANT_ID;

call DBMS_AI_SERVICE.DROP_AI_MODEL('my_ai_model_3');
select user_id, database_id, database_name, tablegroup_id, table_name, operation_type, ddl_stmt_str from oceanbase.__all_ddl_operation where operation_type >= 2154 and operation_type <= 2157 order by gmt_create desc limit 2;

connection default;
call DBMS_AI_SERVICE.DROP_AI_MODEL('my_ai_model_4');

select user_id, database_id, database_name, tablegroup_id, table_name, operation_type, ddl_stmt_str from oceanbase.__all_ddl_operation where operation_type >= 2154 and operation_type <= 2157 order by gmt_create desc limit 8;
### test_ai_user
connect (obsys,$OBMYSQL_MS0,admin,$OBMYSQL_PWD,test,$OBMYSQL_PORT);
connection obsys;
--error 0,11118
call DBMS_AI_SERVICE.DROP_AI_MODEL('user_ai_model_1');
--disable_warnings
DROP USER IF EXISTS test_ai_user@'%';
--enable_warnings
CREATE USER test_ai_user@'%' IDENTIFIED BY '123456';
GRANT SELECT ON test.* TO 'test_ai_user'@'%';
SHOW GRANTS FOR test_ai_user@'%';


connect (ai_user,$OBMYSQL_MS0,test_ai_user,'123456',test,$OBMYSQL_PORT);

connection ai_user;
--error 1227
call DBMS_AI_SERVICE.CREATE_AI_MODEL(
  'user_ai_model_1', '{
    "type": "dense_embedding",
    "model_name": "text-embedding-v1"
  }');

connection obsys;
GRANT CREATE AI MODEL ON *.* TO test_ai_user@'%';
connection ai_user;
call DBMS_AI_SERVICE.CREATE_AI_MODEL(
  'user_ai_model_1', '{
    "type": "dense_embedding",
    "model_name": "text-embedding-v1"
  }');
--error 1227
call DBMS_AI_SERVICE.DROP_AI_MODEL('user_ai_model_1');
connection obsys;
GRANT DROP AI MODEL ON *.* TO test_ai_user@'%';
connection ai_user;
call DBMS_AI_SERVICE.DROP_AI_MODEL('user_ai_model_1');

connection obsys;
DROP USER test_ai_user@'%';
