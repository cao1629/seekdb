# owner: wuxingying.wxy
# owner group: shenzhen
# description: test create vector index

connect (conn_user,$OBMYSQL_MS0,root@sys,,test,$OBMYSQL_PORT);
connection conn_user;

--disable_warnings
drop database if exists post_create_vec;
--enable_warnings
create database post_create_vec;
use post_create_vec;

# __all_ddl_operation
--echo
--echo
--echo "=========================================== __all_ddl_operation ==========================================="
--disable_warnings
drop table if exists vec_table;
--enable_warnings
CREATE TABLE vec_table (
  id int primary key,
  c2 vector(10));

alter system set ob_vector_memory_limit_percentage = 20;
sleep 3;
CREATE VECTOR INDEX VEC_IDX1 ON vec_table(c2) with (distance=l2, type=hnsw, lib=vsag);

select operation_type, ddl_stmt_str from oceanbase.__all_ddl_operation
   where database_id = (select database_id from oceanbase.__all_database where database_name='post_create_vec')
          and ddl_stmt_str != '' order by schema_version;

drop table vec_table;

# 索引名有转义字符
--echo
--echo
--echo "=========================================== 索引名有转义字符 ================================================="
--disable_warnings
drop table if exists t_vec;
--enable_warnings
create table t_vec(c1 int, c2 vector(3), primary key(c1));

create vector index `idx\n1` ON t_vec(c2) with (distance=l2, type=hnsw, lib=vsag);
drop table t_vec;

# 索引名有大小写
--echo
--echo
--echo "=========================================== 索引名有大小写 ==================================================="
--disable_warnings
drop table if exists t_vec;
--enable_warnings
create table t_vec(c1 int, c2 vector(3), primary key(c1));

create vector index iDx1 ON t_vec(c2) with (distance=l2, type=hnsw, lib=vsag);
drop table t_vec;

# 索引名有特殊字符
# case 1
--echo
--echo
--echo "========================================== 索引名有特殊字符 001 ==============================================="

--disable_warnings
drop table if exists t_vec;
--enable_warnings
create table t_vec(c1 int, c2 vector(3), primary key(c1));

create vector index iDx$1 ON t_vec(c2) with (distance=l2, type=hnsw, lib=vsag);
drop table t_vec;

# case 2
--echo
--echo
--echo "========================================== 索引名有特殊字符 002 ==============================================="
--disable_warnings
drop table if exists t_vec;
--enable_warnings
create table t_vec(c1 int, c2 vector(3), primary key(c1));
create vector index café ON t_vec(c2) with (distance=l2, type=hnsw, lib=vsag);
drop table t_vec;

# case 特殊字符café与cafe，认为创建同名索引失败
--echo
--echo
--echo "========================================== 索引名有特殊字符 003 ==============================================="
--disable_warnings
drop table if exists t_vec;
--enable_warnings
create table t_vec(c1 int, c2 vector(3), c3 vector(3), primary key(c1));
create vector index café ON t_vec(c2) with (distance=l2, type=hnsw, lib=vsag);
--error 1061
create vector index cafe ON t_vec(c3) with (distance=l2, type=hnsw, lib=vsag);
drop table t_vec;


--disable_warnings
drop table if exists t1;
--enable_warnings
create table t1(c1 int primary key, c2 vector(10));
insert into t1 values(1, '[0.748479,0.276979,0.555195,0.145492,0.045639,0.924278,0.696082,0.841479,0.742934,0.953073]');
--error 1235
create unique index idx1 on t1(c2) with (distance=l2, type=hnsw, lib=vsag);
--error 1072
create vector index idx1 on t1(c5) with (distance=l2, type=hnsw, lib=vsag);
--error 7601
create vector index idx1 on t1(c1) with (distance=l2, type=hnsw, lib=vsag);
--error 1235
create vector index idx1 on t1(c2);
--error 1235
create vector index idx1 on t1(c2) with (distance=l2);
--error 1235
create vector index idx1 on t1(c2) with (distance=l2, lib=vsag);
--error 1235
create vector index idx1 on t1(c2) with (distance=l2, lib=vs);
CREATE VECTOR INDEX IDX1 ON t1(c2) with (distance=l2, type=hnsw, lib=vsag);
drop table t1;


--echo ====================== basic test #2 =================================
--echo ============= create vec index on existing table with data ===========

--disable_warnings
DROP TABLE IF EXISTS t1;
--enable_warnings

create table t1(c1 int, c2 vector(10), primary key(c1));
insert into t1 values(1, '[0.692623,0.816816,0.418483,0.393929,0.061058,0.402308,0.564665,0.406696,0.628286,0.250843]');
insert into t1 values(2, '[0.125866,0.428902,0.214633,0.208882,0.435422,0.045606,0.915596,0.065899,0.523299,0.352734]');
insert into t1 values(3, '[0.904051,0.864011,0.292710,0.748016,0.307713,0.820417,0.735923,0.839659,0.742446,0.146719]');
insert into t1 values(4, '[0.234391,0.660406,0.370087,0.860388,0.586119,0.668096,0.122285,0.670929,0.997141,0.177069]');
insert into t1 values(5, '[0.958113,0.424453,0.091372,0.726940,0.173619,0.023668,0.220956,0.260019,0.402649,0.175887]');
insert into t1 values(6, '[0.361888,0.645381,0.156383,0.099361,0.565967,0.848600,0.445232,0.616518,0.345585,0.636063]');
insert into t1 values(7, '[0.279319,0.570040,0.217214,0.826609,0.337557,0.718166,0.431902,0.670941,0.330390,0.138255]');
insert into t1 values(8, '[0.201525,0.342033,0.391054,0.393511,0.708165,0.654430,0.936382,0.402074,0.487789,0.838557]');
insert into t1 values(9, '[0.531002,0.850454,0.513266,0.833590,0.771357,0.659888,0.980127,0.607635,0.315216,0.932509]');
insert into t1 values(10, '[0.707352,0.537032,0.433431,0.727523,0.293137,0.990979,0.967610,0.895034,0.479304,0.205645]');
insert into t1 values(11, '[0.022470,0.178305,0.813060,0.463923,0.276312,0.330019,0.043964,0.830623,0.266355,0.886212]');
insert into t1 values(12, '[0.612456,0.419102,0.939437,0.701895,0.475109,0.334464,0.876076,0.120166,0.537638,0.117534]');
insert into t1 values(13, '[0.637985,0.435922,0.507803,0.173239,0.731558,0.475490,0.137246,0.659436,0.887185,0.237127]');
insert into t1 values(14, '[0.261976,0.930429,0.471947,0.405530,0.324696,0.734540,0.014641,0.351016,0.500687,0.521748]');
insert into t1 values(15, '[0.019532,0.482579,0.978059,0.180159,0.529910,0.638184,0.080544,0.862590,0.296779,0.514347]');
insert into t1 values(16, '[0.620133,0.953822,0.820692,0.200903,0.382887,0.589525,0.848620,0.660047,0.848600,0.643394]');
insert into t1 values(17, '[0.456015,0.692266,0.896331,0.782146,0.070535,0.338547,0.635440,0.135370,0.200973,0.648648]');
insert into t1 values(18, '[0.661974,0.050978,0.300594,0.309149,0.589825,0.455377,0.160762,0.713093,0.326418,0.624236]');
insert into t1 values(19, '[0.269763,0.342426,0.800285,0.910017,0.817684,0.551279,0.411955,0.685510,0.706911,0.667069]');
insert into t1 values(20, '[0.141073,0.986008,0.033824,0.416001,0.251765,0.227110,0.177887,0.734944,0.606629,0.235345]');
insert into t1 values(21, '[0.419407,0.620409,0.127571,0.393134,0.865850,0.634016,0.484868,0.354855,0.393209,0.576745]');
insert into t1 values(22, '[0.041515,0.507417,0.404863,0.659963,0.584645,0.893935,0.574154,0.356759,0.969593,0.524461]');
insert into t1 values(23, '[0.320389,0.752659,0.642094,0.510712,0.892990,0.391960,0.240862,0.351762,0.448939,0.695005]');
insert into t1 values(24, '[0.240333,0.126798,0.810217,0.020918,0.026532,0.342625,0.184299,0.807100,0.101946,0.325436]');
insert into t1 values(25, '[0.337841,0.885516,0.017209,0.749467,0.690601,0.649319,0.683582,0.994471,0.206399,0.764540]');
insert into t1 values(26, '[0.189038,0.534414,0.478418,0.224103,0.749363,0.003588,0.041515,0.937407,0.849911,0.022840]');
insert into t1 values(27, '[0.449608,0.990015,0.577008,0.180818,0.273332,0.254307,0.074669,0.364649,0.434206,0.994659]');
insert into t1 values(28, '[0.206516,0.781337,0.798483,0.549615,0.845935,0.990020,0.765809,0.442750,0.262689,0.197060]');
insert into t1 values(29, '[0.340534,0.828488,0.809392,0.124536,0.589825,0.926236,0.192225,0.506307,0.911179,0.958280]');
insert into t1 values(30, '[0.283496,0.571343,0.029242,0.124528,0.205105,0.420073,0.939628,0.792571,0.540698,0.289471]');
insert into t1 values(31, '[0.049301,0.278312,0.671894,0.982578,0.885509,0.958013,0.788695,0.002118,0.996621,0.387809]');
insert into t1 values(32, '[0.236127,0.258542,0.868884,0.042678,0.595697,0.268481,0.012051,0.801324,0.952763,0.522798]');
insert into t1 values(33, '[0.076815,0.273889,0.622370,0.648800,0.578868,0.683797,0.737913,0.785367,0.752820,0.887270]');
insert into t1 values(34, '[0.324925,0.107778,0.962401,0.523522,0.790412,0.958983,0.108708,0.135132,0.935051,0.649769]');
insert into t1 values(35, '[0.038857,0.654172,0.143066,0.633151,0.159498,0.055812,0.821698,0.357435,0.107890,0.302178]');
insert into t1 values(36, '[0.656600,0.774219,0.219927,0.338169,0.076971,0.765809,0.457919,0.319581,0.684450,0.978672]');
insert into t1 values(37, '[0.334026,0.043526,0.929846,0.894381,0.519075,0.139456,0.786002,0.261313,0.717511,0.513035]');
insert into t1 values(38, '[0.539490,0.940232,0.715131,0.831306,0.785149,0.052129,0.019936,0.751876,0.862698,0.887735]');
insert into t1 values(39, '[0.531826,0.739001,0.549655,0.984751,0.436736,0.719286,0.894087,0.966135,0.579325,0.716148]');
insert into t1 values(40, '[0.453904,0.861052,0.510306,0.376351,0.259270,0.280282,0.975205,0.331780,0.781337,0.769253]');
insert into t1 values(41, '[0.163310,0.004977,0.213224,0.821512,0.589998,0.492559,0.256060,0.626285,0.973289,0.023334]');
insert into t1 values(42, '[0.793831,0.950869,0.548484,0.340717,0.200230,0.135982,0.069892,0.116858,0.313396,0.221127]');
insert into t1 values(43, '[0.076971,0.595496,0.109444,0.826266,0.761834,0.276950,0.983140,0.924451,0.452649,0.741904]');
insert into t1 values(44, '[0.078073,0.884127,0.995884,0.875908,0.276746,0.949087,0.187826,0.809634,0.089585,0.619755]');
insert into t1 values(45, '[0.376171,0.342454,0.005138,0.636035,0.895416,0.649869,0.384188,0.645395,0.692025,0.704840]');
insert into t1 values(46, '[0.203679,0.356838,0.589869,0.792328,0.088394,0.110016,0.923422,0.509104,0.098244,0.635554]');
insert into t1 values(47, '[0.735566,0.551480,0.497867,0.207448,0.664736,0.528350,0.032674,0.789483,0.110994,0.727582]');
insert into t1 values(48, '[0.987391,0.028298,0.352636,0.465489,0.842447,0.663842,0.915825,0.984997,0.067711,0.211012]');
insert into t1 values(49, '[0.123562,0.135331,0.737436,0.191966,0.339220,0.017391,0.681821,0.579131,0.929836,0.872307]');
insert into t1 values(50, '[0.423408,0.680491,0.546852,0.603659,0.172113,0.494712,0.957248,0.943980,0.664736,0.250311]');
insert into t1 values(51, '[0.804413,0.418312,0.962013,0.093298,0.877678,0.393275,0.959904,0.732272,0.111936,0.551731]');
insert into t1 values(52, '[0.793293,0.493491,0.409209,0.619098,0.170786,0.753570,0.400260,0.902183,0.157740,0.466963]');
insert into t1 values(53, '[0.734090,0.369797,0.118533,0.651789,0.062088,0.908342,0.262890,0.537826,0.418936,0.075473]');
insert into t1 values(54, '[0.245900,0.918781,0.150004,0.101155,0.063551,0.235383,0.815902,0.178217,0.509152,0.059397]');
insert into t1 values(55, '[0.695020,0.562402,0.698578,0.755540,0.966508,0.261325,0.595835,0.878607,0.251536,0.499435]');
insert into t1 values(56, '[0.345439,0.432995,0.296789,0.702613,0.985917,0.703674,0.408790,0.215288,0.639261,0.435175]');
insert into t1 values(57, '[0.671465,0.304623,0.045439,0.692615,0.485055,0.023957,0.858320,0.267629,0.806481,0.365449]');
insert into t1 values(58, '[0.003683,0.832318,0.423682,0.071571,0.329616,0.374329,0.969725,0.382506,0.576668,0.656891]');
insert into t1 values(59, '[0.150368,0.390111,0.671415,0.750609,0.776912,0.782380,0.598624,0.765018,0.976433,0.637283]');
insert into t1 values(60, '[0.847107,0.008023,0.345039,0.376495,0.709793,0.293401,0.309898,0.693083,0.543201,0.433903]');
insert into t1 values(61, '[0.881415,0.298634,0.140910,0.742234,0.972925,0.781756,0.383014,0.123816,0.994182,0.484228]');
insert into t1 values(62, '[0.649132,0.848793,0.299961,0.423198,0.992485,0.389193,0.243451,0.454440,0.540005,0.013492]');
insert into t1 values(63, '[0.890718,0.152561,0.980121,0.490549,0.200968,0.067392,0.273953,0.815769,0.203636,0.684612]');
insert into t1 values(64, '[0.446449,0.664273,0.737888,0.496109,0.181823,0.114143,0.166578,0.700609,0.400623,0.073666]');
insert into t1 values(65, '[0.438230,0.800508,0.726365,0.658031,0.891912,0.162528,0.933323,0.710890,0.076473,0.011397]');
insert into t1 values(66, '[0.972119,0.645025,0.017140,0.803421,0.923393,0.649959,0.504199,0.296866,0.492065,0.705460]');
insert into t1 values(67, '[0.176491,0.596759,0.592921,0.589412,0.628876,0.280528,0.113348,0.840268,0.797502,0.799445]');
insert into t1 values(68, '[0.163476,0.445692,0.691413,0.810307,0.644148,0.958013,0.741895,0.899355,0.091417,0.542941]');
insert into t1 values(69, '[0.701504,0.840166,0.786345,0.323074,0.209918,0.972802,0.121533,0.467813,0.498118,0.600434]');
insert into t1 values(70, '[0.237072,0.690586,0.755902,0.524142,0.086226,0.583865,0.111322,0.958013,0.824064,0.971327]');
insert into t1 values(71, '[0.036656,0.243785,0.595873,0.299523,0.448953,0.735959,0.416083,0.013946,0.714083,0.643957]');
insert into t1 values(72, '[0.674942,0.815842,0.204488,0.538217,0.377322,0.364100,0.442750,0.583939,0.212010,0.256284]');
insert into t1 values(73, '[0.321482,0.353764,0.747523,0.532189,0.923149,0.645041,0.547499,0.055913,0.114475,0.622540]');
insert into t1 values(74, '[0.618807,0.717714,0.382073,0.627175,0.185351,0.599275,0.075940,0.351805,0.081602,0.322221]');
insert into t1 values(75, '[0.893002,0.853418,0.470585,0.005067,0.147692,0.399706,0.952763,0.685825,0.083309,0.834141]');
insert into t1 values(76, '[0.253231,0.833505,0.177916,0.894037,0.993196,0.309356,0.008385,0.275818,0.500678,0.273323]');
insert into t1 values(77, '[0.986954,0.454329,0.958870,0.976416,0.096919,0.137483,0.112008,0.570504,0.805384,0.294950]');
insert into t1 values(78, '[0.982720,0.285562,0.510523,0.476800,0.737618,0.382436,0.709451,0.390728,0.396283,0.463887]');
insert into t1 values(79, '[0.418955,0.571343,0.805392,0.498857,0.949157,0.986516,0.265218,0.959242,0.780465,0.932509]');
insert into t1 values(80, '[0.186418,0.838564,0.587042,0.629916,0.845184,0.666977,0.273855,0.030516,0.744734,0.575642]');
insert into t1 values(81, '[0.129771,0.439212,0.480978,0.655767,0.943980,0.047421,0.629647,0.178263,0.102858,0.005922]');
insert into t1 values(82, '[0.195321,0.444840,0.408559,0.214516,0.042632,0.087678,0.487899,0.636996,0.412904,0.406731]');
insert into t1 values(83, '[0.608190,0.831783,0.115209,0.379181,0.471419,0.526226,0.325444,0.339799,0.463794,0.398425]');
insert into t1 values(84, '[0.684031,0.680191,0.511589,0.768690,0.609233,0.093271,0.693639,0.028382,0.028956,0.051688]');
insert into t1 values(85, '[0.107739,0.788995,0.555416,0.230671,0.389665,0.189718,0.569306,0.589598,0.445725,0.773323]');
insert into t1 values(86, '[0.534531,0.335672,0.025485,0.049398,0.300726,0.189549,0.535256,0.753696,0.458094,0.817543]');
insert into t1 values(87, '[0.734225,0.845860,0.374553,0.124167,0.411642,0.584645,0.978368,0.470833,0.168491,0.324780]');
insert into t1 values(88, '[0.018937,0.237942,0.856036,0.642755,0.448273,0.700126,0.925402,0.284770,0.510712,0.397240]');
insert into t1 values(89, '[0.701774,0.217924,0.638699,0.472399,0.070500,0.851535,0.616060,0.380639,0.358238,0.991105]');
insert into t1 values(90, '[0.294740,0.342944,0.891523,0.711690,0.244717,0.836675,0.986624,0.570730,0.564138,0.213549]');
insert into t1 values(91, '[0.606637,0.281785,0.570504,0.933693,0.646798,0.110776,0.044639,0.045098,0.361393,0.933899]');
insert into t1 values(92, '[0.925049,0.664798,0.098244,0.570743,0.233959,0.418777,0.988765,0.966170,0.541446,0.464879]');
insert into t1 values(93, '[0.002739,0.005922,0.642283,0.803123,0.430312,0.174037,0.049912,0.729256,0.930248,0.098027]');
insert into t1 values(94, '[0.141333,0.697821,0.803380,0.459655,0.570009,0.697656,0.175506,0.551207,0.284107,0.679456]');
insert into t1 values(95, '[0.686932,0.819379,0.595831,0.533923,0.588230,0.449009,0.156687,0.571705,0.290796,0.299961]');
insert into t1 values(96, '[0.370349,0.771545,0.710370,0.607978,0.564337,0.447394,0.771964,0.205135,0.564115,0.319493]');
insert into t1 values(97, '[0.663224,0.658997,0.174274,0.901774,0.658710,0.563150,0.027978,0.488359,0.341818,0.580461]');
insert into t1 values(98, '[0.891186,0.749080,0.512433,0.478760,0.262407,0.650191,0.799592,0.988865,0.694612,0.490610]');
insert into t1 values(99, '[0.598567,0.583229,0.796609,0.301088,0.832769,0.625911,0.090200,0.303507,0.793151,0.451798]');
insert into t1 values(100, '[0.032624,0.502349,0.776530,0.548453,0.098763,0.482683,0.822963,0.834279,0.517359,0.672928]');

create vector index idx1 on t1(c2) WITH (distance=L2, lib=vsag, type=hnsw, m=10, ef_construction = 12, ef_search = 40);

select * from t1 order by l2_distance(c2, [0,0,0,0,0,0,0,0,0,0]) limit 10;
select * from t1 order by l2_distance(c2, [0,0,0,0,0,0,0,0,0,0]) approx limit 10;
select /*+ opt_param('rowsets_enabled', 'false') */ * from t1 order by l2_distance(c2, [0,0,0,0,0,0,0,0,0,0]) approx limit 10;

update t1 set c2 = [0.701092,0.489040,0.428438,0.705990,0.408267,0.016295,0.899748,0.386882,0.561377,0.576779] where c1 = 5;
update t1 set c2 = [0.422295,0.386228,0.339575,0.636140,0.039339,0.737867,0.642355,0.300752,0.671344,0.752407] where c1 = 10;
update t1 set c2 = [0.551996,0.833464,0.976193,0.032753,0.331644,0.616481,0.207448,0.719105,0.770708,0.106132] where c1 = 15;
update t1 set c2 = [0.671992,0.149204,0.135660,0.330146,0.236617,0.137281,0.452023,0.224779,0.927160,0.139412] where c1 = 20;
update t1 set c2 = [0.106091,0.676200,0.061431,0.508771,0.437028,0.903998,0.334875,0.740929,0.818194,0.834582] where c1 = 25;
update t1 set c2 = [0.902042,0.267381,0.836580,0.247033,0.911560,0.630998,0.621466,0.974170,0.895245,0.739895] where c1 = 30;
update t1 set c2 = [0.956250,0.207436,0.429831,0.176132,0.021894,0.699511,0.387724,0.516866,0.497352,0.525875] where c1 = 35;
update t1 set c2 = [0.468672,0.893935,0.574821,0.817126,0.137588,0.040539,0.157675,0.422596,0.400695,0.195158] where c1 = 40;
update t1 set c2 = [0.299619,0.441541,0.613601,0.586849,0.307522,0.230799,0.600456,0.553535,0.045893,0.900520] where c1 = 45;
update t1 set c2 = [0.071388,0.819782,0.356017,0.841379,0.450964,0.339373,0.645183,0.394574,0.988807,0.734540] where c1 = 50;
update t1 set c2 = [0.832755,0.427111,0.669666,0.572728,0.783559,0.978271,0.591291,0.619137,0.409328,0.415469] where c1 = 55;
update t1 set c2 = [0.653174,0.505374,0.616843,0.940202,0.281894,0.601430,0.177282,0.492285,0.324255,0.741581] where c1 = 60;
update t1 set c2 = [0.594416,0.770333,0.635807,0.225676,0.376407,0.910324,0.132816,0.348508,0.368792,0.786942] where c1 = 65;
update t1 set c2 = [0.714211,0.081001,0.042533,0.547671,0.420071,0.932686,0.964106,0.094209,0.271481,0.069587] where c1 = 70;
update t1 set c2 = [0.046045,0.666130,0.330664,0.118841,0.106255,0.090468,0.523522,0.958118,0.675807,0.248484] where c1 = 75;
update t1 set c2 = [0.304844,0.980488,0.694092,0.853523,0.414048,0.079251,0.744208,0.140988,0.377191,0.872307] where c1 = 80;
update t1 set c2 = [0.362960,0.564138,0.189022,0.364411,0.335400,0.448953,0.560731,0.337921,0.927873,0.388357] where c1 = 85;
update t1 set c2 = [0.705950,0.655356,0.584362,0.372052,0.914895,0.690303,0.908034,0.163541,0.705480,0.607188] where c1 = 90;
update t1 set c2 = [0.411477,0.409965,0.108774,0.743443,0.651615,0.041827,0.183932,0.535781,0.223155,0.708496] where c1 = 95;
update t1 set c2 = [0.802568,0.206043,0.410133,0.076625,0.876725,0.575326,0.522121,0.956288,0.114782,0.733224] where c1 = 100;
update t1 set c2 = [0.413016,0.903658,0.003321,0.850155,0.852935,0.839345,0.295509,0.283324,0.269650,0.057925] where c1 = 105;
update t1 set c2 = [0.539759,0.963231,0.731806,0.782034,0.931444,0.167576,0.888715,0.283081,0.399046,0.809828] where c1 = 110;
update t1 set c2 = [0.815552,0.752947,0.667784,0.757900,0.083551,0.285281,0.622017,0.690303,0.963396,0.614471] where c1 = 115;
update t1 set c2 = [0.071059,0.189549,0.593963,0.142029,0.756413,0.770515,0.834901,0.729913,0.864798,0.505230] where c1 = 120;
update t1 set c2 = [0.258845,0.720567,0.990355,0.177236,0.801341,0.212035,0.933645,0.025159,0.557735,0.367143] where c1 = 125;
update t1 set c2 = [0.728078,0.993346,0.561922,0.969383,0.005274,0.641236,0.481793,0.230500,0.999860,0.325928] where c1 = 130;
update t1 set c2 = [0.784550,0.595873,0.067996,0.651377,0.643740,0.234965,0.760838,0.518055,0.462903,0.146224] where c1 = 135;
update t1 set c2 = [0.151651,0.684358,0.758806,0.337570,0.639453,0.583572,0.237175,0.684965,0.441216,0.704346] where c1 = 140;
update t1 set c2 = [0.690451,0.280977,0.963684,0.905138,0.251170,0.492117,0.800468,0.950220,0.223912,0.768346] where c1 = 145;
update t1 set c2 = [0.374294,0.923264,0.299984,0.495188,0.137739,0.210729,0.553049,0.150822,0.969402,0.902098] where c1 = 150;
update t1 set c2 = [0.913366,0.507556,0.983466,0.349860,0.907832,0.589555,0.695296,0.405683,0.320200,0.155711] where c1 = 155;
update t1 set c2 = [0.187775,0.170789,0.158452,0.203004,0.670997,0.852639,0.605889,0.914757,0.464475,0.886725] where c1 = 160;
update t1 set c2 = [0.298614,0.155632,0.043210,0.806685,0.435473,0.899189,0.646599,0.933687,0.947000,0.346669] where c1 = 165;
update t1 set c2 = [0.450175,0.975786,0.738551,0.637941,0.360753,0.647227,0.380502,0.190612,0.384563,0.079640] where c1 = 170;
update t1 set c2 = [0.605318,0.777217,0.623031,0.854350,0.369092,0.564906,0.226182,0.843634,0.734363,0.119961] where c1 = 175;
update t1 set c2 = [0.685102,0.079978,0.469254,0.770708,0.269650,0.649325,0.749575,0.190212,0.985346,0.300750] where c1 = 180;
update t1 set c2 = [0.243907,0.526794,0.870299,0.850661,0.788697,0.678301,0.893222,0.348591,0.494789,0.085788] where c1 = 185;
update t1 set c2 = [0.711538,0.545111,0.255720,0.799952,0.787243,0.196926,0.575211,0.961013,0.760966,0.418145] where c1 = 190;
update t1 set c2 = [0.634042,0.677817,0.737941,0.701763,0.901564,0.948167,0.141996,0.413451,0.817543,0.010907] where c1 = 195;
update t1 set c2 = [0.117958,0.363424,0.641858,0.395956,0.806223,0.264610,0.661788,0.575211,0.384532,0.632842] where c1 = 200;
update t1 set c2 = [0.575046,0.637105,0.170694,0.905499,0.325938,0.738177,0.952470,0.428452,0.627730,0.142481] where c1 = 205;
update t1 set c2 = [0.635322,0.032294,0.653711,0.560781,0.141095,0.256103,0.243311,0.653955,0.603850,0.567051] where c1 = 210;
update t1 set c2 = [0.478631,0.874688,0.093160,0.107253,0.106519,0.652861,0.474840,0.032890,0.247669,0.628033] where c1 = 215;
update t1 set c2 = [0.880351,0.958983,0.960933,0.524085,0.137707,0.523569,0.311261,0.020046,0.248387,0.227007] where c1 = 220;
update t1 set c2 = [0.396880,0.990355,0.790326,0.592328,0.870953,0.389193,0.130768,0.319243,0.470244,0.642714] where c1 = 225;
update t1 set c2 = [0.239418,0.055944,0.681682,0.828967,0.022452,0.005313,0.390825,0.343881,0.868379,0.395386] where c1 = 230;
update t1 set c2 = [0.216800,0.690601,0.584162,0.085273,0.798433,0.480147,0.819486,0.537958,0.129989,0.228270] where c1 = 235;
update t1 set c2 = [0.481071,0.807424,0.841802,0.898930,0.909626,0.628361,0.343740,0.275397,0.952971,0.760811] where c1 = 240;
update t1 set c2 = [0.910274,0.106032,0.430175,0.861737,0.497626,0.406662,0.977113,0.642776,0.395022,0.041959] where c1 = 245;
update t1 set c2 = [0.614429,0.382896,0.577287,0.211130,0.399359,0.046674,0.308965,0.160532,0.790515,0.974833] where c1 = 250;
update t1 set c2 = [0.297845,0.887255,0.906878,0.267739,0.920709,0.455278,0.102362,0.170997,0.404413,0.480442] where c1 = 255;
update t1 set c2 = [0.222547,0.741506,0.972475,0.707893,0.891894,0.993219,0.886661,0.557121,0.872647,0.080018] where c1 = 260;
update t1 set c2 = [0.423408,0.613338,0.354293,0.721717,0.068520,0.413642,0.999349,0.482227,0.266432,0.594956] where c1 = 265;
update t1 set c2 = [0.637001,0.334026,0.617751,0.955256,0.173063,0.751819,0.616949,0.300315,0.444724,0.709532] where c1 = 270;
update t1 set c2 = [0.426646,0.155640,0.461840,0.432907,0.894482,0.528267,0.174441,0.810665,0.904347,0.012649] where c1 = 275;
update t1 set c2 = [0.748246,0.546662,0.168286,0.657610,0.362259,0.315137,0.326642,0.505847,0.530967,0.726365] where c1 = 280;
update t1 set c2 = [0.210900,0.699370,0.755029,0.259612,0.528865,0.056505,0.626225,0.410944,0.696618,0.610295] where c1 = 285;
update t1 set c2 = [0.093189,0.633174,0.926597,0.197000,0.868108,0.415391,0.924019,0.097320,0.049600,0.217415] where c1 = 290;
update t1 set c2 = [0.615160,0.622171,0.111322,0.703446,0.698943,0.949050,0.078769,0.615154,0.485583,0.994131] where c1 = 295;
update t1 set c2 = [0.744048,0.258286,0.324311,0.354324,0.144252,0.112455,0.934196,0.848626,0.958721,0.196100] where c1 = 300;
update t1 set c2 = [0.264840,0.669216,0.893838,0.546003,0.958946,0.060512,0.739207,0.040903,0.064712,0.669450] where c1 = 305;
update t1 set c2 = [0.864475,0.554218,0.301429,0.225883,0.572903,0.609764,0.837595,0.675902,0.217015,0.902563] where c1 = 310;
update t1 set c2 = [0.660458,0.316292,0.913096,0.859326,0.556310,0.448432,0.632543,0.331096,0.672764,0.650273] where c1 = 315;
update t1 set c2 = [0.535963,0.474338,0.488623,0.732317,0.619755,0.711726,0.712189,0.351678,0.592609,0.892780] where c1 = 320;
update t1 set c2 = [0.671707,0.020113,0.474857,0.966449,0.658289,0.125738,0.016798,0.727050,0.775437,0.703210] where c1 = 325;
update t1 set c2 = [0.646980,0.003613,0.544705,0.558073,0.424779,0.894808,0.900522,0.009392,0.518591,0.753765] where c1 = 330;
update t1 set c2 = [0.455151,0.583127,0.548228,0.227268,0.203636,0.991498,0.143976,0.332502,0.982832,0.745136] where c1 = 335;
update t1 set c2 = [0.048910,0.080996,0.509697,0.627857,0.828221,0.052984,0.329046,0.364087,0.650255,0.381511] where c1 = 340;
update t1 set c2 = [0.331208,0.676342,0.993241,0.819486,0.696835,0.442199,0.822352,0.624213,0.922076,0.068405] where c1 = 345;
update t1 set c2 = [0.840116,0.426984,0.838820,0.719503,0.404158,0.536519,0.692094,0.018154,0.142741,0.431754] where c1 = 350;
update t1 set c2 = [0.322919,0.152126,0.450268,0.768521,0.974170,0.589309,0.269399,0.201682,0.486933,0.768073] where c1 = 355;
update t1 set c2 = [0.286326,0.607928,0.943785,0.231117,0.547635,0.423504,0.014286,0.994471,0.246932,0.592805] where c1 = 360;
update t1 set c2 = [0.347171,0.367501,0.724799,0.535402,0.777297,0.398306,0.234107,0.652044,0.921359,0.295389] where c1 = 365;
update t1 set c2 = [0.103751,0.158727,0.881714,0.443681,0.503523,0.817398,0.564347,0.609306,0.602883,0.983873] where c1 = 370;
update t1 set c2 = [0.315657,0.837738,0.667275,0.212606,0.024972,0.757822,0.976382,0.010954,0.902929,0.243711] where c1 = 375;
update t1 set c2 = [0.399913,0.185441,0.254569,0.506680,0.056087,0.700327,0.120168,0.205105,0.736327,0.038857] where c1 = 380;
update t1 set c2 = [0.570040,0.463458,0.178308,0.561051,0.877580,0.643789,0.804584,0.871343,0.448100,0.044810] where c1 = 385;
update t1 set c2 = [0.909739,0.306934,0.670383,0.709765,0.225635,0.976190,0.407186,0.864447,0.629816,0.171953] where c1 = 390;
update t1 set c2 = [0.645376,0.246185,0.503022,0.831670,0.075516,0.924093,0.128748,0.005729,0.643526,0.485425] where c1 = 395;
update t1 set c2 = [0.041827,0.631887,0.597431,0.615732,0.006525,0.760753,0.541157,0.641854,0.315848,0.847966] where c1 = 400;
update t1 set c2 = [0.541446,0.141853,0.789756,0.449711,0.426462,0.746571,0.679596,0.231348,0.028389,0.368591] where c1 = 405;
update t1 set c2 = [0.982633,0.974490,0.325195,0.120014,0.067874,0.718791,0.567914,0.484957,0.272286,0.732317] where c1 = 410;
update t1 set c2 = [0.499379,0.502854,0.096582,0.364882,0.628033,0.195097,0.339171,0.243785,0.865223,0.304844] where c1 = 415;
update t1 set c2 = [0.693509,0.391960,0.368155,0.002889,0.200603,0.290699,0.282762,0.416553,0.314943,0.094780] where c1 = 420;
update t1 set c2 = [0.664220,0.120494,0.424055,0.118491,0.691396,0.545758,0.080587,0.445819,0.747374,0.611949] where c1 = 425;
update t1 set c2 = [0.018105,0.491341,0.885149,0.342454,0.220234,0.499288,0.307041,0.866568,0.983050,0.134030] where c1 = 430;
update t1 set c2 = [0.291360,0.753470,0.665480,0.662780,0.357089,0.535866,0.427757,0.270575,0.623613,0.067166] where c1 = 435;
update t1 set c2 = [0.914968,0.376177,0.991105,0.069892,0.111108,0.963677,0.461401,0.317281,0.614436,0.337145] where c1 = 440;
update t1 set c2 = [0.988991,0.984941,0.975738,0.535866,0.735193,0.126350,0.537536,0.422909,0.355264,0.728569] where c1 = 445;
update t1 set c2 = [0.573792,0.421789,0.706944,0.535402,0.282105,0.757821,0.562213,0.228919,0.449168,0.655725] where c1 = 450;
update t1 set c2 = [0.386406,0.476829,0.063200,0.722763,0.115695,0.008229,0.315676,0.865518,0.138836,0.673795] where c1 = 455;
update t1 set c2 = [0.972739,0.677332,0.954008,0.497272,0.041043,0.664408,0.628662,0.405084,0.526050,0.499438] where c1 = 460;
update t1 set c2 = [0.618384,0.515410,0.442992,0.714916,0.620451,0.215353,0.823168,0.747404,0.073500,0.957104] where c1 = 465;
update t1 set c2 = [0.028620,0.851165,0.332584,0.501626,0.013280,0.750325,0.371971,0.925402,0.060162,0.250832] where c1 = 470;
update t1 set c2 = [0.221197,0.016295,0.377189,0.296774,0.422919,0.203006,0.285345,0.680872,0.619474,0.918902] where c1 = 475;
update t1 set c2 = [0.052048,0.215404,0.938052,0.165368,0.052418,0.846317,0.681250,0.739162,0.750072,0.074547] where c1 = 480;
update t1 set c2 = [0.111110,0.657797,0.748118,0.633072,0.158299,0.392152,0.686527,0.429467,0.420769,0.566336] where c1 = 485;
update t1 set c2 = [0.873263,0.360829,0.931039,0.746715,0.102185,0.401035,0.964346,0.814729,0.719871,0.279823] where c1 = 490;
update t1 set c2 = [0.345585,0.217425,0.076036,0.890501,0.271476,0.892447,0.732711,0.340623,0.094066,0.641496] where c1 = 495;
update t1 set c2 = [0.722487,0.057171,0.843645,0.918717,0.472954,0.393969,0.110229,0.366096,0.279823,0.179767] where c1 = 500;

select * from t1 order by l2_distance(c2, [0,0,0,0,0,0,0,0,0,0]) limit 10;
select * from t1 order by l2_distance(c2, [0,0,0,0,0,0,0,0,0,0]) approx limit 10;
select /*+ opt_param('rowsets_enabled', 'false') */ * from t1 order by l2_distance(c2, [0,0,0,0,0,0,0,0,0,0]) approx limit 10;

drop table t1;

# bugfix: 2024080700104057458
--disable_warnings
drop table if exists t1;
--enable_warnings

CREATE TABLE t1 (c1 int primary key, c2 VARCHAR(30),c3 vector(3) ,c4 vector(3),
VECTOR INDEX vector_idx_c3(c3)
WITH (distance=l2, lib=vsag, type=hnsw, m=10, ef_construction=12, ef_search=40))
PARTITION BY RANGE(c1) (
PARTITION p0 VALUES less than(5),
PARTITION p1 VALUES less than(6),
PARTITION p2 VALUES less than(9),
PARTITION p5 VALUES less than (MAXVALUE));
insert into t1(c1,c2,c3,c4) values(1,'[1,1,2]','[2,2,3]','[1,3,2]');
insert into t1(c1,c2,c3,c4) values(3,'[1,0,3]','[1,0,3]','[2,3,2]');
insert into t1(c1,c2,c3,c4) values(4,'[-1,2,2]','[-3,2,3]','[4,3,3]');
insert into t1(c1,c2,c3,c4) values(7,'[-1,-2,-2]','[-4,2,3]',null);
insert into t1(c1,c2,c3,c4) values(8,'[-1,-3,-2]',null,'[2,3,1]');
CREATE VECTOR INDEX vector_idx_c4  ON t1 (c4)  WITH (distance=l2, lib=vsag, type=hnsw, m=10, ef_construction=12, ef_search=40);

#bugfix : 2024081600104159453
--disable_warnings
drop table if exists t1;
--enable_warnings
CREATE TABLE t1 (c1 int primary key, c2 vector(3),c3 vector(3) ,c4 vector(3));
insert into t1 values(1,'[1,1,2]','[2,2,3]','[1,3,2]');
insert /*+ direct(true,100) enable_parallel_dml parallel(2) */ into t1 select c1+1, c2, c3, c4 from t1;
create VECTOR index vector_idx1 on t1(c3) with (distance=l2, lib=vsag, type=hnsw, m=10, ef_construction=100, ef_search=40);
drop table t1;

#bugfix : replace in minial mode
create table t1(c1 int, c2 vector(3), c3 vector(5),
                primary key(c1),
                vector index idx1(c2) with (distance=l2, type=hnsw, lib=vsag))
PARTITION BY RANGE COLUMNS(c1)
(
  PARTITION p0 VALUES LESS THAN(100),
  PARTITION p1 VALUES LESS THAN(200),
  PARTITION p2 VALUES LESS THAN(300),
  PARTITION p3 VALUES LESS THAN(10000),
  PARTITION p4 VALUES LESS THAN MAXVALUE
);
set @@binlog_row_image = 'MINIMAL';
insert into t1 values(1, '[0.149599,0.570740,0.487505]', '[0.275799,0.239371,0.875098,0.947923,0.617502]');
insert into t1 values(2, '[0.055335,0.390351,0.393264]', '[0.213549,0.543877,0.337553,0.505269,0.968880]');
replace into t1 values(1, '[0.1,0.570740,0.487505]', '[0.1,0.239371,0.875098,0.947923,0.617502]');
replace into t1 values(2, '[0.2,0.390351,0.393264]', '[0.2,0.543877,0.337553,0.505269,0.968880]');
call dbms_vector.refresh_index('idx1', 't1', 'c2', 1, 'FAST');
call dbms_vector.rebuild_index('idx1','t1','c2');
set @@binlog_row_image = 'FULL';
drop table t1;

#bugfix : 2025033100107918639
--disable_warnings
drop table if exists t_vec;
--enable_warnings
create table t_vec(c1 int, c2 vector(3), c3 varchar(20), j json, c4 sparsevector,primary key(c1));
insert into t_vec values(1, '[1,2,1]', 'a', '{"key":[7,932,22]}', '{1:0.1,2:0.2, 3:0.3}');
--error 1235
create vector index idx1 on t_vec(c2) with (distance=l2, type=hnsw) with column group(each column);
--error 1235
create vector index idx1 on t_vec(c2) with (distance=l2, type=hnsw) with column group(all columns);
--error 1235
create vector index idx1 on t_vec(c2) with (distance=l2, type=ivf_flat) with column group(each column);
--error 1235
create vector index idx1 on t_vec(c2) with (distance=l2, type=ivf_pq, m=1) with column group(each column);
--error 1235
create vector index idx1 on t_vec(c2) with (distance=l2, type=ivf_sq8) with column group(each column);
--error 1235
create fulltext index idx1 on t_vec(c3) with column group(each column);
--error 1235
create fulltext index idx1 on t_vec(c3) with column group(all columns);
--error 1235
create vector index idx1 on t_vec(c4) with (distance=inner_product) with column group(each column);
--error 1235
create vector index idx1 on t_vec(c4) with (distance=inner_product) with column group(all columns);
--error 1235
create index idx1 on t_vec((CAST(j->'$.key' AS UNSIGNED ARRAY))) with column group(each column);
--error 1235
create index idx1 on t_vec((CAST(j->'$.key' AS UNSIGNED ARRAY))) with column group(all columns);
drop table t_vec;
--error 1235
CREATE TABLE t_vec (
    id BIGINT not null,
    modified  BIGINT not null,
    custinfo JSON,
    data JSON,
    primary key(id),
    INDEX zips1( (CAST(custinfo->'$.zipcode' AS UNSIGNED ARRAY)) ) with column group(each column),
    INDEX zips2( (CAST(data->'$.id' AS UNSIGNED ARRAY)) )
);
--error 1235
CREATE TABLE t_vec (
    id BIGINT not null,
    modified  BIGINT not null,
    custinfo JSON,
    data JSON,
    primary key(id),
    INDEX zips1( (CAST(custinfo->'$.zipcode' AS UNSIGNED ARRAY)) ) with column group(all columns),
    INDEX zips2( (CAST(data->'$.id' AS UNSIGNED ARRAY)) )
);
--error 1064
CREATE TABLE t_vec (
  c1 int primary key,
  c2 sparsevector,
  vector index idx1(c2) with (distance=inner_product) with column group(all columns)
);
--error 1235
create table t_vec(c1 int, c2 vector(3), c3 varchar(20), j json, primary key(c1), vector index idx(c2) with (distance=l2, type=ivf_flat)) with column group(each column);
--error 1235
create table t_vec(c1 int, c2 vector(3), c3 varchar(20), j json, primary key(c1), vector index idx(c2) with (distance=l2, type=ivf_pq, m=3)) with column group(each column);
--error 1235
create table t_vec(c1 int, c2 vector(3), c3 varchar(20), j json, primary key(c1), vector index idx(c2) with (distance=l2, type=ivf_sq8)) with column group(each column);
--error 1235
create table t_vec(c1 int, c2 vector(3), c3 varchar(20), j json, primary key(c1), vector index idx(c2) with (distance=l2, type=ivf_flat)) with column group(all columns, each column);
--error 1235
create table t_vec(c1 int, c2 vector(3), c3 varchar(20), j json, primary key(c1), vector index idx(c2) with (distance=l2, type=ivf_pq, m=3)) with column group(all columns, each column);
--error 1235
create table t_vec(c1 int, c2 vector(3), c3 varchar(20), j json, primary key(c1), vector index idx(c2) with (distance=l2, type=ivf_sq8)) with column group(all columns, each column);
create table t_vec(c1 int, c2 vector(3), c3 varchar(20), j json, primary key(c1)) with column group(each column);
--error 1235
create vector index idx1 on t_vec(c2) with (distance=l2, type=ivf_flat);
--error 1235
create vector index idx1 on t_vec(c2) with (distance=l2, type=ivf_pq, m=1);
--error 1235
create vector index idx1 on t_vec(c2) with (distance=l2, type=ivf_sq8);
drop table t_vec;
create table t_vec(c1 int, c2 vector(3), c3 varchar(20), j json, primary key(c1));
create vector index idx1 on t_vec(c2) with (distance=l2, type=ivf_flat);
--error 1235
alter table t_vec add column group(each column);
--error 1235
alter table t_vec add column group(each column) delayed;
drop table t_vec;

# check virtual table later
PURGE RECYCLEBIN;
--disable_warnings
drop table if exists t1;
--enable_warnings
drop database if exists post_create_vec;
alter system set ob_vector_memory_limit_percentage = 0;
--enable_query_log
PURGE RECYCLEBIN;
disconnect conn_user;

connect(sys_conn, $OBMYSQL_MS0, root@sys,,oceanbase, $OBMYSQL_PORT);
connection sys_conn;
alter system set _enable_add_fulltext_index_to_existing_table = false;
disconnect sys_conn;
