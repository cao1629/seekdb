#owner: xiongliyao.xly
#owner group: opensource
#description: test __all_virtual_vector_index_info

connect (mysql_conn,$OBMYSQL_MS0,root,,test,$OBMYSQL_PORT);

connection mysql_conn;
--disable_warnings
drop table if exists t1;
drop table if exists t2;
#PURGE RECYCLEBIN;
--enable_warnings

alter system set ob_vector_memory_limit_percentage = 10;
sleep 5;
create table t1(c1 int, c2 vector(10), primary key(c1));
create table t2 (c1 int, c2 vector(3), primary key(c1), vector index idx1(c2) with (distance=l2, type=hnsw, lib=vsag)) partition by hash(c1) partitions 2;
create vector index idx1 on t1(c2) with (distance=l2, type=hnsw);

insert into t1 values(1, '[0.203846,0.205289,0.880265,0.824340,0.615737,0.496899,0.983632,0.865571,0.248373,0.542833]');
insert into t2 values(1, [1,1,1]);
insert into t2 values(2, [2,2,2]);
--sleep 20
select count(distinct inc_index_tablet_id) as count
from oceanbase.__all_virtual_vector_index_info a, oceanbase.__all_virtual_table b
where a.data_table_id = b.table_id and b.table_name in ('t1', 't2');
drop table t1;
drop index idx1 on t2;

--sleep 20
select count(*) as count
from oceanbase.__all_virtual_vector_index_info a, oceanbase.__all_virtual_table b
where a.data_table_id = b.table_id and b.table_name in ('t1', 't2');
drop table t2;

# cache test
--sleep 10
PURGE RECYCLEBIN;
create table t3 (c1 int, c2 vector(3), primary key(c1));
insert into t3 values(1, [1,1,1]);
insert into t3 values(2, [2,2,2]);
create vector index idx3 on t3(c2) with (distance=l2, type=ivf_flat);

create table t4 (c1 int, c2 vector(3), primary key(c1));
insert into t4 values(1, [1,1,1]);
insert into t4 values(2, [2,2,2]);
create vector index idx4 on t4(c2) with (distance=l2, type=ivf_pq, m=1);

# load cache
select * from t3 order by l2_distance(c2, [2, 2, 2]) approximate limit 2;

select count(*) as count
from oceanbase.__all_virtual_vector_index_info v
join oceanbase.__all_table i on v.rowkey_vid_tablet_id = i.tablet_id
join oceanbase.__all_table t on t.table_id = i.data_table_id
where t.table_name = 't3';

select * from t4 order by l2_distance(c2, [2, 2, 2]) approximate limit 2;

select count(*) as count
from oceanbase.__all_virtual_vector_index_info v
join oceanbase.__all_table i on v.rowkey_vid_tablet_id = i.tablet_id
join oceanbase.__all_table t on t.table_id = i.data_table_id
where t.table_name = 't4';

drop table t3, t4;
PURGE RECYCLEBIN;

select count(*) as count
from oceanbase.__all_virtual_vector_index_info v
join oceanbase.__all_table i on v.rowkey_vid_tablet_id = i.tablet_id
join oceanbase.__all_table t on t.table_id = i.data_table_id
where t.table_name = 't3';

select count(*) as count
from oceanbase.__all_virtual_vector_index_info v
join oceanbase.__all_table i on v.rowkey_vid_tablet_id = i.tablet_id
join oceanbase.__all_table t on t.table_id = i.data_table_id
where t.table_name = 't4';

alter system set ob_vector_memory_limit_percentage = 0;
