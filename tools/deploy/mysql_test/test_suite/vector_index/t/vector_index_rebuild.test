#owner: gehao.wh
#owner group: shenzhen
--echo # Vector Index Rebuild Test

--disable_warnings
drop table if exists t1;
--enable_warnings

set ob_enable_index_direct_select = 1;
alter system set ob_vector_memory_limit_percentage = 20;
sleep 3;
#########################################################################
# rebuild with no data
#########################################################################

create table t1(c1 int, c2 vector(3), c3 vector(3), primary key(c1), vector index idx1(c2) with (distance=L2, type=hnsw, lib=vsag, m=20, ef_construction=200, ef_search=200));

let $table_id = `select table_id from oceanbase.__all_table where table_name = 't1' order by gmt_create desc limit 1;`;
let $index_snapshot_data_table_idx1 = `select CONCAT('__idx_', $table_id , '_idx1_index_snapshot_data_table') from dual;`;

call dbms_vector.rebuild_index('idx1','t1','c2');

create vector index idx2 on t1(c3) WITH (distance=L2, lib=vsag, type=hnsw, m=10, ef_construction = 12, ef_search = 40);

call dbms_vector.rebuild_index('idx1','t1','c2');

call dbms_vector.rebuild_index('idx2','t1','c3');

--disable_query_log
eval select count(*) from $index_snapshot_data_table_idx1;
--enable_query_log

drop table t1;

#########################################################################
# rebuild with data
#########################################################################

--disable_warnings
drop table if exists t1;
--enable_warnings

create table t1(c1 int, c2 vector(3), primary key(c1), vector index idx1(c2) with (distance=L2, type=hnsw, lib=vsag, m=20, ef_construction=200, ef_search=200));

insert into t1 values(1, '[0.203846,0.205289,0.880265]');
insert into t1 values(2, '[0.484526,0.669954,0.986755]');
insert into t1 values(3, '[0.327936,0.048756,0.084670]');
insert into t1 values(4, '[0.148869,0.878546,0.028024]');
insert into t1 values(5, '[0.334970,0.857377,0.886132]');
insert into t1 values(6, '[0.117582,0.302352,0.471198]');
insert into t1 values(7, '[0.551185,0.231134,0.075354]');
insert into t1 values(8, '[0.185221,0.315131,0.558301]');
insert into t1 values(9, '[0.928764,0.254038,0.272721]');
insert into t1 values(10, '[0.345999,0.254102,0.950869]');
insert into t1 values(11, '[0.102417,0.769097,0.655852]');
insert into t1 values(12, '[0.260019,0.176781,0.252475]');
insert into t1 values(13, '[0.727582,0.167779,0.383390]');
insert into t1 values(14, '[0.440073,0.998299,0.178305]');
insert into t1 values(15, '[0.593148,0.156687,0.351126]');
insert into t1 values(16, '[0.995789,0.761186,0.830773]');
insert into t1 values(17, '[0.538628,0.082426,0.083695]');
insert into t1 values(18, '[0.515894,0.188949,0.420311]');
insert into t1 values(19, '[0.329709,0.892973,0.850152]');
insert into t1 values(30, '[0.055008,0.893954,0.445311]');
insert into t1 values(31, '[0.271288,0.969836,0.899836]');
insert into t1 values(32, '[0.050261,0.845356,0.877143]');
insert into t1 values(33, '[0.802323,0.671325,0.694353]');
insert into t1 values(34, '[0.003465,0.902425,0.745576]');
insert into t1 values(35, '[0.488643,0.217055,0.257016]');
insert into t1 values(36, '[0.646577,0.103579,0.802476]');
insert into t1 values(37, '[0.318426,0.707079,0.196895]');
insert into t1 values(38, '[0.983855,0.265534,0.566591]');
insert into t1 values(39, '[0.957104,0.729224,0.092537]');
insert into t1 values(50, '[0.495983,0.556285,0.986712]');
insert into t1 values(51, '[0.956373,0.549782,0.493153]');
insert into t1 values(52, '[0.470215,0.788596,0.534499]');
insert into t1 values(53, '[0.660493,0.373283,0.755029]');
insert into t1 values(54, '[0.100299,0.676867,0.970798]');
insert into t1 values(55, '[0.802192,0.079942,0.627571]');
insert into t1 values(56, '[0.109255,0.865682,0.368419]');
insert into t1 values(57, '[0.589309,0.026667,0.665149]');
insert into t1 values(58, '[0.769838,0.006709,0.233108]');
insert into t1 values(59, '[0.731215,0.949661,0.397933]');
insert into t1 values(70, '[0.735541,0.670776,0.903237]');
insert into t1 values(71, '[0.880265,0.824340,0.615737]');
insert into t1 values(72, '[0.903237,0.447223,0.232028]');
insert into t1 values(73, '[0.084670,0.389642,0.970982]');
insert into t1 values(74, '[0.028024,0.326642,0.044912]');
insert into t1 values(75, '[0.886132,0.668270,0.983913]');
insert into t1 values(76, '[0.471198,0.248725,0.315868]');
insert into t1 values(77, '[0.075354,0.230557,0.248149]');
insert into t1 values(78, '[0.558301,0.543172,0.335010]');
insert into t1 values(79, '[0.272721,0.648755,0.966464]');
insert into t1 values(90, '[0.950869,0.275233,0.844568]');

let $table_id = `select table_id from oceanbase.__all_table where table_name = 't1' order by gmt_create desc limit 1;`;
let $index_table_idx1 = `select CONCAT('__idx_', $table_id , '_idx1') from dual;`;
let $index_id_table_idx1 = `select CONCAT('__idx_', $table_id , '_idx1_index_id_table') from dual;`;
let $index_snapshot_data_table_idx1 = `select CONCAT('__idx_', $table_id , '_idx1_index_snapshot_data_table') from dual;`;

select * from t1 order by l2_distance(c2, [0.428146,0.408760,0.765300]) APPROXIMATE limit 8;
select * from t1 order by l2_distance(c2, [0.428146,0.408760,0.765300]) limit 8;
select count(*) from (select * from t1 order by l2_distance(c2, [0.428146,0.408760,0.765300]) APPROXIMATE limit 8) as tmp1, (select * from t1 order by l2_distance(c2, [0.428146,0.408760,0.765300]) limit 8) as tmp2 where tmp1.c1=tmp2.c1;

call dbms_vector.rebuild_index('idx1','t1','c2');
--disable_query_log
eval select count(*) from $index_table_idx1;
eval select count(*) from $index_id_table_idx1;
eval select count(*)>0 from $index_snapshot_data_table_idx1;
--enable_query_log

select * from t1 order by l2_distance(c2, [0.428146,0.408760,0.765300]) APPROXIMATE limit 8;
select * from t1 order by l2_distance(c2, [0.428146,0.408760,0.765300]) limit 8;
select count(*) from (select * from t1 order by l2_distance(c2, [0.428146,0.408760,0.765300]) APPROXIMATE limit 8) as tmp1, (select * from t1 order by l2_distance(c2, [0.428146,0.408760,0.765300]) limit 8) as tmp2 where tmp1.c1=tmp2.c1;

call dbms_vector.rebuild_index('idx1','t1','c2');
call dbms_vector.rebuild_index('idx1','t1','c2');
call dbms_vector.rebuild_index('idx1','t1','c2');
call dbms_vector.rebuild_index('idx1','t1','c2');

select * from t1 order by l2_distance(c2, [0.428146,0.408760,0.765300]) APPROXIMATE limit 8;
select * from t1 order by l2_distance(c2, [0.428146,0.408760,0.765300]) limit 8;
select count(*) from (select * from t1 order by l2_distance(c2, [0.428146,0.408760,0.765300]) APPROXIMATE limit 8) as tmp1, (select * from t1 order by l2_distance(c2, [0.428146,0.408760,0.765300]) limit 8) as tmp2 where tmp1.c1=tmp2.c1;

drop table t1;

#########################################################################
# rebuild with data, post create vector index
#########################################################################

--disable_warnings
drop table if exists t1;
--enable_warnings

create table t1(c1 int, c2 vector(3), primary key(c1));

insert into t1 values(1, '[0.203846,0.205289,0.880265]');
insert into t1 values(2, '[0.484526,0.669954,0.986755]');
insert into t1 values(3, '[0.327936,0.048756,0.084670]');
insert into t1 values(4, '[0.148869,0.878546,0.028024]');
insert into t1 values(5, '[0.334970,0.857377,0.886132]');
insert into t1 values(6, '[0.117582,0.302352,0.471198]');
insert into t1 values(7, '[0.551185,0.231134,0.075354]');
insert into t1 values(8, '[0.185221,0.315131,0.558301]');
insert into t1 values(9, '[0.928764,0.254038,0.272721]');
insert into t1 values(10, '[0.345999,0.254102,0.950869]');
insert into t1 values(11, '[0.102417,0.769097,0.655852]');
insert into t1 values(12, '[0.260019,0.176781,0.252475]');
insert into t1 values(13, '[0.727582,0.167779,0.383390]');
insert into t1 values(14, '[0.440073,0.998299,0.178305]');
insert into t1 values(15, '[0.593148,0.156687,0.351126]');
insert into t1 values(16, '[0.995789,0.761186,0.830773]');
insert into t1 values(17, '[0.538628,0.082426,0.083695]');
insert into t1 values(18, '[0.515894,0.188949,0.420311]');
insert into t1 values(19, '[0.329709,0.892973,0.850152]');
insert into t1 values(30, '[0.055008,0.893954,0.445311]');
insert into t1 values(31, '[0.271288,0.969836,0.899836]');
insert into t1 values(32, '[0.050261,0.845356,0.877143]');
insert into t1 values(33, '[0.802323,0.671325,0.694353]');
insert into t1 values(34, '[0.003465,0.902425,0.745576]');
insert into t1 values(35, '[0.488643,0.217055,0.257016]');
insert into t1 values(36, '[0.646577,0.103579,0.802476]');
insert into t1 values(37, '[0.318426,0.707079,0.196895]');
insert into t1 values(38, '[0.983855,0.265534,0.566591]');
insert into t1 values(39, '[0.957104,0.729224,0.092537]');
insert into t1 values(50, '[0.495983,0.556285,0.986712]');
insert into t1 values(51, '[0.956373,0.549782,0.493153]');
insert into t1 values(52, '[0.470215,0.788596,0.534499]');
insert into t1 values(53, '[0.660493,0.373283,0.755029]');
insert into t1 values(54, '[0.100299,0.676867,0.970798]');
insert into t1 values(55, '[0.802192,0.079942,0.627571]');
insert into t1 values(56, '[0.109255,0.865682,0.368419]');
insert into t1 values(57, '[0.589309,0.026667,0.665149]');
insert into t1 values(58, '[0.769838,0.006709,0.233108]');
insert into t1 values(59, '[0.731215,0.949661,0.397933]');
insert into t1 values(70, '[0.735541,0.670776,0.903237]');
insert into t1 values(71, '[0.880265,0.824340,0.615737]');
insert into t1 values(72, '[0.903237,0.447223,0.232028]');
insert into t1 values(73, '[0.084670,0.389642,0.970982]');
insert into t1 values(74, '[0.028024,0.326642,0.044912]');
insert into t1 values(75, '[0.886132,0.668270,0.983913]');
insert into t1 values(76, '[0.471198,0.248725,0.315868]');
insert into t1 values(77, '[0.075354,0.230557,0.248149]');
insert into t1 values(78, '[0.558301,0.543172,0.335010]');
insert into t1 values(79, '[0.272721,0.648755,0.966464]');
insert into t1 values(90, '[0.950869,0.275233,0.844568]');

create vector index idx1 on t1(c2) with (distance=L2, type=hnsw, lib=vsag, m=20, ef_construction=200, ef_search=200);

call dbms_vector.rebuild_index('idx1','t1','c2');

select * from t1 order by l2_distance(c2, [0.428146,0.408760,0.765300]) APPROXIMATE limit 8;
select * from t1 order by l2_distance(c2, [0.428146,0.408760,0.765300]) limit 8;
select count(*) from (select * from t1 order by l2_distance(c2, [0.428146,0.408760,0.765300]) APPROXIMATE limit 8) as tmp1, (select * from t1 order by l2_distance(c2, [0.428146,0.408760,0.765300]) limit 8) as tmp2 where tmp1.c1=tmp2.c1;

let $table_id = `select table_id from oceanbase.__all_table where table_name = 't1' order by gmt_create desc limit 1;`;
let $index_table_idx1 = `select CONCAT('__idx_', $table_id , '_idx1') from dual;`;
let $index_id_table_idx1 = `select CONCAT('__idx_', $table_id , '_idx1_index_id_table') from dual;`;
let $index_snapshot_data_table_idx1 = `select CONCAT('__idx_', $table_id , '_idx1_index_snapshot_data_table') from dual;`;
call dbms_vector.rebuild_index('idx1','t1','c2');
--disable_query_log
eval select count(*) from $index_table_idx1;
eval select count(*) from $index_id_table_idx1;
eval select count(*)>0 from $index_snapshot_data_table_idx1;
--enable_query_log

call dbms_vector.rebuild_index('idx1','t1','c2');

select * from t1 order by l2_distance(c2, [0.428146,0.408760,0.765300]) APPROXIMATE limit 8;
select * from t1 order by l2_distance(c2, [0.428146,0.408760,0.765300]) limit 8;
select count(*) from (select * from t1 order by l2_distance(c2, [0.428146,0.408760,0.765300]) APPROXIMATE limit 8) as tmp1, (select * from t1 order by l2_distance(c2, [0.428146,0.408760,0.765300]) limit 8) as tmp2 where tmp1.c1=tmp2.c1;

drop table t1;

#########################################################################
# rebuild with data, fast refresh
#########################################################################

--disable_warnings
drop table if exists t1;
--enable_warnings

create table t1(c1 int, c2 vector(3), primary key(c1));

create vector index idx1 on t1(c2) with (distance=L2, type=hnsw, lib=vsag, m=20, ef_construction=200, ef_search=200);

insert into t1 values(1, '[0.203846,0.205289,0.880265]');
insert into t1 values(2, '[0.484526,0.669954,0.986755]');
insert into t1 values(3, '[0.327936,0.048756,0.084670]');
insert into t1 values(4, '[0.148869,0.878546,0.028024]');
insert into t1 values(5, '[0.334970,0.857377,0.886132]');
insert into t1 values(6, '[0.117582,0.302352,0.471198]');
insert into t1 values(7, '[0.551185,0.231134,0.075354]');
insert into t1 values(8, '[0.185221,0.315131,0.558301]');
insert into t1 values(9, '[0.928764,0.254038,0.272721]');
insert into t1 values(10, '[0.345999,0.254102,0.950869]');
insert into t1 values(11, '[0.102417,0.769097,0.655852]');
insert into t1 values(12, '[0.260019,0.176781,0.252475]');
insert into t1 values(13, '[0.727582,0.167779,0.383390]');
insert into t1 values(14, '[0.440073,0.998299,0.178305]');
insert into t1 values(15, '[0.593148,0.156687,0.351126]');
insert into t1 values(16, '[0.995789,0.761186,0.830773]');
insert into t1 values(17, '[0.538628,0.082426,0.083695]');
insert into t1 values(18, '[0.515894,0.188949,0.420311]');
insert into t1 values(19, '[0.329709,0.892973,0.850152]');
insert into t1 values(30, '[0.055008,0.893954,0.445311]');
insert into t1 values(31, '[0.271288,0.969836,0.899836]');
insert into t1 values(32, '[0.050261,0.845356,0.877143]');
insert into t1 values(33, '[0.802323,0.671325,0.694353]');
insert into t1 values(34, '[0.003465,0.902425,0.745576]');
insert into t1 values(35, '[0.488643,0.217055,0.257016]');
insert into t1 values(36, '[0.646577,0.103579,0.802476]');
insert into t1 values(37, '[0.318426,0.707079,0.196895]');
insert into t1 values(38, '[0.983855,0.265534,0.566591]');
insert into t1 values(39, '[0.957104,0.729224,0.092537]');
insert into t1 values(50, '[0.495983,0.556285,0.986712]');
insert into t1 values(51, '[0.956373,0.549782,0.493153]');
insert into t1 values(52, '[0.470215,0.788596,0.534499]');
insert into t1 values(53, '[0.660493,0.373283,0.755029]');
insert into t1 values(54, '[0.100299,0.676867,0.970798]');
insert into t1 values(55, '[0.802192,0.079942,0.627571]');
insert into t1 values(56, '[0.109255,0.865682,0.368419]');
insert into t1 values(57, '[0.589309,0.026667,0.665149]');
insert into t1 values(58, '[0.769838,0.006709,0.233108]');
insert into t1 values(59, '[0.731215,0.949661,0.397933]');
insert into t1 values(70, '[0.735541,0.670776,0.903237]');
insert into t1 values(71, '[0.880265,0.824340,0.615737]');
insert into t1 values(72, '[0.903237,0.447223,0.232028]');
insert into t1 values(73, '[0.084670,0.389642,0.970982]');
insert into t1 values(74, '[0.028024,0.326642,0.044912]');
insert into t1 values(75, '[0.886132,0.668270,0.983913]');
insert into t1 values(76, '[0.471198,0.248725,0.315868]');
insert into t1 values(77, '[0.075354,0.230557,0.248149]');
insert into t1 values(78, '[0.558301,0.543172,0.335010]');
insert into t1 values(79, '[0.272721,0.648755,0.966464]');
insert into t1 values(90, '[0.950869,0.275233,0.844568]');

let $table_id = `select table_id from oceanbase.__all_table where table_name = 't1' order by gmt_create desc limit 1;`;
let $index_table_idx1 = `select CONCAT('__idx_', $table_id , '_idx1') from dual;`;
let $index_id_table_idx1 = `select CONCAT('__idx_', $table_id , '_idx1_index_id_table') from dual;`;
let $index_snapshot_data_table_idx1 = `select CONCAT('__idx_', $table_id , '_idx1_index_snapshot_data_table') from dual;`;
call dbms_vector.refresh_index('idx1', 't1', 'c2', 50, 'FAST');
--disable_query_log
eval select count(*) from $index_table_idx1;
eval select count(*) from $index_id_table_idx1;
eval select count(*)=0 from $index_snapshot_data_table_idx1;
--enable_query_log

select * from t1 order by l2_distance(c2, [0.428146,0.408760,0.765300]) APPROXIMATE limit 8;
select * from t1 order by l2_distance(c2, [0.428146,0.408760,0.765300]) limit 8;
select count(*) from (select * from t1 order by l2_distance(c2, [0.428146,0.408760,0.765300]) APPROXIMATE limit 8) as tmp1, (select * from t1 order by l2_distance(c2, [0.428146,0.408760,0.765300]) limit 8) as tmp2 where tmp1.c1=tmp2.c1;

update t1 set c2 = [0.428146,0.408760,0.765300] where c1 = 5;
update t1 set c2 = [0.422295,0.386228,0.339575] where c1 = 10;
update t1 set c2 = [0.551996,0.833464,0.976193] where c1 = 15;
update t1 set c2 = [0.671992,0.149204,0.135660] where c1 = 20;
update t1 set c2 = [0.106091,0.676200,0.061431] where c1 = 25;
update t1 set c2 = [0.902042,0.267381,0.836580] where c1 = 30;
update t1 set c2 = [0.956250,0.207436,0.429831] where c1 = 35;
update t1 set c2 = [0.468672,0.893935,0.574821] where c1 = 40;
update t1 set c2 = [0.299619,0.441541,0.613601] where c1 = 45;
update t1 set c2 = [0.071388,0.819782,0.356017] where c1 = 50;

select * from t1 order by l2_distance(c2, [0.428146,0.408760,0.765300]) APPROXIMATE limit 8;
select * from t1 order by l2_distance(c2, [0.428146,0.408760,0.765300]) limit 8;
select count(*) from (select * from t1 order by l2_distance(c2, [0.428146,0.408760,0.765300]) APPROXIMATE limit 8) as tmp1, (select * from t1 order by l2_distance(c2, [0.428146,0.408760,0.765300]) limit 8) as tmp2 where tmp1.c1=tmp2.c1;

call dbms_vector.rebuild_index('idx1','t1','c2');
--disable_query_log
eval select count(*) from $index_table_idx1;
eval select count(*) from $index_id_table_idx1;
eval select count(*)>0 from $index_snapshot_data_table_idx1;
--enable_query_log

select * from t1 order by l2_distance(c2, [0.428146,0.408760,0.765300]) APPROXIMATE limit 8;
select * from t1 order by l2_distance(c2, [0.428146,0.408760,0.765300]) limit 8;
select count(*) from (select * from t1 order by l2_distance(c2, [0.428146,0.408760,0.765300]) APPROXIMATE limit 8) as tmp1, (select * from t1 order by l2_distance(c2, [0.428146,0.408760,0.765300]) limit 8) as tmp2 where tmp1.c1=tmp2.c1;

drop table t1;
alter system set ob_vector_memory_limit_percentage = 0;

# check virtual table later
PURGE RECYCLEBIN;