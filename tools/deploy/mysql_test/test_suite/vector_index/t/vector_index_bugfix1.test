#owner: gehao.wh
#owner group: shenzhen
--echo # Vector Index Basic Test

alter system set ob_vector_memory_limit_percentage = 44;
sleep 3;

# bugfix: 2024080600104051161
--disable_warnings
drop table if exists t1;
--enable_warnings
CREATE TABLE t1 (c1 int primary key, c2 vector(3),c3 vector(3) ,c4 vector(3),
VECTOR INDEX vector_idx(c3)
WITH (distance=l2, lib=vsag, type=hnsw, m=10, ef_construction=12, ef_search=40));
create view v1 as select * from t1;
replace into v1 values(1,'[1,1,2]','[2,2,3]','[1,3,2]');
replace into v1 values(1,'[1,1,2]','[2,2,3]','[1,3,2]');
select * from v1;
select * from t1;
drop view v1;
drop table t1;

--disable_warnings
drop table if exists t1;
drop view if exists v1;
--enable_warnings
CREATE TABLE t1 (c1 int primary key, c2 VARCHAR(30),c3 vector(3) ,c4 vector(3),
VECTOR INDEX vector_idx(c3)
WITH (distance=l2, lib=vsag, type=hnsw, m=10, ef_construction=12, ef_search=40)) partition by list columns (c1)(
  PARTITION p0 VALUES in(10),
  PARTITION p1 VALUES in(50)
);
create view v1 as select * from t1;
--error 1526
replace into v1 values(1,'[1,1,2]','[2,2,3]','[1,3,2]');
replace into v1 values(10,'[1,1,2]','[2,2,3]','[1,3,2]');
replace into v1 values(10,'[1,1,2]','[2,2,3]','[1,3,2]');
select * from v1;
select * from t1;
drop view v1;
drop table t1;

# bugfix: 2024081300104107080
--disable_warnings
drop table if exists t1;
--enable_warnings
CREATE TABLE t1 (c1 int primary key, c2 vector(3),c3 vector(3) ,c4 vector(3),
VECTOR INDEX vector_idx(c3)
WITH (distance=l2, lib=vsag, type=hnsw, m=10, ef_construction=100, ef_search=40));
insert into t1(c1,c2,c3,c4) values(1,'[1,1,2]','[2,2,3]','[1,3,2]');
insert into t1(c1,c2,c3,c4) values(2,'[1,0,3]','[1,0,3]','[2,3,2]');
insert into t1(c1,c2,c3,c4) values(3,'[-1,2,2]','[-3,2,3]','[4,3,3]');
insert into t1(c1,c2,c3,c4) values(4,'[-1,-2,-2]','[-4,2,3]',null);
insert into t1(c1,c2,c3,c4) values(5,'[-1,-3,-2]',null,'[2,3,1]');
select * from t1 order by l2_distance(c3, [1,2,3]);
select * from t1 order by l2_distance(c3, [1,2,3])  limit 1,1;
select * from t1 order by l2_distance(c3, [1,2,3]) approximate limit 1,1;

select * from t1 order by l2_distance(c3, [1,2,3])  limit 1,3;
select * from t1 order by l2_distance(c3, [1,2,3]) approximate limit 1,3;
select * from t1 order by l2_distance(c3, [1,2,3]) approximate limit 16384;
--error 1235
select * from t1 order by l2_distance(c3, [1,2,3]) approximate limit 16385;
--error 1235
select * from t1 order by l2_distance(c3, [1,2,3]) approximate limit 1,16384;

# bugfix: 2024080800104076307
select l2_distance(c3,c2) from t1  group by l2_distance(c3,[1,2,3]) order by l2_distance(c3, [1,2,3]) APPROX limit 10;
--error 1235
select l2_distance(c3,c2) from t1  group by l2_distance(c3,[1,2,3]) order by l2_distance(c3, [1,2,3]) APPROX limit 100000000;
drop table t1;

# bugfix: 2024081400104128272
--disable_warnings
drop table if exists t1;
--enable_warnings
CREATE TABLE t1 (c1 int primary key, c2 VARCHAR(30),c3 vector(3) ,c4 vector(2),
VECTOR INDEX vector_idx(c3)
WITH (distance=l2, lib=vsag, type=hnsw, m=10, ef_construction=50, ef_search=40));

insert into t1 values(1,'[1,1,2]','[2,2,3]','[1,3]');
insert into t1 values(2,'[1,2,3]','[1,2,3]','[2,3]');
insert into t1 values(3,'[-1,2,2]','[-3,2,3]','[4,3]');
insert into t1 values(4,'[-1,-2,-2]','[-4,2,3]',null);
insert into t1 values(5,'[-1,-2,-2]',null,'[2,3]');

select /*+index(t1 vector_idx)*/l1_distance(c3,'[1,2.2,3]') ld_c3,l1_distance(c4,'[1,1.456]') ld_c4 from t1 where l1_distance(c3,[1,2,3]) != 1  order by c1;
drop table t1;

# bugfix: 2024081500104139123
--disable_warnings
drop table if exists t;
--enable_warnings
create table t(c1 vector(3), c2 int unsigned auto_increment, c3 json, c4 date, c5 varchar(20), index idx_0(c4), primary key(c2));
insert into t values('[1,2,3]', default, '{}', '2024-05-06', 'tom');
alter table t add c6 vector(3);
create vector index idx_2 on t(c6) with (distance=l2, type=hnsw);
drop table t;

# bugfix: 2024080600104051161
--disable_warnings
drop table if exists t1;
--enable_warnings
CREATE TABLE t1 (c1 int primary key, c2 vector(3),c3 vector(3) ,c4 vector(3),
VECTOR INDEX vector_idx(c3)
WITH (distance=l2, lib=vsag, type=hnsw, m=10, ef_construction=12, ef_search=40));
insert into t1 values(1,'[1,1,2]','[2,2,3]','[1,3,2]');
insert into t1 values(2,'[1,0,3]','[1,0,3]','[2,3,2]');
insert into t1 values(3,'[-1,2,2]','[-3,2,3]','[4,3,3]');
insert into t1 values(4,'[-1,-2,-2]','[-4,2,3]',null);
insert into t1 values(5,'[-1,-3,-2]',null,'[2,3,1]');
select c1,c2,l2_distance(c3,c2) from t1 order by l2_distance(c3, [1,2,3]) approximate limit 10;
--error 1235
select c1,c2,l2_distance(c3,c2) from t1 order by l2_distance(c3, c4) approximate limit 10;
--error 1235
select c1,c2,l2_distance(c3,c2) from t1 order by c1 approximate limit 10;
--error 1235
select c1,c2,l2_distance(c3,c2) from t1 order by l2_distance(c3, c4) approximate limit 10;

# bugfix: 2024080600104052646
SELECT l2_distance(c3,c4) from t1 where  EXISTS (SELECT l2_distance(c3,[1,1,1]) FROM t1 order by l2_distance(c3, [1,2,3])  limit 10 ) order by c1;
SELECT l2_distance(c3,c4) from t1 where  EXISTS (SELECT l2_distance(c3,[1,1,1]) FROM t1 order by l2_distance(c3, [1,2,3]) approximate limit 10 ) order by c1;

# bugfix: 2024080600104051849
--disable_warnings
drop table if exists t2;
--enable_warnings
CREATE TABLE t2 (a1 int , a2 vector(3),a3 vector(3) ,a4 vector(3),
VECTOR INDEX vector_idx(a3)
WITH (distance=l2, lib=vsag, type=hnsw, m=10, ef_construction=12, ef_search=40));
insert into t2 select c1,c2,c3,c4 from t1;
select * from t1 a join t2 b on c3=a3 order by l2_distance(c3, [1,2,3]) approximate limit 10;
select * from t1 a join t2 b on c2=a2 order by l2_distance(c3, [1,2,3]) approximate limit 10;

SELECT avg(a2) FROM t2 order by l2_distance(a3, [1,1,-1]);
SELECT avg(a2) FROM t2 order by l2_distance(a3, [1,1,-1]) limit 1;
SELECT avg(a2) FROM t2 order by l2_distance(a3, [1,1,-1]) approximate limit 1;

select * from t2 order by l2_distance(avg(a3), [1,2,3]) limit 1;
--error 1235
select * from t2 order by l2_distance(avg(a3), [1,2,3]) approximate limit 1;
select * from t2 order by l2_distance(sum(a3), [1,2,3]) limit 1;
--error 1235
select * from t2 order by l2_distance(sum(a3), [1,2,3]) approximate limit 1;

drop table t1;
drop table t2;

# bugfix: 2024080800104072569
--disable_warnings
drop table if exists t1;
drop table if exists tt1;
drop table if exists tt2;
--enable_warnings
CREATE TABLE t1 (c1 int primary key, c2 varchar(30),c3 vector(3) ,c4 vector(3),
VECTOR INDEX vector_idx(c3)
WITH (distance=l2, lib=vsag, type=hnsw))PARTITION BY KEY(c1) PARTITIONS 4;
insert into t1(c1,c2,c3,c4) values(1,'[1,1,2]','[2,2,3]','[1,3,2]');
insert into t1(c1,c2,c3,c4) values(2,'[1,0,3]','[1,0,3]','[2,3,2]');
insert into t1(c1,c2,c3,c4) values(3,'[-1,2,2]','[-3,2,3]','[4,3,3]');
insert into t1(c1,c2,c3,c4) values(4,'[-1,-2,-2]','[-4,2,3]',null);
insert into t1(c1,c2,c3,c4) values(5,'[-1,-3,-2]',null,'[2,3,1]');
CREATE TABLE tt1 as select * from t1;
CREATE TABLE tt2 like t1;
replace INTO tt1(c1,c2,c3,c4) SELECT c1,c2,c3,c4  FROM t1;
replace INTO tt1(c1,c2,c3,c4) SELECT c1,c2,c3,c4  FROM t1;
replace INTO tt2(c1,c2,c3,c4) SELECT c1,c2,c3,c4  FROM t1;
replace INTO tt2(c1,c2,c3,c4) SELECT c1,c2,c3,c4  FROM t1;
select * from t1;
select * from tt1;
select * from tt2;
drop table t1;
drop table tt1;
drop table tt2;

# bugfix: 2024081400104128272
--disable_warnings
drop table if exists t1;
--enable_warnings
CREATE TABLE t1 (c1 int primary key, c2 VARCHAR(30),c3 vector(3) ,c4 vector(2),
VECTOR INDEX vector_idx(c3)
WITH (distance=l2, lib=vsag, type=hnsw, m=10, ef_construction=50, ef_search=40));
insert into t1 values(1,'[1,1,2]','[2,2,3]','[1,3]');
insert into t1 values(2,'[1,2,3]','[1,2,3]','[2,3]');
insert into t1 values(3,'[-1,2,2]','[-3,2,3]','[4,3]');
insert into t1 values(4,'[-1,-2,-2]','[-4,2,3]',null);
insert into t1 values(5,'[-1,-2,-2]',null,'[2,3]');

select /*+index(t1 vector_idx)*/l1_distance(c3,'[1,2.2,3]') ld_c3,l1_distance(c4,'[1,1.456]') ld_c4 from t1 where l1_distance(c3,[1,2,3]) != 1  order by c1;

drop table t1;

# bugfix: 2024082600104250957
--disable_warnings
drop table if exists t1;
drop table if exists tt1;
drop view if exists v1;
drop materialized view if exists mv1;
--enable_warnings
CREATE TABLE t1 (c1 int primary key, c2 varchar(30),c3 vector(3) ,c4 vector(3),
VECTOR INDEX vector_idx(c3)
WITH (distance=l2, lib=vsag, type=hnsw, m=10, ef_construction=100, ef_search=40));
insert into t1(c1,c2,c3,c4) values(1,'[1,1,2]','[2,2,3]','[1,3,2]');
insert into t1(c1,c2,c3,c4) values(2,'[1,0,3]','[1,0,3]','[2,3,2]');
insert into t1(c1,c2,c3,c4) values(3,'[-1,2,2]','[-3,2,3]','[4,3,3]');
insert into t1(c1,c2,c3,c4) values(4,'[-1,-2,-2]','[-4,2,3]',null);
insert into t1(c1,c2,c3,c4) values(5,'[-1,-3,-2]',null,'[2,3,1]');
select * from t1 order by l2_distance(c3, [1,2,3]) APPROX limit 10;
create view v1 as select * from t1 order by l2_distance(c3, [1,2,3]) APPROX limit 10;
show create table v1;

create table tt1 as select * from t1 order by l2_distance(c3, [1,2,3]) APPROX limit 10;
select * from tt1;

drop table tt1;
drop view v1;
drop table t1;

# bugfix: rowkey order for vector index
--disable_warnings
drop table if exists rowkey_order_with_vid;
--enable_warnings
CREATE TABLE rowkey_order_with_vid (
  c1 INT(20) NOT NULL AUTO_INCREMENT,
  c2 INT(20) NOT NULL,
  c3 vector(3) DEFAULT NULL,
  PRIMARY KEY (c2, c1),
  vector index f_idx(c3) WITH (distance=l2, lib=vsag, type=hnsw));
INSERT INTO rowkey_order_with_vid(c2, c3) VALUES (42584969, '[1,1,1]');
UPDATE rowkey_order_with_vid SET c2 = 45712355 WHERE c3 = '[1,1,1]';
UPDATE rowkey_order_with_vid SET c3 = '[2,2,2]' WHERE c2 = 45712355;
SELECT * FROM rowkey_order_with_vid;

DROP TABLE rowkey_order_with_vid;

#bugfix : 2024080800104071001
--disable_warnings
drop table if exists t1;
drop view if exists v1;
--enable_warnings
CREATE TABLE t1 (c1 int primary key, c2 varchar(30),c3 vector(3) ,c4 vector(3),
VECTOR INDEX vector_idx(c3)
WITH (distance=l2, lib=vsag, type=hnsw))PARTITION BY KEY(c1) PARTITIONS 4;
insert into t1(c1,c2,c3,c4) values(1,'[1,1,2]','[2,2,3]','[1,3,2]');
insert into t1(c1,c2,c3,c4) values(2,'[1,0,3]','[1,0,3]','[2,3,2]');
insert into t1(c1,c2,c3,c4) values(3,'[-1,2,2]','[-3,2,3]','[4,3,3]');
insert into t1(c1,c2,c3,c4) values(4,'[-1,-2,-2]','[-4,2,3]',null);
insert into t1(c1,c2,c3,c4) values(5,'[-1,-3,-2]',null,'[2,3,1]');
create view v1 as  select * from t1;
insert into v1(c1,c2,c3,c4) values(1,'[1,2,3]','[1,3,3]','[2,1,2]') ON DUPLICATE KEY UPDATE c2='[1,null,3]';
select * from t1;
select * from v1;
drop table t1;
drop view v1;

#bugfix : 2024081300104112736
--disable_warnings
drop table if exists t1;
--enable_warnings
CREATE TABLE t1 (c1 int primary key, c2 varchar(30),c3 vector(3) ,c4 vector(3),
VECTOR INDEX vector_idx(c3)
WITH (distance=l2, lib=vsag, type=hnsw, m=10, ef_construction=11, ef_search=40))PARTITION BY KEY(c1) PARTITIONS 4;
insert into t1(c1,c2,c3,c4) values(1,'[1,1,2]','[2,2,3]','[1,3,2]');
insert into t1(c1,c2,c3,c4) values(2,'[1,0,3]','[1,0,3]','[2,3,2]');
insert into t1(c1,c2,c3,c4) values(3,'[-1,2,2]','[-3,2,3]','[4,3,3]');
insert into t1(c1,c2,c3,c4) values(4,'[-1,-2,-2]','[-4,2,3]',null);
insert into t1(c1,c2,c3,c4) values(5,'[-1,-3,-2]',null,'[2,3,1]');

update t1 set c1 = 10 where c3 is null;
update t1 set c3 = (select ([2,3,4] + c4 * [2,3,4] * [6,7,8] - [9,8,7]) from t1 where c1 = 3);

select l1_distance(c3,c4) from t1;
update t1 set c3 = [2,3,4] where l1_distance(c3,c4) > 185;
select * from t1;
drop table t1;

#bugfix : lob threshold 0
--disable_warnings
drop table if exists vec;
--enable_warnings
create table vec(c1 int, c2 vector(3), primary key(c1), vector index idx1(c2) with (distance=l2, type=hnsw, lib=vsag)) LOB_INROW_THRESHOLD = 0;
insert into vec values (1, '[1,2,3]') ON DUPLICATE KEY UPDATE c2 = '[1,2,3]';
insert into vec values (1, '[1,2,3]') ON DUPLICATE KEY UPDATE c2 = '[1,2,3]';
insert into vec values (1, '[1,2,3]') ON DUPLICATE KEY UPDATE c2 = '[1,2,3]';
select * from vec;
drop table vec;

--disable_warnings
drop table if exists t1;
drop table if exists t2;
--enable_warnings
CREATE TABLE t1 (c1 int primary key, c2 varchar(30),c3 vector(3) ,c4 vector(3),
VECTOR INDEX vector_idx(c3)
WITH (distance=l2, lib=vsag, type=hnsw, m=10, ef_construction=100, ef_search=40));
insert into t1(c1,c2,c3,c4) values(1,'[1,1,2]','[2,2,3]','[1,3,2]');
insert into t1(c1,c2,c3,c4) values(2,'[1,0,3]','[1,0,3]','[2,3,2]');
insert into t1(c1,c2,c3,c4) values(3,'[-1,2,2]','[-3,2,3]','[4,3,3]');
CREATE TABLE t2 (a1 int , a2 vector(3),a3 vector(3) ,a4 vector(3),
VECTOR INDEX vector_idx(a3)
WITH (distance=l2, lib=vsag, type=hnsw, m=10, ef_construction=100, ef_search=40));
insert into t2 select c1,c2,c3,c4 from t1;

select * from t1,t2 where c3=a3 order by l2_distance(c3, [1,2,3]) APPROX limit 10;
select * from t1 a join t2 b on c3=a3 order by l2_distance(c3, [1,2,3]) APPROX limit 10;
select * from t1 a join t2 b on c2=a2 order by l2_distance(c3, [1,2,3]) APPROX limit 10;
select /*+PARALLEL(8)*/c3 from t1,t2   order by l2_distance(c3, [1,1,-1]) approximate limit 1;
select c3 from t1,t2 order by c1 limit 1;

replace into t1(c1,c2,c3,c4) values(1,'[1,1,2]','[2,2,3]','[0,0,0]');
alter table t1 add c5 vector(3);
insert into t1(c1,c2,c3,c4,c5) values(4,'[1,1,2]','[2,2,3]','[1,3,2]',[9,8,7]);
replace into t1(c1,c2,c3,c4,c5) values(4,'[1,1,2]','[2,2,3]','[1,3,2]',[4,5,6]);

drop table t1, t2;

--disable_warnings
drop table if exists t;
--enable_warnings
create table t(c1 vector(3), c2 int auto_increment, c3 char(10), primary key(c2), vector index idx_1(c1) with (distance=l2, type=hnsw));
drop index idx_1 on t;
drop table t;

#bugfix : 2024081500104143951
--disable_warnings
drop table if exists t1;
drop table if exists t2;
--enable_warnings

CREATE TABLE t1 (c1 int primary key, c2 vector(3),c3 vector(3) ,c4 vector(3),
VECTOR INDEX vector_idx(c3)
WITH (distance=l2, lib=vsag, type=hnsw, m=10, ef_construction=100, ef_search=40))PARTITION BY KEY(c1) PARTITIONS 4;
insert into t1(c1,c2,c3,c4) values(1,'[1,1,2]','[2,2,3]','[1,3,2]');
insert into t1(c1,c2,c3,c4) values(2,'[1,0,3]','[1,0,3]','[2,3,2]');
insert into t1(c1,c2,c3,c4) values(3,'[-1,2,2]','[-3,2,3]','[4,3,3]');
insert into t1(c1,c2,c3,c4) values(4,'[-1,-2,-2]','[-4,2,3]',null);
insert into t1(c1,c2,c3,c4) values(5,'[-1,-2,-2]',null,'[2,3,-1]');
CREATE TABLE t2 (a1 int , a2 vector(3),a3 vector(3) ,a4 vector(3),
VECTOR INDEX vector_idx(a3)
WITH (distance=l2, lib=vsag, type=hnsw, m=10, ef_construction=100, ef_search=40));
insert into t2 select c1,c2,c3,c4 from t1;
select l2_distance(c3,'[1,1.456,2]')  from t1,t2 where c4 is not null and a4 is not null order by l2_distance(c3, [1,1,-1])  limit 1;
select l2_distance(c4,'[1,1.456,2]')  from t1,t2 where c4 is not null and a4 is not null order by l2_distance(c3, [1,1,-1])  limit 1;

select l2_distance(c3,'[1,1.456,2]')  from t1,t2 where c4 is not null and a4 is not null order by l2_distance(c3, [1,1,-1]) APPROX limit 1;
select l2_distance(c4,'[1,1.456,2]')  from t1,t2 where c4 is not null and a4 is not null order by l2_distance(c3, [1,1,-1]) APPROX limit 1;
drop table t1;
drop table t2;

#bugfix: 2024090400104371308
--disable_warnings
drop table if exists t1;
drop table if exists t2;
drop view if exists v1;
drop table if exists tt1;
--enable_warnings
CREATE TABLE t1 (c1 int primary key, c2 vector(3),c3 vector(3) ,c4 vector(3),
VECTOR INDEX vector_idx(c3)
WITH (distance=l2, lib=vsag, type=hnsw, m=10, ef_construction=100, ef_search=40));
insert into t1 values(4,'[-1,-2,-2]','[-4,2,3]',null);
insert into t1 values(5,'[-1,-3,-2]',null,'[2,3,1]');
CREATE TABLE t2 (a1 int primary key, a2 vector(3),a3 vector(3) ,a4 vector(3));
insert into t2 select c1,c2,c3,c4 from t1;

select c3,l2_distance(c4,'[1,1.456,2.1]')  from t1,t2  order by l2_distance(c3, [1,1,-1]) APPROX limit 10;
create view v1 as select c3,l2_distance(c4,'[1,1.456,2.1]')  from t1,t2  order by l2_distance(c3, [1,1,-1]) APPROX limit 10;
select * from v1;
create table tt1 as select c3,l2_distance(c4,'[1,1.456,2.1]')  from t1,t2  order by l2_distance(c3, [1,1,-1]) APPROX limit 10;
select * from tt1;

drop view v1;
drop table tt1;
drop table t2;
drop table t1;

#bugfix : 2024082300104237582
--disable_warnings
drop table if exists t1;
drop table if exists tt1;
--enable_warnings
CREATE TABLE t1 (c1 int primary key, c2 varchar(30),c3 vector(3) ,c4 vector(3),
VECTOR INDEX vector_idx(c3)
WITH (distance=l2, lib=vsag, type=hnsw, m=10, ef_construction=100, ef_search=40));
insert into t1(c1,c2,c3,c4) values(1,'[1,1,2]','[2,2,3]','[1,3,2]');
insert into t1(c1,c2,c3,c4) values(2,'[1,0,3]','[1,0,3]','[2,3,2]');
insert into t1(c1,c2,c3,c4) values(3,'[-1,2,2]','[-3,2,3]','[4,3,3]');
create table tt1 like t1;
replace INTO tt1(c1,c2,c3,c4) SELECT c1,c2,c3,c4  FROM t1;

select * from t1 a ,tt1 b where a.c4=b.c4 order by l2_distance(b.c3, [1,2,3])  limit 10;
select * from t1 a ,tt1 b where a.c4=b.c4 order by l2_distance(b.c3, [1,2,3]) approximate limit 10;

drop table t1;
drop table tt1;

--error 1167
create table t1(c1 vector(3) unique);
--error 1167
create table t1(c1 vector(3) primary key);

#bugfix : 2024082900104318036
--disable_warnings
drop table if exists t1;
--enable_warnings
create table t1(c1 vector(3), c2 vector(3), c3 int, c4 json, c5 char(10), c6 text, c7 longtext, c8 point);
--error 1167
create index idx_1 on t1(c3) storing(c1) with column group(each column);
--error 1167
create index idx_1 on t1(c3) storing(c2) with column group(each column);
--error 1167
create index idx_1 on t1(c3) storing(c8) with column group(each column);
drop table t1;

#bug vetor index query hit plan
set ob_enable_plan_cache=1;
ALTER SYSTEM FLUSH PLAN CACHE GLOBAL;
sleep 3;
--disable_warnings
drop table if exists t_vector_index_query_plan;
--enable_warnings
create table t_vector_index_query_plan(c1 int, c2 vector(3), primary key(c1), vector index idx1(c2) with (distance=l2, type=hnsw, lib=vsag));
--disable_result_log
select * from t_vector_index_query_plan order by l2_distance(c2, [1,2,3]) APPROX limit 10;
select * from t_vector_index_query_plan order by l2_distance(c2, [3,2,1]) APPROX limit 10;
select * from t_vector_index_query_plan order by l2_distance(c2, [1,2,1]) APPROX limit 10;
--enable_result_log
select  hit_count from oceanbase.V$OB_PLAN_CACHE_PLAN_STAT where statement like "%select * from t_vector_index_query_plan%";
drop table t_vector_index_query_plan;

#bug select/delete/update with index back
--disable_warnings
drop table if exists t;
--enable_warnings
create table t (c1 vector(3), c2 array(float), c3 int auto_increment, c4 json,c5 int generated always as (cast(json_unquote(json_extract(c4, '$.age')) as unsigned)) virtual, primary key(c3),vector index idx_1(c1) with(distance=l2, type=hnsw), index idx_2(c5));
insert into t values('[0.23233454,0.2323233,0.123242]', '[0.23233454,0.2323233,0.123242]',default, '{"name":"a","age":18}', default);
insert into t values('[0.3232323,0.455656,0.5645344]', '[0.3232323,0.455656,0.5645344]',default, '{"name":"a","age":18}', default);
insert into t values([-0.978696,-0.4564654,-0.123123132], [-0.978696,-0.4564654,-0.123123132],default, '{"name":"d","age":21}', default);
insert into t values('[0.3232323,0.45565e-6,0.564534e4]', '[0.3232323,0.45565e-6,0.564534e4]',default, '{"name":"a","age":18}', default);
--error 1235
select * from t order by l2_distance(c1, '[1,1,1]') approx limit 2 for update;
drop table t;

--disable_warnings
drop table if exists t_list_sjg3;
--enable_warnings
CREATE TABLE `t_list_sjg3` (
`c_5_xJI0c_5_48oY` VECTOR(1342) DEFAULT NULL,
`col_auto_id` int(11) NOT NULL AUTO_INCREMENT,
`c_3_WUwb` varchar(400) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT 'aEFGHI01',
`c_2_ZDQP` bigint(20) NOT NULL DEFAULT '8',
`c_5_yDegc_5_jog3` VECTOR(396) DEFAULT NULL,
`c_1_8swR` varchar(400) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT 'abCDEFGHI01',
`c_4_hIiB` varchar(400) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT 'abCDEFGHI01',
`c_5_yFS3c_5_bug5` VECTOR(1562) DEFAULT NULL,
`c_0_kw4j` varchar(400) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT 'aEFGHI01',
`c_5_hgIbc_5_j4us` VECTOR(1525) DEFAULT NULL,
PRIMARY KEY (`col_auto_id`, `c_3_WUwb`, `c_2_ZDQP`),
KEY `c_3_WUwb` (`c_3_WUwb`(8)) BLOCK_SIZE 16384 LOCAL,
KEY `c_1_8swR` (`c_1_8swR`(2)) BLOCK_SIZE 16384 LOCAL,
KEY `c_4_hIiB` (`c_4_hIiB`(2)) BLOCK_SIZE 16384 LOCAL,
KEY `c_0_kw4j` (`c_0_kw4j`(1)) BLOCK_SIZE 16384 LOCAL,
VECTOR KEY `i_6rxOEsi_oPUbGJ` (`c_5_xJI0c_5_48oY`) WITH (DISTANCE=L2, TYPE=HNSW, LIB=VSAG, M=27, EF_CONSTRUCTION=433, EF_SEARCH=924) BLOCK_SIZE 16384,
VECTOR KEY `i_RposCXi_TeIR0N` (`c_5_yDegc_5_jog3`) WITH (DISTANCE=INNER_PRODUCT, TYPE=HNSW, LIB=VSAG, M=38, EF_CONSTRUCTION=177, EF_SEARCH=485) BLOCK_SIZE 16384,
VECTOR KEY `i_Si45Vji_LbW9dE` (`c_5_yFS3c_5_bug5`) WITH (DISTANCE=L2, TYPE=HNSW, LIB=VSAG, M=43, EF_CONSTRUCTION=563, EF_SEARCH=499) BLOCK_SIZE 16384,
VECTOR KEY `i_dvACqgi_cq8WdS` (`c_5_hgIbc_5_j4us`) WITH (DISTANCE=L2, TYPE=HNSW, LIB=VSAG, M=22, EF_CONSTRUCTION=338, EF_SEARCH=762) BLOCK_SIZE 16384,
KEY `i_5CMzRd` (`col_auto_id`) BLOCK_SIZE 16384 LOCAL,
KEY `i_WiGCuR` (`c_3_WUwb`) BLOCK_SIZE 16384 LOCAL,
KEY `i_SiYbCa` (`c_2_ZDQP`) BLOCK_SIZE 16384 GLOBAL,
KEY `i_zPiABo` (`c_1_8swR`) BLOCK_SIZE 16384 LOCAL,
KEY `i_HjUK14` (`c_4_hIiB`) BLOCK_SIZE 16384 GLOBAL,
KEY `i_ALVUeE` (`c_0_kw4j`) BLOCK_SIZE 16384 LOCAL
) AUTO_INCREMENT = 1 AUTO_INCREMENT_MODE = 'ORDER' DEFAULT CHARSET = utf8mb4 ROW_FORMAT = COMPRESSED COMPRESSION = 'lz4_1.0' REPLICA_NUM = 3 BLOCK_SIZE = 16384 USE_BLOOM_FILTER = FALSE TABLET_SIZE = 134217728 PCTFREE = 0 TABLE_MODE = 'QUEUING'
partition by list(col_auto_id)
(partition `p_list6` values in (6763,6764,6765,6766,6767,6768,6769,6770,6771),
partition `p_list0` values in (7420,7421,7422,7423,7424,7425,7426,7427,7428),
partition `p_list1` values in (12821,12822,12823,12824,12825,12826,12827,12828,12829),
partition `p_list3` values in (12913,12914,12915,12916,12917,12918,12919,12920,12921),
partition `p_list7` values in (15273,15274,15275,15276,15277,15278,15279,15280,15281),
partition `p_list2` values in (22267,22268,22269,22270,22271,22272,22273,22274,22275),
partition `p_list8` values in (43516,43517,43518,43519,43520,43521,43522,43523,43524),
partition `p_list4` values in (46161,46162,46163,46164,46165,46166,46167,46168,46169),
partition `p_list5` values in (51295,51296,51297,51298,51299,51300,51301,51302,51303),
partition `p_list9` values in (65581,65601,65602,65603,65604,65605,65606,65607,65608)) WITH COLUMN GROUP(all columns, each column);
delete /*+  ENABLE_PARALLEL_DML parallel(72) */   from t_list_sJg3;
drop table t_list_sJg3;
# bugfix: 2024083000104330469
--disable_warnings
drop table if exists t;
--enable_warnings
create table t(c1 vector(3), c2 int, primary key(c2), vector index idx_1(c1) with (distance=l2, type=hnsw)) partition by list(c2) (partition p0 values in (1,2,3));
insert into t values('[0.122,0.12121,0.53434]', 1);
select * from t where c2 in (1,2,3) order by l2_distance(c1, '[0,0,0]') approx limit 1;
drop table t;

#fix reset attrs at the wrong address
--disable_warnings
drop table if exists t2;
drop table if exists tt1;
drop table if exists t1;
--enable_warnings
CREATE TABLE t2 (c1 int primary key, c2 varchar(30),c3 vector(3) ,c4 vector(3),
VECTOR INDEX vector_idx(c3)
WITH (distance=l2, lib=vsag, type=hnsw, m=10, ef_construction=100, ef_search=40))PARTITION BY KEY(c1) PARTITIONS 4;
insert into t2(c1,c2,c3,c4) values(1,'[1,1,2]','[2,2,3]','[1,3,2]');
insert into t2(c1,c2,c3,c4) values(2,'[1,0,3]','[1,0,3]','[2,3,2]');
insert into t2(c1,c2,c3,c4) values(3,'[-1,2,2]','[-3,2,3]','[4,3,3]');
insert into t2(c1,c2,c3,c4) values(4,'[-1,-2,-2]','[-4,2,3]',null);
insert into t2(c1,c2,c3,c4) values(5,'[-1,-3,-2]',null,'[2,3,1]');
create table tt1 as select * from t2;
replace INTO tt1(c1,c2,c3,c4) SELECT c1,c2,c3,c4 FROM t2;
replace INTO tt1(c1,c2,c3,c4) SELECT c1,c2,c3,c4 FROM t2;

CREATE TABLE t1 (c1 int primary key, c2 varchar(30) ,c3 vector(3) ,c4 vector(3),c5 vector(3) AS ((c3*c2)) check(c5 = [2,2,6] or null ),c6 vector(3) AS ((c3*c4)) ,c7 vector(3) AS ((c3-c4)) ,c8 vector(3) AS ((c3+c4+c2)) ,
VECTOR INDEX vector_idx(c3)
WITH (distance=l2, lib=vsag, type=hnsw, m=10, ef_construction=100, ef_search=40))PARTITION BY KEY(c1) PARTITIONS 4;
insert into t1(c1,c2,c3,c4) values(1,'[1,1,2]','[2,2,3]','[1,3,2]');
insert into t1(c1,c2,c3,c4) values(3,'[1,0,3]','[1,0,3]','[2,3,2]');
insert into t1(c1,c2,c3,c4) values(4,'[-1,2,2]','[-3,2,3]','[4,3,3]');
insert into t1(c1,c2,c3,c4) values(7,'[-1,-2,-2]','[-4,2,3]',null);
insert into t1(c1,c2,c3,c4) values(8,'[-1,-3,-2]',null,'[2,3,1]');
insert into t1(c1,c2,c3,c4) values(9,'[1,1,2]','[2,2,3]','[1,3,2]');
insert into t1(c1,c2,c3,c4) values(10,'[1,0,3]','[1,0,3]','[2,3,2]');
insert into t1(c1,c2,c3,c4) values(2,'[-1,2,2]','[-3,2,3]','[4,3,3]');
insert into t1(c1,c2,c3,c4) values(11,'[-1,-2,-2]','[-4,2,3]',null);
replace INTO tt1(c1,c2,c3,c4) SELECT c1,c2,c3,c4  FROM t1;
select * from t1 a ,tt1 b where a.c4=b.c4 order by l2_distance(b.c3, [1,2,3]) limit 100;

--disable_warnings
drop table if exists t2;
drop table if exists tt1;
drop table if exists t1;
--enable_warnings

#fix read outrow vector in expr vec vector
--disable_warnings
drop table if exists vec;
--enable_warnings
create table vec(c1 int, c2 vector(3), c3 vector(3), primary key(c1), vector index idx1(c2) with (distance=l2, type=hnsw, lib=vsag), vector index idx2(c3) with (distance=l2, type=hnsw, lib=vsag)) LOB_INROW_THRESHOLD = 0;
insert into vec values (1, '[1,2,3]', '[4,5,6]') ON DUPLICATE KEY UPDATE c2 = '[1,22,32]';
insert into vec values (1, '[1,2,3]', '[4,5,6]') ON DUPLICATE KEY UPDATE c2 = '[1,22,32]';
insert into vec values (1, '[1,2,3]', '[4,5,6]') ON DUPLICATE KEY UPDATE c2 = '[1,22,32]';
select * from vec;
drop table vec;

# check select hint
--disable_warnings
drop table if exists t1;
--enable_warnings
create table t1(c1 int primary key, c2 vector(3), c3 vector(3), c4 vector(3), c5 vector(3), c6 vector(3));
create index idx1 on t1(c1);
create vector index idx_hnsw1 on t1(c2) with (distance=l2, type=hnsw);
create vector index idx_hnsw2 on t1(c3) with (distance=l2, type=hnsw);
create vector index idx_ivf_sq8 on t1(c4) with (distance=l2, type=ivf_sq8);
create vector index idx_ivf_pq on t1(c5) with (distance=l2, type=ivf_pq, m=1);
create vector index idx_ivf_flat on t1(c6) with (distance=l2, type=ivf_flat);
--replace_regex /_[0-9]+/_0/g
explain select /*+ index(t1 idx1) */ * from t1 order by l2_distance(c2, '[1,1,1]') approximate limit 1;
--replace_regex /_[0-9]+/_0/g
explain select /*+ index(t1 idx_hnsw1) */ * from t1 order by l2_distance(c2, '[1,1,1]') approximate limit 1;
--replace_regex /_[0-9]+/_0/g
explain select /*+ index(t1 idx_hnsw1) */ * from t1 order by l2_distance(c3, '[1,1,1]') approximate limit 1;
--replace_regex /_[0-9]+/_0/g
explain select /*+ index(t1 idx_hnsw1) */ * from t1 order by l2_distance(c4, '[1,1,1]') approximate limit 1;
--replace_regex /_[0-9]+/_0/g
explain select /*+ index(t1 idx_ivf_pq) */ * from t1 order by l2_distance(c5, '[1,1,1]') approximate limit 1;
--replace_regex /_[0-9]+/_0/g
explain select /*+ index(t1 idx_ivf_pq) */ * from t1 order by l2_distance(c6, '[1,1,1]') approximate limit 1;

drop table t1;

alter system set ob_vector_memory_limit_percentage = 0;
