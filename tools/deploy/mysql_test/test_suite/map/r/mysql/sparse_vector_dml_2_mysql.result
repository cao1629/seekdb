# ----------------------------------------------------------------------
# Test of sparse vector dml
# ----------------------------------------------------------------------
drop table if exists test_sparse_vec_tbl;
create table test_sparse_vec_tbl (
id int primary key, c1 bool, c2 int, c3 decimal, c4 float, c5 bit,
c6 date, c7 varchar(10), c8 text, c9 json, c10 GEOMETRY,
c11 array(int), c12 vector(3), c13 map(int, int), c14 sparsevector) ;
insert into test_sparse_vec_tbl values(1, true, 1, 1, 1.3, 1, '2020-01-01', 'abc', 'abc', '{"a":1}', ST_GeomFromText('POINT(1 1)'), [1,2,3,4,5], [1,2,3], '{1:123, 4:345}', '{1:123, 2:456}');
insert into test_sparse_vec_tbl values(2, true, 1, 1, 1.3, 1, '2020-01-01', 'abc', 'abc', '{"a":1}', ST_GeomFromText('POINT(1 1)'), [1,2,3,4,5], [1,2,3], '{1:123, 4:345}', null);
select id, c1, c11, c13, c14 from test_sparse_vec_tbl order by id;
id	c1	c11	c13	c14
1	1	[1,2,3,4,5]	{1:123,4:345}	{1:123,2:456}
2	1	[1,2,3,4,5]	{1:123,4:345}	NULL
insert into test_sparse_vec_tbl values(1, true, 1, 1, 1.3, 1, '2020-01-01', 'abc', 'abc', '{"a":1}', ST_GeomFromText('POINT(1 1)'), [1,2,3,4,5], [1,2,3], '{1:123, 4:345}', '{1:123, 2:456}') on duplicate key update c1 = false;
insert into test_sparse_vec_tbl values(1, true, 1, 1, 1.3, 1, '2020-01-01', 'abc', 'abc', '{"a":1}', ST_GeomFromText('POINT(1 1)'), [1,2,3,4,5], [1,2,3], '{1:123, 4:345}', '{1:123, 2:456}') on duplicate key update c14 = null;
insert into test_sparse_vec_tbl values(1, true, 1, 1, 1.3, 1, '2020-01-01', 'abc', 'abc', '{"a":1}', ST_GeomFromText('POINT(1 1)'), [1,2,3,4,5], [1,2,3], '{1:123, 4:345}', '{1:123, 2:456}') on duplicate key update c14 = '{1:3.4, 5:4.5}';
select id, c1, c11, c13, c14 from test_sparse_vec_tbl order by id;
id	c1	c11	c13	c14
1	0	[1,2,3,4,5]	{1:123,4:345}	{1:3.4,5:4.5}
2	1	[1,2,3,4,5]	{1:123,4:345}	NULL
insert IGNORE into test_sparse_vec_tbl values(1, true, 1, 1, 1.3, 1, '2020-01-01', 'abc', 'abc', '{"a":1}', ST_GeomFromText('POINT(1 1)'), [1,2,3,4,5], [1,2,3], '{1:123, 4:345}', '{1:123, 2:456}');
select id, c1, c11, c13, c14 from test_sparse_vec_tbl order by id;
id	c1	c11	c13	c14
1	0	[1,2,3,4,5]	{1:123,4:345}	{1:3.4,5:4.5}
2	1	[1,2,3,4,5]	{1:123,4:345}	NULL
replace into test_sparse_vec_tbl values(1, true, 1, 1, 1.3, 1, '2020-01-01', 'abc', 'abc', '{"a":1}', ST_GeomFromText('POINT(1 1)'), [1,2,3,4,5], [1,2,3], '{1:123, 4:345}', '{7:1.23, 50:4.56}');
replace into test_sparse_vec_tbl values(3, true, 1, 1, 1.3, 1, '2020-01-01', 'abc', 'abc', '{"a":1}', ST_GeomFromText('POINT(1 1)'), [1,2,3,4,5], [1,2,3], '{1:123, 4:345}', '{60:1.23, 80:4.56}');
select id, c1, c11, c13, c14 from test_sparse_vec_tbl order by id;
id	c1	c11	c13	c14
1	1	[1,2,3,4,5]	{1:123,4:345}	{7:1.23,50:4.56}
2	1	[1,2,3,4,5]	{1:123,4:345}	NULL
3	1	[1,2,3,4,5]	{1:123,4:345}	{60:1.23,80:4.56}
select /*+read_consistency(weak) */ id, c1, c11, c13, c14 from test_sparse_vec_tbl order by id;
id	c1	c11	c13	c14
1	1	[1,2,3,4,5]	{1:123,4:345}	{7:1.23,50:4.56}
2	1	[1,2,3,4,5]	{1:123,4:345}	NULL
3	1	[1,2,3,4,5]	{1:123,4:345}	{60:1.23,80:4.56}
delete from test_sparse_vec_tbl where id = 1;
drop table if exists test_sparse_vec_tbl_2;
create table test_sparse_vec_tbl_2 (
id int, c1 bool, c2 int, c3 decimal, c4 float, c5 bit,
c6 date, c7 varchar(10), c8 text, c9 json, c10 GEOMETRY,
c11 array(int), c12 vector(3), c13 map(int, int), c14 sparsevector);
insert into test_sparse_vec_tbl_2 select * from test_sparse_vec_tbl;
select id, c1, c11, c13, c14 from test_sparse_vec_tbl_2 order by id;
id	c1	c11	c13	c14
2	1	[1,2,3,4,5]	{1:123,4:345}	NULL
3	1	[1,2,3,4,5]	{1:123,4:345}	{60:1.23,80:4.56}
delete from test_sparse_vec_tbl_2;
drop table if exists test_sparse_vec_tbl_2;
alter system major freeze;
select id, c1, c11, c13, c14 from test_sparse_vec_tbl order by id;
id	c1	c11	c13	c14
2	1	[1,2,3,4,5]	{1:123,4:345}	NULL
3	1	[1,2,3,4,5]	{1:123,4:345}	{60:1.23,80:4.56}
update test_sparse_vec_tbl set c14 = '{1:1.5, 2:3, 5:6, 100:10}' where id = 1;
update /*+ ENABLE_PARALLEL_DML parallel(2) */ test_sparse_vec_tbl set c14 = '{1:1.5, 2:3, 5:6, 10:10}' where id = 1;
delete from test_sparse_vec_tbl where id < 4;
delete /*+ ENABLE_PARALLEL_DML parallel(2) */ from test_sparse_vec_tbl where id < 6;
select id, c1, c11, c13, c14 from test_sparse_vec_tbl;
id	c1	c11	c13	c14
delete from test_sparse_vec_tbl where c14 is null;
delete from test_sparse_vec_tbl where c14 is not null;
select id, c1, c11, c13, c14 from test_sparse_vec_tbl;
id	c1	c11	c13	c14
insert into test_sparse_vec_tbl values(1, true, 1, 1, 1.3, 1, '2020-01-01', 'abc', 'abc', '{"a":1}', ST_GeomFromText('POINT(1 1)'), [1,2,3,4,5], [1,2,3], '{1:123, 4:345}', '{1:123, 2:456}');
insert into test_sparse_vec_tbl values(2, true, 1, 1, 1.3, 1, '2020-01-01', 'abc', 'abc', '{"a":1}', ST_GeomFromText('POINT(1 1)'), [1,2,3,4,5], [1,2,3], '{1:123, 4:345}', null);
select id, c1, c11, c13, c14 from test_sparse_vec_tbl order by id;
id	c1	c11	c13	c14
1	1	[1,2,3,4,5]	{1:123,4:345}	{1:123,2:456}
2	1	[1,2,3,4,5]	{1:123,4:345}	NULL
truncate table test_sparse_vec_tbl;
drop table if exists test_sparse_vec_tbl;
create table test_sparse_vec_tbl (
id int primary key, c1 bool, c2 int, c3 decimal, c4 float, c5 bit,
c6 date, c7 varchar(10), c8 text, c9 json, c10 GEOMETRY,
c11 array(int), c12 vector(3), c13 map(int, int), c14 sparsevector) table_mode='queuing';
insert into test_sparse_vec_tbl values(1, true, 1, 1, 1.3, 1, '2020-01-01', 'abc', 'abc', '{"a":1}', ST_GeomFromText('POINT(1 1)'), [1,2,3,4,5], [1,2,3], '{1:123, 4:345}', '{1:123, 2:456}');
insert into test_sparse_vec_tbl values(2, true, 1, 1, 1.3, 1, '2020-01-01', 'abc', 'abc', '{"a":1}', ST_GeomFromText('POINT(1 1)'), [1,2,3,4,5], [1,2,3], '{1:123, 4:345}', null);
select id, c1, c11, c13, c14 from test_sparse_vec_tbl order by id;
id	c1	c11	c13	c14
1	1	[1,2,3,4,5]	{1:123,4:345}	{1:123,2:456}
2	1	[1,2,3,4,5]	{1:123,4:345}	NULL
insert into test_sparse_vec_tbl values(1, true, 1, 1, 1.3, 1, '2020-01-01', 'abc', 'abc', '{"a":1}', ST_GeomFromText('POINT(1 1)'), [1,2,3,4,5], [1,2,3], '{1:123, 4:345}', '{1:123, 2:456}') on duplicate key update c1 = false;
insert into test_sparse_vec_tbl values(1, true, 1, 1, 1.3, 1, '2020-01-01', 'abc', 'abc', '{"a":1}', ST_GeomFromText('POINT(1 1)'), [1,2,3,4,5], [1,2,3], '{1:123, 4:345}', '{1:123, 2:456}') on duplicate key update c14 = null;
insert into test_sparse_vec_tbl values(1, true, 1, 1, 1.3, 1, '2020-01-01', 'abc', 'abc', '{"a":1}', ST_GeomFromText('POINT(1 1)'), [1,2,3,4,5], [1,2,3], '{1:123, 4:345}', '{1:123, 2:456}') on duplicate key update c14 = '{1:3.4, 5:4.5}';
select id, c1, c11, c13, c14 from test_sparse_vec_tbl order by id;
id	c1	c11	c13	c14
1	0	[1,2,3,4,5]	{1:123,4:345}	{1:3.4,5:4.5}
2	1	[1,2,3,4,5]	{1:123,4:345}	NULL
insert IGNORE into test_sparse_vec_tbl values(1, true, 1, 1, 1.3, 1, '2020-01-01', 'abc', 'abc', '{"a":1}', ST_GeomFromText('POINT(1 1)'), [1,2,3,4,5], [1,2,3], '{1:123, 4:345}', '{1:123, 2:456}');
select id, c1, c11, c13, c14 from test_sparse_vec_tbl order by id;
id	c1	c11	c13	c14
1	0	[1,2,3,4,5]	{1:123,4:345}	{1:3.4,5:4.5}
2	1	[1,2,3,4,5]	{1:123,4:345}	NULL
replace into test_sparse_vec_tbl values(1, true, 1, 1, 1.3, 1, '2020-01-01', 'abc', 'abc', '{"a":1}', ST_GeomFromText('POINT(1 1)'), [1,2,3,4,5], [1,2,3], '{1:123, 4:345}', '{7:1.23, 50:4.56}');
replace into test_sparse_vec_tbl values(3, true, 1, 1, 1.3, 1, '2020-01-01', 'abc', 'abc', '{"a":1}', ST_GeomFromText('POINT(1 1)'), [1,2,3,4,5], [1,2,3], '{1:123, 4:345}', '{60:1.23, 80:4.56}');
select id, c1, c11, c13, c14 from test_sparse_vec_tbl order by id;
id	c1	c11	c13	c14
1	1	[1,2,3,4,5]	{1:123,4:345}	{7:1.23,50:4.56}
2	1	[1,2,3,4,5]	{1:123,4:345}	NULL
3	1	[1,2,3,4,5]	{1:123,4:345}	{60:1.23,80:4.56}
select /*+read_consistency(weak) */ id, c1, c11, c13, c14 from test_sparse_vec_tbl order by id;
id	c1	c11	c13	c14
1	1	[1,2,3,4,5]	{1:123,4:345}	{7:1.23,50:4.56}
2	1	[1,2,3,4,5]	{1:123,4:345}	NULL
3	1	[1,2,3,4,5]	{1:123,4:345}	{60:1.23,80:4.56}
delete from test_sparse_vec_tbl where id = 1;
drop table if exists test_sparse_vec_tbl_2;
create table test_sparse_vec_tbl_2 (
id int, c1 bool, c2 int, c3 decimal, c4 float, c5 bit,
c6 date, c7 varchar(10), c8 text, c9 json, c10 GEOMETRY,
c11 array(int), c12 vector(3), c13 map(int, int), c14 sparsevector);
insert into test_sparse_vec_tbl_2 select * from test_sparse_vec_tbl;
select id, c1, c11, c13, c14 from test_sparse_vec_tbl_2 order by id;
id	c1	c11	c13	c14
2	1	[1,2,3,4,5]	{1:123,4:345}	NULL
3	1	[1,2,3,4,5]	{1:123,4:345}	{60:1.23,80:4.56}
delete from test_sparse_vec_tbl_2;
drop table if exists test_sparse_vec_tbl_2;
alter system major freeze;
select id, c1, c11, c13, c14 from test_sparse_vec_tbl order by id;
id	c1	c11	c13	c14
2	1	[1,2,3,4,5]	{1:123,4:345}	NULL
3	1	[1,2,3,4,5]	{1:123,4:345}	{60:1.23,80:4.56}
update test_sparse_vec_tbl set c14 = '{1:1.5, 2:3, 5:6, 100:10}' where id = 1;
update /*+ ENABLE_PARALLEL_DML parallel(2) */ test_sparse_vec_tbl set c14 = '{1:1.5, 2:3, 5:6, 10:10}' where id = 1;
delete from test_sparse_vec_tbl where id < 4;
delete /*+ ENABLE_PARALLEL_DML parallel(2) */ from test_sparse_vec_tbl where id < 6;
select id, c1, c11, c13, c14 from test_sparse_vec_tbl;
id	c1	c11	c13	c14
delete from test_sparse_vec_tbl where c14 is null;
delete from test_sparse_vec_tbl where c14 is not null;
select id, c1, c11, c13, c14 from test_sparse_vec_tbl;
id	c1	c11	c13	c14
insert into test_sparse_vec_tbl values(1, true, 1, 1, 1.3, 1, '2020-01-01', 'abc', 'abc', '{"a":1}', ST_GeomFromText('POINT(1 1)'), [1,2,3,4,5], [1,2,3], '{1:123, 4:345}', '{1:123, 2:456}');
insert into test_sparse_vec_tbl values(2, true, 1, 1, 1.3, 1, '2020-01-01', 'abc', 'abc', '{"a":1}', ST_GeomFromText('POINT(1 1)'), [1,2,3,4,5], [1,2,3], '{1:123, 4:345}', null);
select id, c1, c11, c13, c14 from test_sparse_vec_tbl order by id;
id	c1	c11	c13	c14
1	1	[1,2,3,4,5]	{1:123,4:345}	{1:123,2:456}
2	1	[1,2,3,4,5]	{1:123,4:345}	NULL
truncate table test_sparse_vec_tbl;
drop table if exists test_sparse_vec_tbl;
alter system set ob_vector_memory_limit_percentage =44;
create table test_sparse_vec_tbl (
id int primary key, c1 bool, c2 int, c3 decimal, c4 float, c5 bit,
c6 date, c7 varchar(10), c8 text, c9 json, c10 GEOMETRY,
c11 array(int), c12 vector(3), c13 map(int, int), c14 sparsevector);
create index idx_c2 on test_sparse_vec_tbl(c2);
create vector index idx_c12 on test_sparse_vec_tbl(c12) with (distance=l2, lib=vsag, type=hnsw, m=10, ef_construction=100, ef_search=40);
insert into test_sparse_vec_tbl values(1, true, 1, 1, 1.3, 1, '2020-01-01', 'abc', 'abc', '{"a":1}', ST_GeomFromText('POINT(1 1)'), [1,2,3,4,5], [1,2,3], '{1:123, 4:345}', '{1:123, 2:456}');
insert into test_sparse_vec_tbl values(2, true, 1, 1, 1.3, 1, '2020-01-01', 'abc', 'abc', '{"a":1}', ST_GeomFromText('POINT(1 1)'), [1,2,3,4,5], [1,2,3], '{1:123, 4:345}', null);
select id, c1, c11, c13, c14 from test_sparse_vec_tbl order by id;
id	c1	c11	c13	c14
1	1	[1,2,3,4,5]	{1:123,4:345}	{1:123,2:456}
2	1	[1,2,3,4,5]	{1:123,4:345}	NULL
insert into test_sparse_vec_tbl values(1, true, 1, 1, 1.3, 1, '2020-01-01', 'abc', 'abc', '{"a":1}', ST_GeomFromText('POINT(1 1)'), [1,2,3,4,5], [1,2,3], '{1:123, 4:345}', '{1:123, 2:456}') on duplicate key update c1 = false;
insert into test_sparse_vec_tbl values(1, true, 1, 1, 1.3, 1, '2020-01-01', 'abc', 'abc', '{"a":1}', ST_GeomFromText('POINT(1 1)'), [1,2,3,4,5], [1,2,3], '{1:123, 4:345}', '{1:123, 2:456}') on duplicate key update c14 = null;
insert into test_sparse_vec_tbl values(1, true, 1, 1, 1.3, 1, '2020-01-01', 'abc', 'abc', '{"a":1}', ST_GeomFromText('POINT(1 1)'), [1,2,3,4,5], [1,2,3], '{1:123, 4:345}', '{1:123, 2:456}') on duplicate key update c14 = '{1:3.4, 5:4.5}';
select id, c1, c11, c13, c14 from test_sparse_vec_tbl order by id;
id	c1	c11	c13	c14
1	0	[1,2,3,4,5]	{1:123,4:345}	{1:3.4,5:4.5}
2	1	[1,2,3,4,5]	{1:123,4:345}	NULL
insert IGNORE into test_sparse_vec_tbl values(1, true, 1, 1, 1.3, 1, '2020-01-01', 'abc', 'abc', '{"a":1}', ST_GeomFromText('POINT(1 1)'), [1,2,3,4,5], [1,2,3], '{1:123, 4:345}', '{1:123, 2:456}');
select id, c1, c11, c13, c14 from test_sparse_vec_tbl order by id;
id	c1	c11	c13	c14
1	0	[1,2,3,4,5]	{1:123,4:345}	{1:3.4,5:4.5}
2	1	[1,2,3,4,5]	{1:123,4:345}	NULL
replace into test_sparse_vec_tbl values(1, true, 1, 1, 1.3, 1, '2020-01-01', 'abc', 'abc', '{"a":1}', ST_GeomFromText('POINT(1 1)'), [1,2,3,4,5], [1,2,3], '{1:123, 4:345}', '{7:1.23, 50:4.56}');
replace into test_sparse_vec_tbl values(3, true, 1, 1, 1.3, 1, '2020-01-01', 'abc', 'abc', '{"a":1}', ST_GeomFromText('POINT(1 1)'), [1,2,3,4,5], [1,2,3], '{1:123, 4:345}', '{60:1.23, 80:4.56}');
select id, c1, c11, c13, c14 from test_sparse_vec_tbl order by id;
id	c1	c11	c13	c14
1	1	[1,2,3,4,5]	{1:123,4:345}	{7:1.23,50:4.56}
2	1	[1,2,3,4,5]	{1:123,4:345}	NULL
3	1	[1,2,3,4,5]	{1:123,4:345}	{60:1.23,80:4.56}
select /*+read_consistency(weak) */ id, c1, c11, c13, c14 from test_sparse_vec_tbl order by id;
id	c1	c11	c13	c14
1	1	[1,2,3,4,5]	{1:123,4:345}	{7:1.23,50:4.56}
2	1	[1,2,3,4,5]	{1:123,4:345}	NULL
3	1	[1,2,3,4,5]	{1:123,4:345}	{60:1.23,80:4.56}
delete from test_sparse_vec_tbl where id = 1;
drop table if exists test_sparse_vec_tbl_2;
create table test_sparse_vec_tbl_2 (
id int, c1 bool, c2 int, c3 decimal, c4 float, c5 bit,
c6 date, c7 varchar(10), c8 text, c9 json, c10 GEOMETRY,
c11 array(int), c12 vector(3), c13 map(int, int), c14 sparsevector);
insert into test_sparse_vec_tbl_2 select * from test_sparse_vec_tbl;
select id, c1, c11, c13, c14 from test_sparse_vec_tbl_2 order by id;
id	c1	c11	c13	c14
2	1	[1,2,3,4,5]	{1:123,4:345}	NULL
3	1	[1,2,3,4,5]	{1:123,4:345}	{60:1.23,80:4.56}
delete from test_sparse_vec_tbl_2;
drop table if exists test_sparse_vec_tbl_2;
alter system major freeze;
select id, c1, c11, c13, c14 from test_sparse_vec_tbl order by id;
id	c1	c11	c13	c14
2	1	[1,2,3,4,5]	{1:123,4:345}	NULL
3	1	[1,2,3,4,5]	{1:123,4:345}	{60:1.23,80:4.56}
update test_sparse_vec_tbl set c14 = '{1:1.5, 2:3, 5:6, 100:10}' where id = 1;
update /*+ ENABLE_PARALLEL_DML parallel(2) */ test_sparse_vec_tbl set c14 = '{1:1.5, 2:3, 5:6, 10:10}' where id = 1;
delete from test_sparse_vec_tbl where id < 4;
delete /*+ ENABLE_PARALLEL_DML parallel(2) */ from test_sparse_vec_tbl where id < 6;
select id, c1, c11, c13, c14 from test_sparse_vec_tbl;
id	c1	c11	c13	c14
delete from test_sparse_vec_tbl where c14 is null;
delete from test_sparse_vec_tbl where c14 is not null;
select id, c1, c11, c13, c14 from test_sparse_vec_tbl;
id	c1	c11	c13	c14
insert into test_sparse_vec_tbl values(1, true, 1, 1, 1.3, 1, '2020-01-01', 'abc', 'abc', '{"a":1}', ST_GeomFromText('POINT(1 1)'), [1,2,3,4,5], [1,2,3], '{1:123, 4:345}', '{1:123, 2:456}');
insert into test_sparse_vec_tbl values(2, true, 1, 1, 1.3, 1, '2020-01-01', 'abc', 'abc', '{"a":1}', ST_GeomFromText('POINT(1 1)'), [1,2,3,4,5], [1,2,3], '{1:123, 4:345}', null);
select id, c1, c11, c13, c14 from test_sparse_vec_tbl order by id;
id	c1	c11	c13	c14
1	1	[1,2,3,4,5]	{1:123,4:345}	{1:123,2:456}
2	1	[1,2,3,4,5]	{1:123,4:345}	NULL
truncate table test_sparse_vec_tbl;
drop table if exists test_sparse_vec_tbl;
alter system set ob_vector_memory_limit_percentage =0;
