#owner: lana.lgx
#owner group: data
#description: xxx_MVIEW_LOGS views
#tags: mview
#author: suzhi.yt

connect (sys,$OBMYSQL_MS0,admin,$OBMYSQL_PWD,test,$OBMYSQL_PORT);
connection default;

--disable_query_log
let $current_tenant_id = query_get_value(select effective_tenant_id() x, x, 1);
use test;
--source mysql_test/include/ignore_drop_mlog_err_mysql.inc
drop materialized view log on t1;
--source mysql_test/include/ignore_drop_mlog_err_mysql.inc
drop materialized view log on t2;
--source mysql_test/include/ignore_drop_mlog_err_mysql.inc
drop materialized view log on t3;
--disable_warnings
drop table if exists t1;
drop table if exists t2;
drop table if exists t3;
--enable_warnings
--enable_query_log

create table t1(c1 int primary key, c2 int, c3 int, c4 int);
create table t2(c1 int, c2 int, c3 int, c4 int);
create table t3(c1 int primary key, c2 int, c3 int, c4 int);
create materialized view log on t1 with primary key, sequence (c2, c3) including new values;
create materialized view log on t2 with rowid including new values;
create materialized view log on t3 with primary key including new values purge start with sysdate() next sysdate() + interval 1 day;

SELECT LOG_OWNER,MASTER,LOG_TABLE,ROWIDS,PRIMARY_KEY,FILTER_COLUMNS,SEQUENCE,INCLUDE_NEW_VALUES,PURGE_ASYNCHRONOUS,PURGE_DEFERRED,PURGE_START IS NULL,PURGE_INTERVAL,COMMIT_SCN_BASED FROM oceanbase.DBA_MVIEW_LOGS WHERE LOG_OWNER = 'test' AND MASTER IN ('t1', 't2', 't3') ORDER BY MASTER;
connection sys;
--echo SELECT LOG_OWNER,MASTER,LOG_TABLE,ROWIDS,PRIMARY_KEY,FILTER_COLUMNS,SEQUENCE,INCLUDE_NEW_VALUES,PURGE_ASYNCHRONOUS,PURGE_DEFERRED,PURGE_START IS NULL,PURGE_INTERVAL,COMMIT_SCN_BASED FROM oceanbase.CDB_MVIEW_LOGS WHERE LOG_OWNER = 'test' AND MASTER IN ('t1', 't2', 't3') ORDER BY MASTER;
--disable_query_log
eval SELECT LOG_OWNER,MASTER,LOG_TABLE,ROWIDS,PRIMARY_KEY,FILTER_COLUMNS,SEQUENCE,INCLUDE_NEW_VALUES,PURGE_ASYNCHRONOUS,PURGE_DEFERRED,PURGE_START IS NULL,PURGE_INTERVAL,COMMIT_SCN_BASED FROM oceanbase.CDB_MVIEW_LOGS WHERE TENANT_ID = $current_tenant_id AND LOG_OWNER = 'test' AND MASTER IN ('t1', 't2', 't3') ORDER BY MASTER;
--enable_query_log
connection default;

drop materialized view log on t1;
SELECT LOG_OWNER,MASTER,LOG_TABLE,ROWIDS,PRIMARY_KEY,FILTER_COLUMNS,SEQUENCE,INCLUDE_NEW_VALUES,PURGE_ASYNCHRONOUS,PURGE_DEFERRED,PURGE_START IS NULL,PURGE_INTERVAL,COMMIT_SCN_BASED FROM oceanbase.DBA_MVIEW_LOGS WHERE LOG_OWNER = 'test' AND MASTER IN ('t1', 't2', 't3') ORDER BY MASTER;
connection sys;
--echo SELECT LOG_OWNER,MASTER,LOG_TABLE,ROWIDS,PRIMARY_KEY,FILTER_COLUMNS,SEQUENCE,INCLUDE_NEW_VALUES,PURGE_ASYNCHRONOUS,PURGE_DEFERRED,PURGE_START IS NULL,PURGE_INTERVAL,COMMIT_SCN_BASED FROM oceanbase.CDB_MVIEW_LOGS WHERE LOG_OWNER = 'test' AND MASTER IN ('t1', 't2', 't3') ORDER BY MASTER;
--disable_query_log
eval SELECT LOG_OWNER,MASTER,LOG_TABLE,ROWIDS,PRIMARY_KEY,FILTER_COLUMNS,SEQUENCE,INCLUDE_NEW_VALUES,PURGE_ASYNCHRONOUS,PURGE_DEFERRED,PURGE_START IS NULL,PURGE_INTERVAL,COMMIT_SCN_BASED FROM oceanbase.CDB_MVIEW_LOGS WHERE TENANT_ID = $current_tenant_id AND LOG_OWNER = 'test' AND MASTER IN ('t1', 't2', 't3') ORDER BY MASTER;
--enable_query_log
connection default;

drop materialized view log on t2;
create materialized view log on t1 with primary key, sequence (c2, c3) including new values purge start with sysdate();
create materialized view log on t2 with rowid, sequence (c2, c3) including new values purge next sysdate() + interval 1 day;
SELECT LOG_OWNER,MASTER,LOG_TABLE,ROWIDS,PRIMARY_KEY,FILTER_COLUMNS,SEQUENCE,INCLUDE_NEW_VALUES,PURGE_ASYNCHRONOUS,PURGE_DEFERRED,PURGE_START IS NULL,PURGE_INTERVAL,COMMIT_SCN_BASED FROM oceanbase.DBA_MVIEW_LOGS WHERE LOG_OWNER = 'test' AND MASTER IN ('t1', 't2', 't3') ORDER BY MASTER;
connection sys;
--echo SELECT LOG_OWNER,MASTER,LOG_TABLE,ROWIDS,PRIMARY_KEY,FILTER_COLUMNS,SEQUENCE,INCLUDE_NEW_VALUES,PURGE_ASYNCHRONOUS,PURGE_DEFERRED,PURGE_START IS NULL,PURGE_INTERVAL,COMMIT_SCN_BASED FROM oceanbase.CDB_MVIEW_LOGS WHERE LOG_OWNER = 'test' AND MASTER IN ('t1', 't2', 't3') ORDER BY MASTER;
--disable_query_log
eval SELECT LOG_OWNER,MASTER,LOG_TABLE,ROWIDS,PRIMARY_KEY,FILTER_COLUMNS,SEQUENCE,INCLUDE_NEW_VALUES,PURGE_ASYNCHRONOUS,PURGE_DEFERRED,PURGE_START IS NULL,PURGE_INTERVAL,COMMIT_SCN_BASED FROM oceanbase.CDB_MVIEW_LOGS WHERE TENANT_ID = $current_tenant_id AND LOG_OWNER = 'test' AND MASTER IN ('t1', 't2', 't3') ORDER BY MASTER;
--enable_query_log
connection default;

drop materialized view log on t1;
drop materialized view log on t2;
drop materialized view log on t3;
drop table t1;
drop table t2;
drop table t3;
