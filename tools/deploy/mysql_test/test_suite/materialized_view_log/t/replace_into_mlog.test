#owner: lana.lgx
#owner group: data

--source mysql_test/include/ignore_drop_mlog_err_mysql.inc
drop materialized view log on t1;
--source mysql_test/include/ignore_drop_mlog_err_mysql.inc
drop materialized view log on t2;
--disable_warnings
DROP TABLE IF EXISTS t1;
DROP TABLE IF EXISTS t2;

--enable_sorted_result

# replace into
--enable_warnings
CREATE TABLE t1 (
  id int primary key,
  name varchar(10),
  age int
);

# create mlog on t1
create materialized view log on t1 with primary key (name, age) including new values;

replace into t1 values (1, 'jack', 20), (2, 'rose', 25);
select * from t1;
select sequence$$, id, name, age from mlog$_t1;

replace into t1 values (1, 'jack', 23), (2, 'lucy', 30);
select * from t1;
select sequence$$, id, name, age from mlog$_t1;

# insert on duplicate key update
--enable_warnings
CREATE TABLE t2 (
  id int primary key,
  name varchar(10),
  age int
);

# create mlog on t2
create materialized view log on t2 with primary key (name, age) including new values;

insert into t2 values (1, 'jack', 20), (2, 'rose', 25) on duplicate key update name = values(name), age = values(age);
select * from t2;
select sequence$$, id, name, age from mlog$_t2;

insert into t2 values (1, 'jack', 23), (2, 'lucy', 30) on duplicate key update name = values(name), age = values(age);
select * from t2;
select sequence$$, id, name, age from mlog$_t2;

# clean up
drop materialized view log on t1;
drop materialized view log on t2;
drop table t1;
drop table t2;