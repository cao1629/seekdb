#owner: lana.lgx
#owner group: data

#1: non-PDML update
--source mysql_test/include/ignore_drop_mlog_err_mysql.inc
drop materialized view log on t1;
--disable_warnings
DROP TABLE IF EXISTS t1;
--enable_warnings
CREATE TABLE t1 (
  id int primary key,
  name varchar(10),
  age int
);

# create mlog on base table
create materialized view log on t1 with primary key (age) including new values;
desc mlog$_t1;

# insert data to empty base table
insert into t1 values (1, 'Lucy', 21), (2, 'Tommy', 24), (3, 'Jack', 30), (4, 'May', 22), (5, 'Rose', 23), (6, 'Grace', 34), (7, 'Nancy', 24), (8, 'Jones', 32), (9, 'Jerry', 23), (10, 'Marry', 25);

select count(*) from t1;
select dmltype$$, old_new$$, id from mlog$_t1;

# delete data
delete from t1 where age < 25;

select count(*) from t1;
select dmltype$$, old_new$$, id from mlog$_t1;

#2: PDML-delete
#insert /*+ enable_parallel_dml parallel(3) */ into t1 values (11, 'Lucy', 21), (12, 'Tommy', 24), (13, 'Jack', 30), (14, 'May', 22), (15, 'Rose', 23), (16, 'Grace', 34), (17, 'Nancy', 24), (18, 'Jones', 32), (19, 'Jerry', 23), (20, 'Marry', 25);
#delete /*+ enable_parallel_dml parallel(3) */ from t1 where age < 25;
insert into t1 values (11, 'Lucy', 21), (12, 'Tommy', 24), (13, 'Jack', 30), (14, 'May', 22), (15, 'Rose', 23), (16, 'Grace', 34), (17, 'Nancy', 24), (18, 'Jones', 32), (19, 'Jerry', 23), (20, 'Marry', 25);
delete from t1 where age < 25;

select count(*) from t1;
select dmltype$$, old_new$$, id from mlog$_t1;

#3: delete within a transaction
set autocommit=off;
# start transaction
begin;
delete from t1 where age > 30;
select count(*) from t1;
select dmltype$$, old_new$$, id from mlog$_t1;
# rollback transaction
rollback;
select count(*) from t1;
select dmltype$$, old_new$$, id from mlog$_t1;

# cleanup
drop materialized view log on t1;
drop table t1;