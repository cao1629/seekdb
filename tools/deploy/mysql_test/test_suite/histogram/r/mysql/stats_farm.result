result_format: 4
alter system set_tp tp_no = 368, error_code = 0, frequency = 1;

##build new tenant.
##build tenant


use test;
drop user if exists root@'127.0.0.1';
drop user if exists root@'127.0.1.1';
drop user if exists root@'127.1.1.1';
create user root@'127.0.0.1' identified by 'rootWang@123';
create user root@'127.0.1.1' identified by 'rootWang@123';
create user root@'127.1.1.1' identified by 'rootWang@123';
select count(*) from oceanbase.__all_user where user_name='root';
+----------+
| count(*) |
+----------+
|        4 |
+----------+

call dbms_stats.gather_schema_stats('oceanbase');
select OWNER, TABLE_NAME, NUM_ROWS from OCEANBASE.DBA_TAB_STATISTICS where table_name='__all_core_table' and NUM_ROWS > 0;
+-------+------------+----------+
| OWNER | TABLE_NAME | NUM_ROWS |
+-------+------------+----------+
+-------+------------+----------+
select OWNER, TABLE_NAME, NUM_ROWS from OCEANBASE.DBA_TAB_STATISTICS where table_name='__ALL_VIRTUAL_CORE_ALL_TABLE' and NUM_ROWS > 0;
+-----------+------------------------------+----------+
| OWNER     | TABLE_NAME                   | NUM_ROWS |
+-----------+------------------------------+----------+
| oceanbase | __all_virtual_core_all_table |       16 |
+-----------+------------------------------+----------+
select OWNER, TABLE_NAME, NUM_ROWS from OCEANBASE.DBA_TAB_STATISTICS where table_name='__ALL_VIRTUAL_CORE_COLUMN_TABLE' and NUM_ROWS > 0;
+-----------+---------------------------------+----------+
| OWNER     | TABLE_NAME                      | NUM_ROWS |
+-----------+---------------------------------+----------+
| oceanbase | __all_virtual_core_column_table |      199 |
+-----------+---------------------------------+----------+
select count(*) from OCEANBASE.DBA_TAB_STATISTICS where table_name='__all_table' and NUM_ROWS > 0;
+----------+
| count(*) |
+----------+
|        1 |
+----------+
select count(*) from OCEANBASE.DBA_TAB_STATISTICS where table_name='__all_column' and NUM_ROWS > 0;
+----------+
| count(*) |
+----------+
|        1 |
+----------+

##see the maintenance window
select OWNER,JOB_NAME,ENABLED,REPEAT_INTERVAL,MAX_RUN_DURATION from oceanbase.dba_scheduler_jobs where JOB_NAME in ('FRIDAY_WINDOW','MONDAY_WINDOW','OPT_STATS_HISTORY_MANAGER','SATURDAY_WINDOW','SUNDAY_WINDOW','THURSDAY_WINDOW','TUESDAY_WINDOW','WEDNESDAY_WINDOW', 'ASYNC_GATHER_STATS_JOB_PROC');
+--------+-----------------------------+---------+----------------------------+------------------+
| OWNER  | JOB_NAME                    | ENABLED | REPEAT_INTERVAL            | MAX_RUN_DURATION |
+--------+-----------------------------+---------+----------------------------+------------------+
| root@% | ASYNC_GATHER_STATS_JOB_PROC | 1       | FREQ=MINUTELY; INTERVAL=15 |              600 |
| root@% | FRIDAY_WINDOW               | 1       | FREQ=WEEKLY; INTERVAL=1    |            14400 |
| root@% | MONDAY_WINDOW               | 1       | FREQ=WEEKLY; INTERVAL=1    |            14400 |
| root@% | OPT_STATS_HISTORY_MANAGER   | 1       | FREQ=DAYLY; INTERVAL=1     |            43200 |
| root@% | SATURDAY_WINDOW             | 1       | FREQ=WEEKLY; INTERVAL=1    |            14400 |
| root@% | SUNDAY_WINDOW               | 1       | FREQ=WEEKLY; INTERVAL=1    |            14400 |
| root@% | THURSDAY_WINDOW             | 1       | FREQ=WEEKLY; INTERVAL=1    |            14400 |
| root@% | TUESDAY_WINDOW              | 1       | FREQ=WEEKLY; INTERVAL=1    |            14400 |
| root@% | WEDNESDAY_WINDOW            | 1       | FREQ=WEEKLY; INTERVAL=1    |            14400 |
+--------+-----------------------------+---------+----------------------------+------------------+
desc oceanbase.dba_scheduler_windows;
+------------------+--------------+------+-----+---------+-------+
| Field            | Type         | Null | Key | Default | Extra |
+------------------+--------------+------+-----+---------+-------+
| OWNER            | varchar(128) | NO   |     | NULL    |       |
| WINDOW_NAME      | varchar(128) | NO   |     | NULL    |       |
| RESOURCE_PLAN    | varchar(128) | NO   |     |         |       |
| SCHEDULE_OWNER   | text         | NO   |     |         |       |
| SCHEDULE_NAME    | text         | NO   |     |         |       |
| SCHEDULE_TYPE    | varchar(8)   | NO   |     |         |       |
| START_DATE       | datetime(6)  | YES  |     | NULL    |       |
| REPEAT_INTERVAL  | text         | YES  |     | NULL    |       |
| END_DATE         | datetime(6)  | YES  |     | NULL    |       |
| DURATION         | bigint(20)   | YES  |     | NULL    |       |
| WINDOW_PRIORITY  | varchar(4)   | NO   |     |         |       |
| NEXT_RUN_DATE    | datetime(6)  | NO   |     | NULL    |       |
| LAST_START_DATE  | datetime(6)  | YES  |     | NULL    |       |
| ENABLED          | varchar(5)   | YES  |     | NULL    |       |
| ACTIVE           | varchar(5)   | NO   |     |         |       |
| MANUAL_OPEN_TIME | datetime(6)  | NO   |     |         |       |
| MANUAL_DURATION  | bigint(0)    | NO   |     |         |       |
| COMMENTS         | text         | YES  |     | NULL    |       |
+------------------+--------------+------+-----+---------+-------+
select OWNER,WINDOW_NAME,ENABLED,REPEAT_INTERVAL,DURATION,COMMENTS from oceanbase.dba_scheduler_windows;
+--------+------------------+---------+-------------------------+----------+---------------------------------+
| OWNER  | WINDOW_NAME      | ENABLED | REPEAT_INTERVAL         | DURATION | COMMENTS                        |
+--------+------------------+---------+-------------------------+----------+---------------------------------+
| root@% | FRIDAY_WINDOW    | 1       | FREQ=WEEKLY; INTERVAL=1 |    14400 | used to auto gather table stats |
| root@% | MONDAY_WINDOW    | 1       | FREQ=WEEKLY; INTERVAL=1 |    14400 | used to auto gather table stats |
| root@% | SATURDAY_WINDOW  | 1       | FREQ=WEEKLY; INTERVAL=1 |    14400 | used to auto gather table stats |
| root@% | SUNDAY_WINDOW    | 1       | FREQ=WEEKLY; INTERVAL=1 |    14400 | used to auto gather table stats |
| root@% | THURSDAY_WINDOW  | 1       | FREQ=WEEKLY; INTERVAL=1 |    14400 | used to auto gather table stats |
| root@% | TUESDAY_WINDOW   | 1       | FREQ=WEEKLY; INTERVAL=1 |    14400 | used to auto gather table stats |
| root@% | WEDNESDAY_WINDOW | 1       | FREQ=WEEKLY; INTERVAL=1 |    14400 | used to auto gather table stats |
+--------+------------------+---------+-------------------------+----------+---------------------------------+

call dbms_scheduler.disable('MONDAY_WINDOW');
call dbms_scheduler.disable('FRIDAY_WINDOW');
select OWNER,JOB_NAME,ENABLED from oceanbase.dba_scheduler_jobs where JOB_NAME in ('FRIDAY_WINDOW','MONDAY_WINDOW','OPT_STATS_HISTORY_MANAGER','SATURDAY_WINDOW','SUNDAY_WINDOW','THURSDAY_WINDOW','TUESDAY_WINDOW','WEDNESDAY_WINDOW');
+--------+---------------------------+---------+
| OWNER  | JOB_NAME                  | ENABLED |
+--------+---------------------------+---------+
| root@% | FRIDAY_WINDOW             | 0       |
| root@% | MONDAY_WINDOW             | 0       |
| root@% | OPT_STATS_HISTORY_MANAGER | 1       |
| root@% | SATURDAY_WINDOW           | 1       |
| root@% | SUNDAY_WINDOW             | 1       |
| root@% | THURSDAY_WINDOW           | 1       |
| root@% | TUESDAY_WINDOW            | 1       |
| root@% | WEDNESDAY_WINDOW          | 1       |
+--------+---------------------------+---------+

call dbms_scheduler.enable('MONDAY_WINDOW');
call dbms_scheduler.enable('FRIDAY_WINDOW');
select OWNER,JOB_NAME,ENABLED from oceanbase.dba_scheduler_jobs where JOB_NAME in ('FRIDAY_WINDOW','MONDAY_WINDOW');
+--------+---------------+---------+
| OWNER  | JOB_NAME      | ENABLED |
+--------+---------------+---------+
| root@% | FRIDAY_WINDOW | 1       |
| root@% | MONDAY_WINDOW | 1       |
+--------+---------------+---------+

drop table if exists t1, t_part, t_subpart;
create table t1 (c1 int, c2 int, c3 int);
create index idx1_t1 on t1(c2);

create table t_part (c1 int primary key, c2 int, c3 int) partition by hash(c1) partitions 4;
create index idx1_part on t_part(c2);

create table t_subpart (c1 int, c2 int, c3 int) partition by hash(c1)
subpartition by hash(c2)
subpartition template
(
  subpartition p0,
  subpartition p1,
  subpartition p2
)
partitions 3;
create index idx1_subpart on t_subpart(c2) local;

insert into t1 values(1,1,1), (2,2,2), (3,3,3), (4,4,4), (5,5,5), (6,6,6), (7,7,7), (8,8,8), (9,9,9), (10,10,10);
insert into t1 values(11,1,1), (12,2,2), (13,3,3), (14,4,4), (15,5,5), (16,6,6), (17,7,7), (18,8,8), (19,9,9), (20,10,10);
insert into t1 values(21,1,1), (22,2,2), (23,3,3), (24,4,4), (25,5,5), (26,6,6), (27,7,7), (28,8,8), (29,9,9), (30,10,10);
insert into t1 values(31,1,1), (32,2,2), (33,3,3), (34,4,4), (35,5,5), (36,6,6), (37,7,7), (38,8,8), (39,9,9), (40,10,10);
insert into t1 values(41,1,1), (42,2,2), (43,3,3), (44,4,4), (45,5,5), (46,6,6), (47,7,7), (48,8,8), (49,9,9), (50,10,10);
insert into t1 values(51,1,1), (52,2,2), (53,3,3), (54,4,4), (55,5,5), (56,6,6), (57,7,7), (58,8,8), (59,9,9), (60,10,10);
insert into t1 values(61,1,1), (62,2,2), (63,3,3), (64,4,4), (65,5,5), (66,6,6), (67,7,7), (68,8,8), (69,9,9), (70,10,10);
insert into t1 values(71,1,1), (72,2,2), (73,3,3), (74,4,4), (75,5,5), (76,6,6), (77,7,7), (78,8,8), (79,9,9), (80,10,10);
insert into t1 values(81,1,1), (82,2,2), (83,3,3), (84,4,4), (85,5,5), (86,6,6), (87,7,7), (88,8,8), (89,9,9), (90,10,10);
insert into t1 values(91,1,1), (92,2,2), (93,3,3), (94,4,4), (95,5,5), (96,6,6), (97,7,7), (98,8,8), (99,9,9), (100,10,10);

insert into t_part values(101,1,1), (102,2,2), (103,3,3), (104,4,4), (105,5,5), (106,6,6), (107,7,7), (108,8,8), (109,9,9), (110,10,10);
insert into t_part values(111,1,1), (112,2,2), (113,3,3), (114,4,4), (115,5,5), (116,6,6), (117,7,7), (118,8,8), (119,9,9), (120,10,10);
insert into t_part values(121,1,1), (122,2,2), (123,3,3), (124,4,4), (125,5,5), (126,6,6), (127,7,7), (128,8,8), (129,9,9), (130,10,10);
insert into t_part values(131,1,1), (132,2,2), (133,3,3), (134,4,4), (135,5,5), (136,6,6), (137,7,7), (138,8,8), (139,9,9), (140,10,10);
insert into t_part values(141,1,1), (142,2,2), (143,3,3), (144,4,4), (145,5,5), (146,6,6), (147,7,7), (148,8,8), (149,9,9), (150,10,10);
insert into t_part values(151,1,1), (152,2,2), (153,3,3), (154,4,4), (155,5,5), (156,6,6), (157,7,7), (158,8,8), (159,9,9), (160,10,10);
insert into t_part values(161,1,1), (162,2,2), (163,3,3), (164,4,4), (165,5,5), (166,6,6), (167,7,7), (168,8,8), (169,9,9), (170,10,10);
insert into t_part values(171,1,1), (172,2,2), (173,3,3), (174,4,4), (175,5,5), (176,6,6), (177,7,7), (178,8,8), (179,9,9), (180,10,10);
insert into t_part values(181,1,1), (182,2,2), (183,3,3), (184,4,4), (185,5,5), (186,6,6), (187,7,7), (188,8,8), (189,9,9), (190,10,10);
insert into t_part values(191,1,1), (192,2,2), (193,3,3), (194,4,4), (195,5,5), (196,6,6), (197,7,7), (198,8,8), (199,9,9), (200,10,10);

insert into t_part select c1%100,c2,c3 from t_part;
insert into t_part select c1+1000,c2,c3 from t_part;
insert into t_part select c1+10000,c2,c3 from t_part;

insert into t_subpart select * from t_part;
insert into t_subpart select * from t_subpart;
insert into t_subpart select * from t_subpart;
insert into t_subpart select * from t_subpart;

##the dml statistics are recorded in memtable and reported periodically to dba_tab_modifications, we must use minor freeze to report the residual statistics
alter system minor freeze;

set stat maintenance attribute window auto gather table stats after 15 second.
select TABLE_NAME, partition_name, subpartition_name, OBJECT_TYPE, NUM_ROWS, AVG_ROW_LEN, SAMPLE_SIZE from oceanbase.DBA_TAB_STATISTICS where table_name in ('T1','T_PART','T_SUBPART') and OWNER = 'TEST';
+------------+----------------+-------------------+--------------+----------+-------------+-------------+
| TABLE_NAME | partition_name | subpartition_name | OBJECT_TYPE  | NUM_ROWS | AVG_ROW_LEN | SAMPLE_SIZE |
+------------+----------------+-------------------+--------------+----------+-------------+-------------+
| t1         | NULL           | NULL              | TABLE        |     NULL |        NULL |        NULL |
| t_part     | NULL           | NULL              | TABLE        |     NULL |        NULL |        NULL |
| t_part     | p0             | NULL              | PARTITION    |     NULL |        NULL |        NULL |
| t_part     | p1             | NULL              | PARTITION    |     NULL |        NULL |        NULL |
| t_part     | p2             | NULL              | PARTITION    |     NULL |        NULL |        NULL |
| t_part     | p3             | NULL              | PARTITION    |     NULL |        NULL |        NULL |
| t_subpart  | NULL           | NULL              | TABLE        |     NULL |        NULL |        NULL |
| t_subpart  | p0             | NULL              | PARTITION    |     NULL |        NULL |        NULL |
| t_subpart  | p0             | p0sp0             | SUBPARTITION |     NULL |        NULL |        NULL |
| t_subpart  | p0             | p0sp1             | SUBPARTITION |     NULL |        NULL |        NULL |
| t_subpart  | p0             | p0sp2             | SUBPARTITION |     NULL |        NULL |        NULL |
| t_subpart  | p1             | NULL              | PARTITION    |     NULL |        NULL |        NULL |
| t_subpart  | p1             | p1sp0             | SUBPARTITION |     NULL |        NULL |        NULL |
| t_subpart  | p1             | p1sp1             | SUBPARTITION |     NULL |        NULL |        NULL |
| t_subpart  | p1             | p1sp2             | SUBPARTITION |     NULL |        NULL |        NULL |
| t_subpart  | p2             | NULL              | PARTITION    |     NULL |        NULL |        NULL |
| t_subpart  | p2             | p2sp0             | SUBPARTITION |     NULL |        NULL |        NULL |
| t_subpart  | p2             | p2sp1             | SUBPARTITION |     NULL |        NULL |        NULL |
| t_subpart  | p2             | p2sp2             | SUBPARTITION |     NULL |        NULL |        NULL |
+------------+----------------+-------------------+--------------+----------+-------------+-------------+
##wait auto gather table stats finish
select TABLE_NAME, partition_name, subpartition_name, OBJECT_TYPE, NUM_ROWS, AVG_ROW_LEN, SAMPLE_SIZE from oceanbase.DBA_TAB_STATISTICS where table_name in ('T1','T_PART','T_SUBPART') and OWNER = 'TEST';
+------------+----------------+-------------------+--------------+----------+-------------+-------------+
| TABLE_NAME | partition_name | subpartition_name | OBJECT_TYPE  | NUM_ROWS | AVG_ROW_LEN | SAMPLE_SIZE |
+------------+----------------+-------------------+--------------+----------+-------------+-------------+
| t1         | NULL           | NULL              | TABLE        |      100 |          60 |         100 |
| t_part     | NULL           | NULL              | TABLE        |      800 |          60 |         800 |
| t_part     | p0             | NULL              | PARTITION    |      200 |          60 |         200 |
| t_part     | p1             | NULL              | PARTITION    |      200 |          60 |         200 |
| t_part     | p2             | NULL              | PARTITION    |      200 |          60 |         200 |
| t_part     | p3             | NULL              | PARTITION    |      200 |          60 |         200 |
| t_subpart  | NULL           | NULL              | TABLE        |     6400 |          60 |        6400 |
| t_subpart  | p0             | NULL              | PARTITION    |     2136 |          60 |        2136 |
| t_subpart  | p0             | p0sp0             | SUBPARTITION |      624 |          60 |         624 |
| t_subpart  | p0             | p0sp1             | SUBPARTITION |      864 |          60 |         864 |
| t_subpart  | p0             | p0sp2             | SUBPARTITION |      648 |          60 |         648 |
| t_subpart  | p1             | NULL              | PARTITION    |     2136 |          60 |        2136 |
| t_subpart  | p1             | p1sp0             | SUBPARTITION |      648 |          60 |         648 |
| t_subpart  | p1             | p1sp1             | SUBPARTITION |      840 |          60 |         840 |
| t_subpart  | p1             | p1sp2             | SUBPARTITION |      648 |          60 |         648 |
| t_subpart  | p2             | NULL              | PARTITION    |     2128 |          60 |        2128 |
| t_subpart  | p2             | p2sp0             | SUBPARTITION |      648 |          60 |         648 |
| t_subpart  | p2             | p2sp1             | SUBPARTITION |      856 |          60 |         856 |
| t_subpart  | p2             | p2sp2             | SUBPARTITION |      624 |          60 |         624 |
+------------+----------------+-------------------+--------------+----------+-------------+-------------+

select TABLE_OWNER,TABLE_NAME,PARTITION_NAME,SUBPARTITION_NAME,INSERTS,UPDATES,DELETES from oceanbase.dba_tab_modifications where TABLE_OWNER='TEST' and table_name in ('T1','T_PART','T_SUBPART');
+-------------+------------+----------------+-------------------+---------+---------+---------+
| TABLE_OWNER | TABLE_NAME | PARTITION_NAME | SUBPARTITION_NAME | INSERTS | UPDATES | DELETES |
+-------------+------------+----------------+-------------------+---------+---------+---------+
| test        | t1         | NULL           | NULL              |       0 |       0 |       0 |
| test        | t_part     | p0             | NULL              |       0 |       0 |       0 |
| test        | t_part     | p1             | NULL              |       0 |       0 |       0 |
| test        | t_part     | p2             | NULL              |       0 |       0 |       0 |
| test        | t_part     | p3             | NULL              |       0 |       0 |       0 |
| test        | t_subpart  | NULL           | p0sp0             |       0 |       0 |       0 |
| test        | t_subpart  | NULL           | p0sp1             |       0 |       0 |       0 |
| test        | t_subpart  | NULL           | p0sp2             |       0 |       0 |       0 |
| test        | t_subpart  | NULL           | p1sp0             |       0 |       0 |       0 |
| test        | t_subpart  | NULL           | p1sp1             |       0 |       0 |       0 |
| test        | t_subpart  | NULL           | p1sp2             |       0 |       0 |       0 |
| test        | t_subpart  | NULL           | p2sp0             |       0 |       0 |       0 |
| test        | t_subpart  | NULL           | p2sp1             |       0 |       0 |       0 |
| test        | t_subpart  | NULL           | p2sp2             |       0 |       0 |       0 |
+-------------+------------+----------------+-------------------+---------+---------+---------+
select DATEDIFF(next_date, start_date) from oceanbase.__all_tenant_scheduler_job where (this_date is not null or last_date is not null) and JOB_NAME in ('FRIDAY_WINDOW','MONDAY_WINDOW','OPT_STATS_HISTORY_MANAGER','SATURDAY_WINDOW','SUNDAY_WINDOW','THURSDAY_WINDOW','TUESDAY_WINDOW','WEDNESDAY_WINDOW');
+---------------------------------+
| DATEDIFF(next_date, start_date) |
+---------------------------------+
|                               7 |
+---------------------------------+
drop table t1;
drop table t_part;
drop table t_subpart;
drop user if exists root@'127.0.0.1';
drop user if exists root@'127.0.1.1';
drop user if exists root@'127.1.1.1';

##drop tenant

alter system set_tp tp_no = 368, error_code = 4016, frequency = 1;
