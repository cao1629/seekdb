# owner: yunshan.tys
# owner group: storage
# description test index view with fulltext index

connect(sys_conn, $OBMYSQL_MS0, root@sys,,oceanbase, $OBMYSQL_PORT);
connection sys_conn;

--enable_query_log
--disable_warnings
CREATE DATABASE IF NOT EXISTS fts_index_view_test;
--enable_warnings
USE fts_index_view_test;

--disable_warnings
DROP TABLE IF EXISTS articles;
--enable_warnings

--result_format 3

--disable_warnings
CREATE TABLE articles(
    id INT UNSIGNED AUTO_INCREMENT,
    tid INT,
    title VARCHAR(200),
    content TEXT,
    PRIMARY KEY(id, tid),
    FULLTEXT INDEX ctx1(title, content),
    FULLTEXT INDEX ctx2(title, content),
    FULLTEXT INDEX ctx3(title, content),
    INDEX idx1(title) global,
    INDEX idx2(title, id) local
) PARTITION BY HASH(id) PARTITIONS 3 SUBPARTITION BY HASH(tid) SUBPARTITIONS 2;
--enable_warnings

INSERT INTO articles (tid, title, content) VALUES
(3, 'OceanBase Tutorial', 'This is a tutorial about Oceanbase Fulltext.'),
(1, 'Fulltext Index', 'Fulltext index can be very useful.'),
(2, 'OceanBase Test Case', 'Writing test cases helps ensure quality.');

--disable_warnings
DROP TABLE IF EXISTS t_multivalue;
--enable_warnings

CREATE TABLE t_multivalue(
    c1 int PRIMARY KEY,
    id BIGINT not null,
    modified BIGINT not null,
    custinfo JSON,
    INDEX multi_zips((CAST(custinfo->'$.zipcode' AS UNSIGNED ARRAY)))
) PARTITION BY HASH(c1) PARTITIONS 3;

connection sys_conn;

--replace_regex /_[0-9]+/_*/
SELECT * FROM information_schema.STATISTICS WHERE TABLE_SCHEMA = 'fts_index_view_test' order by INDEX_NAME, COLUMN_NAME;

--replace_regex /_[0-9]+/_*/
SELECT * FROM oceanbase.CDB_INDEXES WHERE OWNER = 'fts_index_view_test' order by INDEX_NAME;

SELECT * FROM oceanbase.CDB_PART_KEY_COLUMNS WHERE OWNER = 'fts_index_view_test' order by OBJECT_TYPE, COLUMN_NAME;

SELECT * FROM oceanbase.CDB_SUBPART_KEY_COLUMNS WHERE OWNER = 'fts_index_view_test' order by OBJECT_TYPE, COLUMN_NAME;

SELECT * FROM oceanbase.CDB_PART_INDEXES WHERE OWNER = 'fts_index_view_test' order by INDEX_NAME;

SELECT * FROM oceanbase.DBA_PART_KEY_COLUMNS WHERE OWNER = 'fts_index_view_test' order by NAME;

SELECT * FROM oceanbase.DBA_SUBPART_KEY_COLUMNS WHERE OWNER = 'fts_index_view_test' order by OBJECT_TYPE, COLUMN_NAME;

SELECT * FROM oceanbase.DBA_PART_INDEXES WHERE OWNER = 'fts_index_view_test' order by INDEX_NAME;

SELECT * FROM oceanbase.DBA_IND_STATISTICS WHERE OWNER = 'fts_index_view_test' order by INDEX_NAME, PARTITION_POSITION, SUBPARTITION_POSITION;

#connect(sys_ora,$OBMYSQL_MS0,sys@oracle,,sys,$OBMYSQL_PORT);
#connection sys_ora;
#
## TODO: @jinzhu remove me later, after implement fulltext search in Oracle mode.
#CREATE TABLE fts_index_view_test (
#    id NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
#    tid INT,
#    title VARCHAR2(200),
#    content CLOB,
#    PRIMARY KEY (id, tid)
#)
#PARTITION BY HASH (id) PARTITIONS 3;
#
## TODO: @jinzhu remove me later, after implement fulltext search in Oracle mode.
#
#CREATE INDEX idx1 ON fts_index_view_test(title) global;
#
#CREATE INDEX idx2 ON fts_index_view_test(title, id) local;
#
#INSERT INTO fts_index_view_test (tid, title, content) VALUES
#(3, 'OceanBase Tutorial', 'This is a tutorial about Oceanbase Fulltext.'),
#(1, 'Fulltext Index', 'Fulltext index can be very useful.'),
#(2, 'OceanBase Test Case', 'Writing test cases helps ensure quality.');
#
#--replace_regex /_[0-9]+/_*/
#SELECT * FROM SYS.DBA_INDEXES WHERE TABLE_NAME = 'FTS_INDEX_VIEW_TEST' order by INDEX_NAME;
#
#--replace_regex /_[0-9]+/_*/
#SELECT * FROM SYS.ALL_INDEXES WHERE TABLE_NAME = 'FTS_INDEX_VIEW_TEST' order by INDEX_NAME;
#
#--replace_regex /_[0-9]+/_*/
#SELECT * FROM SYS.USER_INDEXES WHERE TABLE_NAME = 'FTS_INDEX_VIEW_TEST' order by INDEX_NAME;
#
#DROP TABLE fts_index_view_test;
