# owner: saitong.zst
# owner group: storage
# description: basic text retrieval query with fulltext index

--disable_warnings
drop database if exists fts;
create database fts;
use fts;
--enable_warnings

create table t_ir_single_column(
  seq int PRIMARY KEY,
  digest varchar(512),
  detail varchar(4096),
  fulltext index i1(detail)) partition by hash(seq) partitions 2;

create table t_dim_table(
    seq int,
    log varchar(1024));

insert into t_ir_single_column (seq, digest, detail) values
    (0, "Gerard Salton", "Gerard A. Gerry Salton (8 March 1927 – 28 August 1995) was a professor of Computer Science at Cornell University. Salton was perhaps the leading computer scientist working in the field of information retrieval during his time, and the father of Information Retrieval"),
    (1, "Edgar F. Codd", "Edgar Frank Ted Codd (19 August 1923 – 18 April 2003) was an English computer scientist who, while working for IBM, invented the relational model for database management, the theoretical basis for relational databases and relational database management systems. "),
    (2, "Michael Stonebraker", "Michael Ralph Stonebraker (born October 11, 1943[6]) is a computer scientist specializing in database systems. Through a series of academic prototypes and commercial startups, Stonebraker's research and products are central to many relational databases. "),
    (3, "Geoffrey Hinton", "Geoffrey Everest Hinton CC FRS FRSC (born 6 December 1947) is a British-Canadian computer scientist and cognitive psychologist, most noted for his work on artificial neural networks."),
    (4, "Yann LeCun", "Yann André LeCun[1] (born 8 July 1960) is a Turing Award winning French computer scientist working primarily in the fields of machine learning, computer vision, mobile robotics and computational neuroscience."),
    (5, "Ken Thompson", "Kenneth Lane Thompson (born February 4, 1943) is an American pioneer of computer science. Thompson worked at Bell Labs for most of his career where he designed and implemented the original Unix operating system. "),
    (6, "Gordon Plotkin", "Gordon David Plotkin, FRS FRSE MAE (born 9 September 1946) is a theoretical computer scientist in the School of Informatics at the University of Edinburgh. Plotkin is probably best known for his introduction of structural operational semantics (SOS) and his work on denotational semantics."),
    (7, "Leslie Lamport", "Leslie B. Lamport (born February 7, 1941) is an American computer scientist and mathematician. Lamport is best known for his seminal work in distributed systems, and as the initial developer of the document preparation system LaTeX");

insert into t_dim_table (seq, log) values
    (1, "Codd log"),
    (3, "Hinton log"),
    (5, "Ken log"),
    (7, "Lamport log"),
    (9, "someone's log");

--result_format 4

select seq, digest from t_ir_single_column partition(p0);

select seq, digest from t_ir_single_column partition(p1);

set ob_enable_index_direct_select = 'ON';

--disable_query_log

let $data_table_id_single = query_get_value("SELECT table_id FROM oceanbase.__all_virtual_table A, oceanbase.__all_database B WHERE A.table_name = 't_ir_single_column' and A.database_id = B.database_id and database_name = 'fts'", table_id, 1);
let $fts_index_table_name_single = query_get_value(SELECT table_name FROM oceanbase.__all_virtual_table WHERE table_name like '%_fts_index' AND data_table_id = $data_table_id_single, table_name, 1);
# eval select * from $fts_index_table_name_single partition(p0);
# eval select * from $fts_index_table_name_single partition(p1);

--enable_query_log

explain select digest, detail from t_ir_single_column where match (detail) against ("database");
explain /*+ use_das(t_ir_single_column) */ select digest, detail from t_ir_single_column where match (detail) against ("database");

select digest, detail from t_ir_single_column where match (detail) against ("distributed database");
select /*+ use_das(t_ir_single_column) */ digest, detail from t_ir_single_column where match (detail) against ("distributed database");

select digest, detail from t_ir_single_column where match (detail) against ("database");
select /*+ use_das(t_ir_single_column) */ digest, detail from t_ir_single_column where match (detail) against ("database");

select digest, detail from t_ir_single_column where match (detail) against ("computer");
select /*+ use_das(t_ir_single_column) */ digest, detail from t_ir_single_column where match (detail) against ("computer");

select digest, match (detail) against ("computer") as relevance from t_ir_single_column where match (detail) against ("computer") > 0.12 order by relevance desc;
select digest, match (detail) against ("computer") as relevance from t_ir_single_column where match (detail) against ("computer") < 0.12 order by relevance desc;
select digest, match (detail) against ("computer") as relevance from t_ir_single_column where match (detail) against ("computer") = 0 order by relevance desc;

explain
select
    digest, match (detail) against ("database") as relevance
from
    t_ir_single_column
where
    match (detail) against ("database")
order by relevance desc;

select
    digest, match (detail) against ("database") as relevance
from
    t_ir_single_column
where
    match (detail) against ("database")
order by relevance desc;



select
    digest, match (detail) against ("computer") as relevance
from
    t_ir_single_column
where
    match (detail) against ("computer")
order by relevance desc;

explain
select /*+ use_das(t_ir_single_column) */
    digest, match (detail) against ("computer") as relevance
from
    t_ir_single_column
where
    match (detail) against ("computer")
order by relevance desc;

select /*+ use_das(t_ir_single_column) */
    digest, match (detail) against ("computer") as relevance
from
    t_ir_single_column
where
    match (detail) against ("computer")
order by relevance desc;


explain
select
    digest, match (detail) against ("computer") as relevance
from
    t_ir_single_column
where
    match (detail) against ("computer")
order by relevance desc
limit 4;

select
    digest, match (detail) against ("computer") as relevance
from
    t_ir_single_column
where
    match (detail) against ("computer")
order by relevance desc
limit 4;

explain
select /*+ use_das(t_ir_single_column) */
    digest, match (detail) against ("computer") as relevance
from
    t_ir_single_column
where
    match (detail) against ("computer")
order by relevance desc
limit 4;

select /*+ use_das(t_ir_single_column) */
    digest, match (detail) against ("computer") as relevance
from
    t_ir_single_column
where
    match (detail) against ("computer")
order by relevance desc
limit 4;

explain
select
    digest, seq, match (detail) against ("scientist") as relevance
from
    t_ir_single_column
where
    match (detail) against ("scientist") and seq < 4
order by relevance desc, seq desc;

select
    digest, seq, match (detail) against ("scientist") as relevance
from
    t_ir_single_column
where
    match (detail) against ("scientist") and seq < 4
order by relevance desc, seq desc;

select
    digest, seq, match (detail) against ("scientist") as relevance
from
    t_ir_single_column
where
    match (detail) against ("scientist") and seq >= 4;

select
    digest, seq, match (detail) against ("scientist") as relevance
from
    t_ir_single_column
where
    match (detail) against ("scientist") and digest = "Ken Thompson";

select
    digest, seq, match (detail) against ("scientist") as relevance
from
    t_ir_single_column
where
    match (detail) against ("scientist") and digest = "Yann LeCun";

explain
select
    digest, seq, match (detail) against ("scientist") as relevance
from
    t_ir_single_column
where
    match (detail) against ("scientist") and digest like "%Ken%";

select
    digest, seq, match (detail) against ("scientist") as relevance
from
    t_ir_single_column
where
    match (detail) against ("scientist") and digest like "%Ken%";

select
    digest, seq, match (detail) against ("scientist") as relevance
from
    t_ir_single_column
where
    match (detail) against ("scientist") and digest like "%LeCun%";

select
    digest, match (detail) against ("distributed database") as relevance
from
    t_ir_single_column
where
    match (detail) against ("distributed database")
order by
    relevance desc;

select
    digest, match (detail) against ("relational database") as relevance
from
    t_ir_single_column
where
    match (detail) against ("relational database")
order by
    relevance desc;

select
    digest, match (detail) against ("relational distributed database") as relevance
from
    t_ir_single_column
where
    match (detail) against ("relational distributed database")
order by
    relevance desc;

select
    digest, match (detail) against ("distributed relational database") as relevance
from
    t_ir_single_column
where
    match (detail) against ("distributed relational database")
order by
    relevance desc;

select
    digest, match (detail) against ("distributed relational database") as relevance
from
    t_ir_single_column
where
    match (detail) against ("distributed relational database")
limit 2;

select /*+ use_das(t_ir_single_column) */
    digest, match (detail) against ("distributed relational database") as relevance
from
    t_ir_single_column
where
    match (detail) against ("distributed relational database")
limit 2;

# join
explain
select
    t_ir_single_column.digest, t_dim_table.seq as seq, t_dim_table.log as log , match (detail) against ("computer") as score
from
    t_ir_single_column, t_dim_table
where
    t_ir_single_column.seq = t_dim_table.seq and match (detail) against ("computer")
order by
    score desc;

select
    t_ir_single_column.digest, t_dim_table.seq as seq, t_dim_table.log as log , match (detail) against ("computer") as score
from
    t_ir_single_column, t_dim_table
where
    t_ir_single_column.seq = t_dim_table.seq and match (detail) against ("computer")
order by
    score desc;

explain
select /*+ use_das(t_ir_single_column) */
    t_ir_single_column.digest, t_dim_table.seq as seq, t_dim_table.log as log , match (detail) against ("computer") as score
from
    t_ir_single_column, t_dim_table
where
    t_ir_single_column.seq = t_dim_table.seq and match (detail) against ("computer")
order by
    score desc;

select /*+ use_das(t_ir_single_column) */
    t_ir_single_column.digest, t_dim_table.seq as seq, t_dim_table.log as log , match (detail) against ("computer") as score
from
    t_ir_single_column, t_dim_table
where
    t_ir_single_column.seq = t_dim_table.seq and match (detail) against ("computer")
order by
    score desc;

explain
select /*+ use_das(t_ir_single_column), use_das(t_dim_table) */
    t_ir_single_column.digest, t_dim_table.seq as seq, t_dim_table.log as log , match (detail) against ("computer") as score
from
    t_ir_single_column, t_dim_table
where
    t_ir_single_column.seq = t_dim_table.seq and match (detail) against ("computer")
order by
    score desc;

select /*+ use_das(t_ir_single_column), use_das(t_dim_table) */
    t_ir_single_column.digest, t_dim_table.seq as seq, t_dim_table.log as log , match (detail) against ("computer") as score
from
    t_ir_single_column, t_dim_table
where
    t_ir_single_column.seq = t_dim_table.seq and match (detail) against ("computer")
order by
    score desc;

explain
select /*+ use_das(t_ir_single_column) */
    t_ir_single_column.digest, t_ir_single_column.seq, t_dim_table.seq, t_dim_table.log as log , match (detail) against ("computer") as score
from
    t_ir_single_column, t_dim_table
where
    t_ir_single_column.seq < t_dim_table.seq and match (detail) against ("computer")
order by
    t_ir_single_column.seq, t_dim_table.seq;

select /*+ use_das(t_ir_single_column) */
    t_ir_single_column.digest, t_ir_single_column.seq, t_dim_table.seq, t_dim_table.log as log , match (detail) against ("computer") as score
from
    t_ir_single_column, t_dim_table
where
    t_ir_single_column.seq < t_dim_table.seq and match (detail) against ("computer")
order by
    t_ir_single_column.seq, t_dim_table.seq;

explain select distinct 1 from t_ir_single_column where match (detail) against ("distributed database");
select distinct 1 from t_ir_single_column where match (detail) against ("distributed database");

explain select /*+ use_das(t_ir_single_column) */ distinct 1 from t_ir_single_column where match (detail) against ("distributed database");
select /*+ use_das(t_ir_single_column) */ distinct 1 from t_ir_single_column where match (detail) against ("distributed database");

explain select distinct digest from t_ir_single_column where match (detail) against ("distributed database");
select distinct digest from t_ir_single_column where match (detail) against ("distributed database");

explain select /*+ use_das(t_ir_single_column) */ distinct digest from t_ir_single_column where match (detail) against ("distributed database");
select /*+ use_das(t_ir_single_column) */ distinct digest from t_ir_single_column where match (detail) against ("distributed database");

explain select (select digest from t_ir_single_column limit 1) as d1 from t_ir_single_column where match (detail) against ("distributed database") and seq > 1 ;
select (select digest from t_ir_single_column limit 1) as d1 from t_ir_single_column where match (detail) against ("distributed database") and seq > 1 ;

explain select distinct (select digest from t_ir_single_column limit 1) as d1 from t_ir_single_column where match (detail) against ("distributed database") and seq > 1;
select distinct (select digest from t_ir_single_column limit 1) as d1 from t_ir_single_column where match (detail) against ("distributed database") and seq > 1;

explain select /*+ use_das(t_ir_single_column) */ distinct (select digest from t_ir_single_column limit 1) as d1 from t_ir_single_column where match (detail) against ("distributed database") and seq > 1;
select /*+ use_das(t_ir_single_column) */ distinct (select digest from t_ir_single_column limit 1) as d1 from t_ir_single_column where match (detail) against ("distributed database") and seq > 1;

--disable_warnings
drop table if exists t_ir_single_column;
drop table if exists t_dim_table;
--enable_warnings

--disable_query_log
--disable_result_log
connect (conn_admin, $OBMYSQL_MS0,admin,$OBMYSQL_PWD,test,$OBMYSQL_PORT);
connection conn_admin;
let $old_primary_zone=query_get_value(select primary_zone from oceanbase.__all_tenant where tenant_name='sys',primary_zone,1);
alter tenant sys set primary_zone='RANDOM';
sleep 3;
connection default;
--enable_result_log
--enable_query_log

--disable_warnings
drop table if exists t_many_partitions;
--enable_warnings

create table t_many_partitions(
  seq int primary key,
  digest varchar(512),
  detail varchar(4096),
  fulltext index i1(detail)) partition by hash(seq) partitions 20;

insert into t_many_partitions (seq, digest, detail) values
    (1, 'digest', 'detail one'),
    (2, 'digest', 'detail two'),
    (3, 'digest', 'detail three'),
    (4, 'digest', 'detail four');
insert into t_many_partitions select seq + 8, digest, concat(detail, ' ', detail) from t_many_partitions;
insert into t_many_partitions select seq + 16, digest, concat(detail, ' ', detail, ' ', detail) from t_many_partitions;

select * from t_many_partitions where match(detail) against ('three') limit 3;
select /*+ use_das(t_many_partitions) */ * from t_many_partitions where match(detail) against ('three') limit 3;

select * from t_many_partitions where match(detail) against ('') limit 3;
select /*+ use_das(t_many_partitions) */ * from t_many_partitions where match(detail) against ('') limit 3;

--disable_warnings
drop table if exists t_many_partitions;
--enable_warnings

--disable_query_log
--disable_result_log
connection conn_admin;
eval alter tenant sys set primary_zone='$old_primary_zone';
connection default;
--enable_result_log
--enable_query_log

drop database fts;
