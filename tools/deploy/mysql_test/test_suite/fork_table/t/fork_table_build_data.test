##owner: fankun.fan
##owner group: 底层引擎部-轻量版
##description: Fork Table前置DDL后数据一致性测试
##tags: fork_table ddl data
##author: fankun.fan

--disable_warnings
drop database if exists db_fork_data;
--enable_warnings

connect (obsys,$OBMYSQL_MS0,root@sys,,oceanbase,$OBMYSQL_PORT);
connection default;
create database db_fork_data;
use db_fork_data;

SET wait_timeout=30000000;
SET ob_trx_timeout = 100000000;
SET ob_query_timeout = 100000000;

--echo # 加速major freeze
--source mysql_test/test_suite/fork_table/include/quick_major.inc

--echo ============================================
--echo 1. 源表删列后执行Fork Table
--echo ============================================

drop table if exists t1;
drop table if exists t1_fork;

create table t1 (
    id int primary key,
    c1 varchar(20),
    c2 int,
    drop_col varchar(20)
) partition by range(id) (
    partition p0 values less than (100),
    partition p1 values less than (200)
);

insert into t1 values (1, 'a', 10, 'd1');
insert into t1 values (101, 'b', 20, 'd2');

--echo # 先在源表删列
alter table t1 drop column drop_col;

--echo # 源表结构确认
--replace_regex /REPLICA_NUM = [0-9]*/REPLICA_NUM = replica_num/g
show create table t1;

--echo # Fork表
fork table t1 to t1_fork;
--source mysql_test/test_suite/fork_table/include/wait_fork_table.inc

--echo # 目标表结构应不包含被删除列
--replace_regex /REPLICA_NUM = [0-9]*/REPLICA_NUM = replica_num/g
show create table t1_fork;

--echo # 目标表数据应与删列后的源表一致
select * from t1_fork order by id;

--echo # 触发major freeze并等待完成，验证不会卡住
connection obsys;
alter system major freeze;
connection default;
--source mysql_test/test_suite/fork_table/include/wait_daily_merge.inc

--echo ============================================
--echo 2. Major Freeze后删列再Fork
--echo ============================================

drop table if exists t2;
drop table if exists t2_fork;

create table t2 (
    id int primary key,
    c1 varchar(20),
    c2 int,
    drop_col varchar(20)
) partition by range(id) (
    partition p0 values less than (100),
    partition p1 values less than (200)
);

insert into t2 values (1, 'a1', 10, 'd1');
insert into t2 values (101, 'b1', 20, 'd2');

--echo # 先触发major freeze并等待完成
connection obsys;
alter system major freeze;
connection default;
--source mysql_test/test_suite/fork_table/include/wait_daily_merge.inc

--echo # 再插入两行数据
insert into t2 values (2, 'a2', 30, 'd3');
insert into t2 values (102, 'b2', 40, 'd4');

--echo # 执行删列
alter table t2 drop column drop_col;

--echo # Fork表
fork table t2 to t2_fork;
--source mysql_test/test_suite/fork_table/include/wait_fork_table.inc

--echo # 再次触发major freeze并等待完成
connection obsys;
alter system major freeze;
connection default;
--source mysql_test/test_suite/fork_table/include/wait_daily_merge.inc

--echo # 目标表数据校验
select * from t2_fork order by id;

--echo ============================================
--echo 3. 清理
--echo ============================================

drop table if exists t1;
drop table if exists t1_fork;
drop table if exists t2;
drop table if exists t2_fork;
drop database if exists db_fork_data;
