##owner: fankun.fan
##owner group: 底层引擎部-轻量版
##description: Fork Table权限测试 - 验证fork table不会自动迁移权限，需要手动授权
##tags: fork_table privilege
##author: fankun.fan

--disable_warnings
drop database if exists db_fork_priv;
drop user if exists 'test_user1'@'%';
drop user if exists 'test_user2'@'%';
--enable_warnings

connect (obsys,$OBMYSQL_MS0,root@sys,,oceanbase,$OBMYSQL_PORT);
connection default;
create database db_fork_priv;
use db_fork_priv;

SET wait_timeout=30000000;
SET ob_trx_timeout = 100000000;
SET ob_query_timeout = 100000000;

--echo ============================================
--echo 1. 准备测试环境
--echo ============================================

--echo # 在sys租户下创建测试用户（因为数据库在sys租户下）
connection obsys;
create user 'test_user1'@'%' identified by 'test123';
create user 'test_user2'@'%' identified by 'test123';
connection default;

--echo # 创建源表并插入数据
drop table if exists t_priv;
create table t_priv (
    id int primary key,
    name varchar(50),
    age int
);

insert into t_priv values (1, 'Alice', 25);
insert into t_priv values (2, 'Bob', 30);
insert into t_priv values (3, 'Charlie', 35);

--echo ============================================
--echo 2. 授予用户对原表的权限
--echo ============================================

--echo # 授予test_user1对原表的SELECT权限
grant select on db_fork_priv.t_priv to 'test_user1'@'%';

--echo # 授予test_user2对原表的SELECT和INSERT权限（用于fork操作）
grant select, insert on db_fork_priv.t_priv to 'test_user2'@'%';
grant create on db_fork_priv.* to 'test_user2'@'%';

--echo ============================================
--echo 3. 验证用户对原表的访问权限
--echo ============================================

--echo # test_user1可以查询原表（使用sys租户连接）
connect (conn_user1,$OBMYSQL_MS0,test_user1@sys,test123,db_fork_priv,$OBMYSQL_PORT);
connection conn_user1;
select count(*) as cnt from t_priv;

--echo # test_user2可以查询和插入原表（使用sys租户连接）
connect (conn_user2,$OBMYSQL_MS0,test_user2@sys,test123,db_fork_priv,$OBMYSQL_PORT);
connection conn_user2;
select count(*) as cnt from t_priv;

--echo ============================================
--echo 4. test_user2执行Fork操作
--echo ============================================

fork table t_priv to t_priv_fork;

--echo # 验证Fork表创建成功
--replace_regex /REPLICA_NUM = [0-9]*/REPLICA_NUM = replica_num/g
show create table t_priv_fork;

--echo # 验证Fork表数据（即使是创建fork表的用户，也需要显式授权才能访问）
--error 1142
select * from t_priv_fork order by id;

--echo ============================================
--echo 5. 验证fork table不会自动迁移权限
--echo ============================================

--echo # test_user1对原表有SELECT权限，但对fork表没有权限（权限不会自动迁移）
connection conn_user1;
--error 1142
select * from t_priv_fork order by id;

--echo ============================================
--echo 6. 手动授权后，用户才能访问fork表
--echo ============================================

--echo # 授予test_user1对fork表的SELECT权限
connection default;
grant select on db_fork_priv.t_priv_fork to 'test_user1'@'%';

--echo # 验证授权后可以访问fork表
connection conn_user1;
select * from t_priv_fork order by id;

--echo # test_user1对fork表没有INSERT权限（因为只授予了SELECT权限）
--error 1142
insert into t_priv_fork values (4, 'David', 40);

--echo ============================================
--echo 7. 清理
--echo ============================================

connection default;

--disable_warnings
drop table if exists t_priv;
drop table if exists t_priv_fork;
drop database if exists db_fork_priv;
drop user if exists 'test_user1'@'%';
drop user if exists 'test_user2'@'%';
--enable_warnings

disconnect conn_user1;
disconnect conn_user2;
