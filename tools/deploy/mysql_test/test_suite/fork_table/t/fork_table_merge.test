##owner: fankun.fan
##owner group: 底层引擎部-轻量版
##description: Fork Table在BUILD_DATA阶段触发major merge
##tags: fork_table major_merge build_data
##author: fankun.fan

--disable_warnings
drop database if exists db_fork_major;
--enable_warnings

connect (obsys,$OBMYSQL_MS0,root@sys,,oceanbase,$OBMYSQL_PORT);
connection default;
create database db_fork_major;
use db_fork_major;

SET wait_timeout=30000000;
SET ob_trx_timeout = 100000000;
SET ob_query_timeout = 100000000;

--echo # 启用debug sync
connection obsys;
alter system set debug_sync_timeout = '60s';
sleep 3;
set ob_global_debug_sync = 'reset';
connection default;


--echo # 加速major freeze
--source mysql_test/test_suite/fork_table/include/quick_major.inc


--echo ============================================
--echo 1. Fork在BUILD_DATA阶段触发major merge
--echo ============================================

drop table if exists t1;
drop table if exists t1_fork;

create table t1 (
    id int primary key,
    name varchar(50),
    value int
) partition by range(id) (
    partition p0 values less than (100),
    partition p1 values less than (200)
);

insert into t1 values (1, 'Init1', 100);
insert into t1 values (101, 'Init2', 200);

--echo # 设置debug sync信号，让fork卡在BUILD_DATA阶段
connection obsys;
set ob_global_debug_sync = 'FORK_TABLE_BUILD_DATA wait_for fork_major_signal execute 10000';
sleep 1;
connection default;

--echo # 执行fork命令（会在BUILD_DATA阶段暂停）
fork table t1 to t1_fork;

--echo # 等待fork进入BUILD_DATA阶段
let $wait_status= BUILD_DATA;
--source mysql_test/test_suite/fork_table/include/wait_fork_table.inc

--echo # 在BUILD_DATA阶段向源表插入数据
insert into t1 values (50, 'After_Fork', 300);
insert into t1 values (150, 'After_Fork2', 400);

--echo # 触发major merge（不等待完成）
connection obsys;
alter system major freeze;
connection default;

--echo # 校验源表tablet级major merge完成（fork仍停在BUILD_DATA）
connection obsys;
--disable_query_log
--disable_result_log
let $table_id = `select table_id from oceanbase.__all_virtual_table where table_name = 't1' limit 1`;
let $tablet_cnt = `select count(*) as c from oceanbase.__all_virtual_tablet_to_ls where table_id = $table_id`;
let $wait_timeout= 30;
let $wait_condition=
  select /*+query_timeout(100000000)*/ count(distinct tablet_id) = $tablet_cnt
  from oceanbase.__all_virtual_tablet_compaction_history
  where tablet_id in (
    select tablet_id from oceanbase.__all_virtual_tablet_to_ls where table_id = $table_id
  )
  and type = 'MAJOR_MERGE';
--source mysql_test/include/wait_condition.inc
--enable_query_log
--enable_result_log
connection default;

--echo # 继续fork执行
connection obsys;
set ob_global_debug_sync = 'FORK_TABLE_BUILD_DATA clear';
set ob_global_debug_sync = 'now signal fork_major_signal';
connection default;

--echo # 等待fork任务完成
--source mysql_test/test_suite/fork_table/include/wait_fork_table.inc

--echo # 验证fork表快照数据
select count(*) as cnt from t1_fork;
select * from t1_fork order by id;

--echo # 验证源表包含最新数据
select count(*) as cnt from t1;
select * from t1 order by id;

--echo ============================================
--echo 2. 清理
--echo ============================================

drop table if exists t1;
drop table if exists t1_fork;
drop database if exists db_fork_major;

connection obsys;
set ob_global_debug_sync = 'reset';
connection default;
