--disable_query_log
set @@session.explicit_defaults_for_timestamp=off;
--enable_query_log
#owner:zhenling.zzg
#owner group: sql1
# tags: optimizer
#bug

--disable_warnings
drop table if exists t1, t2;
--enable_warnings
create table t1(a int, b int, c int, index k1(a,b));
create table t2(a int, b int, c int, index k1(a,b) local) partition by hash(a) partitions 4;
insert into t1 values (1,1,1),(1,2,1),(2,2,2),(2,3,2),(3,3,3),(3,2,3),(4,4,4),(4,5,5);
insert into t2 values (1,1,1),(1,2,1),(2,2,2),(2,3,2),(3,3,3),(3,2,3),(4,4,4),(4,5,5);

--result_format 4
--explain_protocol 2
select /*+parallel(4) index(t1 k1)*/ count(distinct a) from t1;
select /*+parallel(4) index(t1 k1)*/ count(distinct b) from t1;
select /*+parallel(4) index(t1 k1)*/ count(distinct a, b) from t1;
select /*+parallel(4) index(t1 k1)*/ count(distinct b, a) from t1;
select /*+parallel(4) index(t1 k1)*/ count(distinct a, b, c) from t1;
select /*+parallel(4) index(t1 k1)*/ count(distinct b, a, c) from t1;

select /*+index(t1 k1)*/ count(distinct a) from t2;
select /*+index(t1 k1)*/ count(distinct b) from t2;
select /*+index(t1 k1)*/ count(distinct a, b) from t2;
select /*+index(t1 k1)*/ count(distinct b, a) from t2;
select /*+index(t1 k1)*/ count(distinct a, b, c) from t2;
select /*+index(t1 k1)*/ count(distinct b, a, c) from t2;

--disable_warnings
drop table if exists t;
drop table if exists tmp;
--enable_warnings
create table t (c1 int, c2 int, key (c1, c2)) partition by hash(c2) partitions 2;
create table tmp (c1 int);
insert into tmp values (0), (1), (2), (3), (4), (5), (6), (7), (8), (9);
insert into t select t1.c1 + t2.c1, t2.c1 + t1.c1 from tmp t1, tmp t2;
--source mysql_test/include/minor_merge_tenant.inc
call dbms_stats.gather_table_stats('TEST', 't');
call dbms_stats.gather_table_stats('TEST', 'tmp');

--sorted_result
select /*+parallel(8)*/ count(distinct c2) from t;
--sorted_result
select /*+parallel(8)*/ count(distinct c2) from (select /*+no_merge*/ * from t) v;
--sorted_result
select /*+parallel(8)*/ count(distinct c2) from t group by c1;
--sorted_result
select /*+parallel(8)*/ count(c2) from t;
--sorted_result
select /*+parallel(8)*/ count(c2) from t group by c1;
--sorted_result
select /*+parallel(8)*/ count(c2) from t group by c1 + 1;

--sorted_result
select /*+parallel(8)*/ count(distinct c1) from t;
--sorted_result
select /*+parallel(8)*/ count(distinct c1) from t group by c1;
--sorted_result
select /*+parallel(8)*/ count(c1) from t;
--sorted_result
select /*+parallel(8)*/ count(c1) from t group by c1;
