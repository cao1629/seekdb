create table t1(c1 int primary key, c2 int, c3 int, c4 int);
create materialized view log on t1 with primary key, sequence (c2, c3) including new values;
create materialized view mv1 refresh fast on demand as select c2 as c2, count(*) cnt, count(c3) cnt_c3, sum(c3) sum_c3 from t1 group by c2;
create materialized view mv2 as select * from t1;
create materialized view mv3 as select * from t1;
call dbms_mview_stats.set_mvref_stats_params('mv1', 'ADVANCED', 31);
call dbms_mview_stats.set_mvref_stats_params('mv2', 'TYPICAL', 20);
call dbms_mview_stats.set_mvref_stats_params('mv3', 'NONE', 31);
call dbms_mview_stats.set_system_default('COLLECTION_LEVEL', NULL);
call dbms_mview_stats.set_system_default('RETENTION_PERIOD', NULL);
SELECT PARAMETER_NAME,VALUE FROM oceanbase.DBA_MVREF_STATS_SYS_DEFAULTS ORDER BY PARAMETER_NAME;
PARAMETER_NAME	VALUE
COLLECTION_LEVEL	TYPICAL
RETENTION_PERIOD	31
SELECT PARAMETER_NAME,VALUE FROM oceanbase.CDB_MVREF_STATS_SYS_DEFAULTS ORDER BY PARAMETER_NAME;
PARAMETER_NAME	VALUE
COLLECTION_LEVEL	TYPICAL
RETENTION_PERIOD	31
SELECT MV_OWNER,MV_NAME,COLLECTION_LEVEL,RETENTION_PERIOD FROM oceanbase.DBA_MVREF_STATS_PARAMS WHERE MV_OWNER = 'test' AND MV_NAME IN ('mv1', 'mv2', 'mv3') ORDER BY MV_NAME;
MV_OWNER	MV_NAME	COLLECTION_LEVEL	RETENTION_PERIOD
test	mv1	ADVANCED	31
test	mv2	TYPICAL	20
test	mv3	NONE	31
SELECT MV_OWNER,MV_NAME,COLLECTION_LEVEL,RETENTION_PERIOD FROM oceanbase.CDB_MVREF_STATS_PARAMS WHERE MV_OWNER = 'test' AND MV_NAME IN ('mv1', 'mv2', 'mv3') ORDER BY MV_NAME;
MV_OWNER	MV_NAME	COLLECTION_LEVEL	RETENTION_PERIOD
test	mv1	ADVANCED	31
test	mv2	TYPICAL	20
test	mv3	NONE	31
insert into t1 values(1,1,1,1);
call dbms_mview.refresh('mv1');
call dbms_mview.refresh('mv2');
call dbms_mview.refresh('mv3');
SELECT RUN_OWNER,MVIEWS,NUM_MVS FROM oceanbase.DBA_MVREF_RUN_STATS WHERE RUN_OWNER = 'admin' AND MVIEWS IN ('mv1', 'mv2', 'mv3') ORDER BY MVIEWS;
RUN_OWNER	MVIEWS	NUM_MVS
admin	mv1	1
admin	mv2	1
SELECT RUN_OWNER,MVIEWS,NUM_MVS FROM oceanbase.CDB_MVREF_RUN_STATS WHERE RUN_OWNER = 'admin' AND MVIEWS IN ('mv1', 'mv2', 'mv3') ORDER BY MVIEWS;
RUN_OWNER	MVIEWS	NUM_MVS
admin	mv1	1
admin	mv2	1
SELECT MV_OWNER,MV_NAME,REFRESH_METHOD,INITIAL_NUM_ROWS,FINAL_NUM_ROWS FROM oceanbase.DBA_MVREF_STATS WHERE MV_OWNER = 'test' AND MV_NAME IN ('mv1', 'mv2', 'mv3') ORDER BY MV_NAME;
MV_OWNER	MV_NAME	REFRESH_METHOD	INITIAL_NUM_ROWS	FINAL_NUM_ROWS
test	mv1	FAST	0	1
test	mv2	COMPLETE	0	0
SELECT MV_OWNER,MV_NAME,REFRESH_METHOD,INITIAL_NUM_ROWS,FINAL_NUM_ROWS FROM oceanbase.CDB_MVREF_STATS WHERE MV_OWNER = 'test' AND MV_NAME IN ('mv1', 'mv2', 'mv3') ORDER BY MV_NAME;
MV_OWNER	MV_NAME	REFRESH_METHOD	INITIAL_NUM_ROWS	FINAL_NUM_ROWS
test	mv1	FAST	0	1
test	mv2	COMPLETE	0	0
SELECT TBL_OWNER,TBL_NAME,MV_OWNER,MV_NAME,NUM_ROWS_INS,NUM_ROWS_UPD,NUM_ROWS_DEL,NUM_ROWS FROM oceanbase.DBA_MVREF_CHANGE_STATS WHERE MV_OWNER = 'test' AND MV_NAME IN ('mv1', 'mv2', 'mv3') ORDER BY MV_NAME;
TBL_OWNER	TBL_NAME	MV_OWNER	MV_NAME	NUM_ROWS_INS	NUM_ROWS_UPD	NUM_ROWS_DEL	NUM_ROWS
test	t1	test	mv1	1	0	0	1
test	t1	test	mv2	1	0	0	0
SELECT TBL_OWNER,TBL_NAME,MV_OWNER,MV_NAME,NUM_ROWS_INS,NUM_ROWS_UPD,NUM_ROWS_DEL,NUM_ROWS FROM oceanbase.CDB_MVREF_CHANGE_STATS WHERE MV_OWNER = 'test' AND MV_NAME IN ('mv1', 'mv2', 'mv3') ORDER BY MV_NAME;
TBL_OWNER	TBL_NAME	MV_OWNER	MV_NAME	NUM_ROWS_INS	NUM_ROWS_UPD	NUM_ROWS_DEL	NUM_ROWS
test	t1	test	mv1	1	0	0	1
test	t1	test	mv2	1	0	0	0
SELECT MV_OWNER,MV_NAME,STEP,SQLID,STMT IS NULL FROM oceanbase.DBA_MVREF_STMT_STATS WHERE MV_OWNER = 'test' AND MV_NAME IN ('mv1', 'mv2', 'mv3') ORDER BY MV_NAME;
MV_OWNER	MV_NAME	STEP	SQLID	STMT IS NULL
test	mv1	1	6CD8D015C0EB26963FF3DA59B961AF4C	0
test	mv1	2	F83D550F42C35326EF6B671213B2357A	0
test	mv1	3	FB2DFBCEFD13C7D4F7E3BB5EC734077D	0
SELECT MV_OWNER,MV_NAME,STEP,SQLID,STMT IS NULL FROM oceanbase.CDB_MVREF_STMT_STATS WHERE MV_OWNER = 'test' AND MV_NAME IN ('mv1', 'mv2', 'mv3') ORDER BY MV_NAME;
MV_OWNER	MV_NAME	STEP	SQLID	STMT IS NULL
test	mv1	1	6CD8D015C0EB26963FF3DA59B961AF4C	0
test	mv1	2	F83D550F42C35326EF6B671213B2357A	0
test	mv1	3	FB2DFBCEFD13C7D4F7E3BB5EC734077D	0
drop materialized view mv1;
SELECT RUN_OWNER,MVIEWS,NUM_MVS FROM oceanbase.DBA_MVREF_RUN_STATS WHERE RUN_OWNER = 'admin' AND MVIEWS IN ('mv1', 'mv2', 'mv3') ORDER BY MVIEWS;
RUN_OWNER	MVIEWS	NUM_MVS
admin	mv2	1
SELECT RUN_OWNER,MVIEWS,NUM_MVS FROM oceanbase.CDB_MVREF_RUN_STATS WHERE RUN_OWNER = 'admin' AND MVIEWS IN ('mv1', 'mv2', 'mv3') ORDER BY MVIEWS;
RUN_OWNER	MVIEWS	NUM_MVS
admin	mv2	1
SELECT MV_OWNER,MV_NAME,REFRESH_METHOD,INITIAL_NUM_ROWS,FINAL_NUM_ROWS FROM oceanbase.DBA_MVREF_STATS WHERE MV_OWNER = 'test' AND MV_NAME IN ('mv1', 'mv2', 'mv3') ORDER BY MV_NAME;
MV_OWNER	MV_NAME	REFRESH_METHOD	INITIAL_NUM_ROWS	FINAL_NUM_ROWS
test	mv2	COMPLETE	0	0
SELECT MV_OWNER,MV_NAME,REFRESH_METHOD,INITIAL_NUM_ROWS,FINAL_NUM_ROWS FROM oceanbase.CDB_MVREF_STATS WHERE MV_OWNER = 'test' AND MV_NAME IN ('mv1', 'mv2', 'mv3') ORDER BY MV_NAME;
MV_OWNER	MV_NAME	REFRESH_METHOD	INITIAL_NUM_ROWS	FINAL_NUM_ROWS
test	mv2	COMPLETE	0	0
SELECT TBL_OWNER,TBL_NAME,MV_OWNER,MV_NAME,NUM_ROWS_INS,NUM_ROWS_UPD,NUM_ROWS_DEL,NUM_ROWS FROM oceanbase.DBA_MVREF_CHANGE_STATS WHERE MV_OWNER = 'test' AND MV_NAME IN ('mv1', 'mv2', 'mv3') ORDER BY MV_NAME;
TBL_OWNER	TBL_NAME	MV_OWNER	MV_NAME	NUM_ROWS_INS	NUM_ROWS_UPD	NUM_ROWS_DEL	NUM_ROWS
test	t1	test	mv2	1	0	0	0
SELECT TBL_OWNER,TBL_NAME,MV_OWNER,MV_NAME,NUM_ROWS_INS,NUM_ROWS_UPD,NUM_ROWS_DEL,NUM_ROWS FROM oceanbase.CDB_MVREF_CHANGE_STATS WHERE MV_OWNER = 'test' AND MV_NAME IN ('mv1', 'mv2', 'mv3') ORDER BY MV_NAME;
TBL_OWNER	TBL_NAME	MV_OWNER	MV_NAME	NUM_ROWS_INS	NUM_ROWS_UPD	NUM_ROWS_DEL	NUM_ROWS
test	t1	test	mv2	1	0	0	0
SELECT MV_OWNER,MV_NAME,STEP,SQLID,STMT IS NULL FROM oceanbase.DBA_MVREF_STMT_STATS WHERE MV_OWNER = 'test' AND MV_NAME IN ('mv1', 'mv2', 'mv3') ORDER BY MV_NAME;
MV_OWNER	MV_NAME	STEP	SQLID	STMT IS NULL
SELECT MV_OWNER,MV_NAME,STEP,SQLID,STMT IS NULL FROM oceanbase.CDB_MVREF_STMT_STATS WHERE MV_OWNER = 'test' AND MV_NAME IN ('mv1', 'mv2', 'mv3') ORDER BY MV_NAME;
MV_OWNER	MV_NAME	STEP	SQLID	STMT IS NULL
create materialized view mv1 refresh fast on demand as select c2 as c2, count(*) cnt, count(c3) cnt_c3, sum(c3) sum_c3 from t1 group by c2;
call dbms_mview_stats.set_mvref_stats_params('mv1', 'ADVANCED', 31);
call dbms_mview.refresh('mv1');
SELECT RUN_OWNER,MVIEWS,NUM_MVS FROM oceanbase.DBA_MVREF_RUN_STATS WHERE RUN_OWNER = 'admin' AND MVIEWS IN ('mv1', 'mv2', 'mv3') ORDER BY MVIEWS;
RUN_OWNER	MVIEWS	NUM_MVS
admin	mv1	1
admin	mv2	1
SELECT RUN_OWNER,MVIEWS,NUM_MVS FROM oceanbase.CDB_MVREF_RUN_STATS WHERE RUN_OWNER = 'admin' AND MVIEWS IN ('mv1', 'mv2', 'mv3') ORDER BY MVIEWS;
RUN_OWNER	MVIEWS	NUM_MVS
admin	mv1	1
admin	mv2	1
SELECT MV_OWNER,MV_NAME,REFRESH_METHOD,INITIAL_NUM_ROWS,FINAL_NUM_ROWS FROM oceanbase.DBA_MVREF_STATS WHERE MV_OWNER = 'test' AND MV_NAME IN ('mv1', 'mv2', 'mv3') ORDER BY MV_NAME;
MV_OWNER	MV_NAME	REFRESH_METHOD	INITIAL_NUM_ROWS	FINAL_NUM_ROWS
test	mv1	FAST	1	1
test	mv2	COMPLETE	0	0
SELECT MV_OWNER,MV_NAME,REFRESH_METHOD,INITIAL_NUM_ROWS,FINAL_NUM_ROWS FROM oceanbase.CDB_MVREF_STATS WHERE MV_OWNER = 'test' AND MV_NAME IN ('mv1', 'mv2', 'mv3') ORDER BY MV_NAME;
MV_OWNER	MV_NAME	REFRESH_METHOD	INITIAL_NUM_ROWS	FINAL_NUM_ROWS
test	mv1	FAST	1	1
test	mv2	COMPLETE	0	0
SELECT TBL_OWNER,TBL_NAME,MV_OWNER,MV_NAME,NUM_ROWS_INS,NUM_ROWS_UPD,NUM_ROWS_DEL,NUM_ROWS FROM oceanbase.DBA_MVREF_CHANGE_STATS WHERE MV_OWNER = 'test' AND MV_NAME IN ('mv1', 'mv2', 'mv3') ORDER BY MV_NAME;
TBL_OWNER	TBL_NAME	MV_OWNER	MV_NAME	NUM_ROWS_INS	NUM_ROWS_UPD	NUM_ROWS_DEL	NUM_ROWS
test	t1	test	mv1	0	0	0	1
test	t1	test	mv2	1	0	0	0
SELECT TBL_OWNER,TBL_NAME,MV_OWNER,MV_NAME,NUM_ROWS_INS,NUM_ROWS_UPD,NUM_ROWS_DEL,NUM_ROWS FROM oceanbase.CDB_MVREF_CHANGE_STATS WHERE MV_OWNER = 'test' AND MV_NAME IN ('mv1', 'mv2', 'mv3') ORDER BY MV_NAME;
TBL_OWNER	TBL_NAME	MV_OWNER	MV_NAME	NUM_ROWS_INS	NUM_ROWS_UPD	NUM_ROWS_DEL	NUM_ROWS
test	t1	test	mv1	0	0	0	1
test	t1	test	mv2	1	0	0	0
SELECT MV_OWNER,MV_NAME,STEP,SQLID,STMT IS NULL FROM oceanbase.DBA_MVREF_STMT_STATS WHERE MV_OWNER = 'test' AND MV_NAME IN ('mv1', 'mv2', 'mv3') ORDER BY MV_NAME;
MV_OWNER	MV_NAME	STEP	SQLID	STMT IS NULL
test	mv1	1	6CD8D015C0EB26963FF3DA59B961AF4C	0
test	mv1	2	F83D550F42C35326EF6B671213B2357A	0
test	mv1	3	FB2DFBCEFD13C7D4F7E3BB5EC734077D	0
SELECT MV_OWNER,MV_NAME,STEP,SQLID,STMT IS NULL FROM oceanbase.CDB_MVREF_STMT_STATS WHERE MV_OWNER = 'test' AND MV_NAME IN ('mv1', 'mv2', 'mv3') ORDER BY MV_NAME;
MV_OWNER	MV_NAME	STEP	SQLID	STMT IS NULL
test	mv1	1	6CD8D015C0EB26963FF3DA59B961AF4C	0
test	mv1	2	F83D550F42C35326EF6B671213B2357A	0
test	mv1	3	FB2DFBCEFD13C7D4F7E3BB5EC734077D	0
drop materialized view log on t1;
drop table t1;
drop materialized view mv1;
drop materialized view mv2;
drop materialized view mv3;
