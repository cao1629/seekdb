# Test JSON FUNCTION --- JSON_STORAGE_SIZE/JSON_STORAGE_FREE
# ----------------------------------------------------------------------
# Test of JSON_STORAGE_SIZE/JSON_STORAGE_FREE
# ----------------------------------------------------------------------
drop table if exists t1;
SELECT JSON_STORAGE_SIZE();
ERROR 42000: Incorrect parameter count in the call to native function 'JSON_STORAGE_SIZE'
SELECT JSON_STORAGE_FREE();
ERROR 42000: Incorrect parameter count in the call to native function 'JSON_STORAGE_FREE'
SELECT JSON_STORAGE_SIZE('{}', '[]');
ERROR 42000: Incorrect parameter count in the call to native function 'JSON_STORAGE_SIZE'
SELECT JSON_STORAGE_FREE('{}', '[]');
ERROR 42000: Incorrect parameter count in the call to native function 'JSON_STORAGE_FREE'
SELECT JSON_STORAGE_SIZE('this is not JSON');
ERROR 22032: Invalid JSON text.
SELECT JSON_STORAGE_FREE('this is not JSON');
ERROR 22032: Invalid JSON text.
#expect NULL
SELECT JSON_STORAGE_SIZE(NULL);
JSON_STORAGE_SIZE(NULL)
NULL
#expect NULL
SELECT JSON_STORAGE_FREE(NULL);
JSON_STORAGE_FREE(NULL)
NULL
#expect 0
SELECT JSON_STORAGE_SIZE(JSON_ARRAY(1,2,3));
JSON_STORAGE_SIZE(JSON_ARRAY(1,2,3))
18
#expect 0
SELECT JSON_STORAGE_FREE(JSON_ARRAY(1,2,3));
JSON_STORAGE_FREE(JSON_ARRAY(1,2,3))
0
DROP TABLE IF EXISTS t;
CREATE TABLE IF NOT EXISTS t(id INT PRIMARY KEY, j JSON, v VARCHAR(100));
INSERT INTO t(id, j) VALUES (0, NULL), (1, '[["abc", "def", "ghi"], "jkl"]');
UPDATE t SET v = j;
#expect NULL 55
SELECT JSON_STORAGE_SIZE(j) FROM t;
JSON_STORAGE_SIZE(j)
NULL
46
#expect NULL 55
SELECT JSON_STORAGE_SIZE(v) FROM t;
JSON_STORAGE_SIZE(v)
NULL
46
SELECT JSON_STORAGE_SIZE(JSON_EXTRACT(j, '$[0]')) FROM t;
JSON_STORAGE_SIZE(JSON_EXTRACT(j, '$[0]'))
NULL
33
#expect NULL 0
SELECT JSON_STORAGE_FREE(j) FROM t;
JSON_STORAGE_FREE(j)
NULL
0
#expect NULL 0
SELECT JSON_STORAGE_FREE(v) FROM t;
JSON_STORAGE_FREE(v)
NULL
0
SELECT JSON_STORAGE_FREE(JSON_EXTRACT(j, '$[0]')) FROM t;
JSON_STORAGE_FREE(JSON_EXTRACT(j, '$[0]'))
NULL
0
DROP TABLE t;
CREATE TABLE IF NOT EXISTS t(id INT PRIMARY KEY, j JSON);
INSERT INTO t VALUES (1, '{"a":"a"}'), (2, '{"a":"b", "b":"b"}'), (3, '{"a":"c", "c":"c"}');
SELECT *, JSON_STORAGE_SIZE(j) ss,
JSON_STORAGE_FREE(j) sf FROM t ORDER BY id;
id	j	ss	sf
1	{"a": "a"}	20	0
2	{"a": "b", "b": "b"}	28	0
3	{"a": "c", "c": "c"}	28	0
DROP TABLE t;
CREATE TABLE IF NOT EXISTS t(id INT PRIMARY KEY, j1 JSON, j2 JSON);
INSERT INTO t VALUES
(1, '{"a":"a","b":"b"}', '{"a":"a","b":"b"}'),
(2, NULL, NULL),
(3, '{"a":"aa","b":"bb"}', '{"a":"aa","b":"bb"}');
SELECT *, JSON_STORAGE_SIZE(j1) ss1,
JSON_STORAGE_FREE(j1) sf1,
JSON_STORAGE_SIZE(j2) ss2,
JSON_STORAGE_FREE(j2) sf2 FROM t ORDER BY id;
id	j1	j2	ss1	sf1	ss2	sf2
1	{"a": "a", "b": "b"}	{"a": "a", "b": "b"}	28	0	28	0
2	NULL	NULL	NULL	NULL	NULL	NULL
3	{"a": "aa", "b": "bb"}	{"a": "aa", "b": "bb"}	30	0	30	0
DROP TABLE t;
CREATE TABLE IF NOT EXISTS t(j JSON,
i INT DEFAULT 42,
db DOUBLE DEFAULT 2.34e-10,
dc DECIMAL(5, 3) DEFAULT 98.765,
ts TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
gc JSON GENERATED ALWAYS AS (JSON_ARRAY(i, db, dc, ts)));
INSERT INTO t(j, ts) VALUES
('[null, "abc", true, "def", false]', '2017-01-02 14:15:16');
SELECT j, JSON_TYPE(j) jt, JSON_STORAGE_SIZE(j) ss,
JSON_STORAGE_FREE(j) sf FROM t;
j	jt	ss	sf
[null, "abc", true, "def", false]	ARRAY	32	0
DROP TABLE t;
DROP TABLE IF EXISTS t1;
CREATE TABLE IF NOT EXISTS t1(id INT PRIMARY KEY, j JSON, x INT);
INSERT INTO t1 VALUES (1, '{"a":"xy"}', 1), (2, '{"a":"zw"}', 2);
SELECT *, JSON_STORAGE_SIZE(j) ss,
JSON_STORAGE_FREE(j) sf FROM t1 ORDER BY id;
id	j	x	ss	sf
1	{"a": "xy"}	1	21	0
2	{"a": "zw"}	2	21	0
DROP TABLE t1;
DROP TABLE IF EXISTS t2;
CREATE TABLE IF NOT EXISTS t2(id INT PRIMARY KEY, j JSON, x INT);
INSERT INTO t2 VALUES
(1, '{"b":"X"}', 3),
(2, '{"b":"Y"}', 4),
(3, '{"b":"Z"}', 9);
SELECT *, JSON_STORAGE_SIZE(j) ss,
JSON_STORAGE_FREE(j) sf FROM t2 ORDER BY id;
id	j	x	ss	sf
1	{"b": "X"}	3	20	0
2	{"b": "Y"}	4	20	0
3	{"b": "Z"}	9	20	0
DROP TABLE t2;
CREATE TABLE IF NOT EXISTS t(j JSON);
INSERT INTO t VALUES ('[1,2,3,4]'), ('["adef"]'), ('["cdef"]');
SELECT j, JSON_STORAGE_SIZE(j), JSON_STORAGE_FREE(j) FROM t;
j	JSON_STORAGE_SIZE(j)	JSON_STORAGE_FREE(j)
[1, 2, 3, 4]	20	0
["adef"]	20	0
["cdef"]	20	0
UPDATE t SET j = JSON_REMOVE(j, '$[0]');
SELECT j, JSON_STORAGE_SIZE(j), JSON_STORAGE_FREE(j) FROM t;
j	JSON_STORAGE_SIZE(j)	JSON_STORAGE_FREE(j)
[2, 3, 4]	18	0
[]	12	0
[]	12	0
DROP TABLE t;
SELECT JSON_STORAGE_SIZE(UNHEX(""));
ERROR 22032: Cannot create a JSON value from a string.
SELECT JSON_STORAGE_FREE(UNHEX(""));
ERROR 22032: Cannot create a JSON value from a string.
#bug:
SELECT JSON_STORAGE_FREE('false');
JSON_STORAGE_FREE('false')
0
SELECT JSON_STORAGE_FREE('123');
JSON_STORAGE_FREE('123')
0
drop table if exists json_test;
set log_row_value_options="partial_json";
set ob_default_lob_inrow_threshold = 4096;
create table json_test(pk int, j json) JSON(j) STORE AS (CHUNK '1K');
insert into json_test values(10 , json_object('name', 'zero', 'age', 100, 'position', 'software engineer', 'profile', repeat('x', 4096), 'like', json_array('a', 'b', 'c'), 'tags', json_array('sql boy', 'football', 'summer', 1), 'money' , json_object('RMB', 10000, 'Dollers', 20000, 'BTC', 100), 'nickname', 'noone'));
select json_storage_size(j), JSON_STORAGE_FREE(j) from json_test where pk=10;
json_storage_size(j)	JSON_STORAGE_FREE(j)
4335	0
update json_test set j = json_replace(j, '$.position', 'software enginee') where pk=10;
select json_storage_size(j), JSON_STORAGE_FREE(j) from json_test where pk=10;
json_storage_size(j)	JSON_STORAGE_FREE(j)
4335	1
update json_test set j = json_replace(j, '$.position', 'software engineera') where pk=10;
select json_storage_size(j), JSON_STORAGE_FREE(j) from json_test where pk=10;
json_storage_size(j)	JSON_STORAGE_FREE(j)
4355	19
drop table json_test;
create table json_test(id int,j json) json(j) store as (chunk '1k');
insert into json_test values(1,concat('{"name": "John","值值":5,"name1":1,"name2":true,"name3":false,"name4":null,"name5":["test",1,null,false], "content": "', repeat('x',5000), '"}'));
select JSON_STORAGE_SIZE(j),JSON_STORAGE_FREE(j),JSON_EXTRACT(j,'$.name') from json_test;
JSON_STORAGE_SIZE(j)	JSON_STORAGE_FREE(j)	JSON_EXTRACT(j,'$.name')
5138	0	"John"
update json_test set j=json_set(j,'$.name','testee');
select JSON_STORAGE_SIZE(j),JSON_STORAGE_FREE(j),JSON_EXTRACT(j,'$.name') from json_test;
JSON_STORAGE_SIZE(j)	JSON_STORAGE_FREE(j)	JSON_EXTRACT(j,'$.name')
5146	6	"testee"
update json_test set j=json_set(j,'$.name','test');
select JSON_STORAGE_SIZE(j),JSON_STORAGE_FREE(j),JSON_EXTRACT(j,'$.name') from json_test;
JSON_STORAGE_SIZE(j)	JSON_STORAGE_FREE(j)	JSON_EXTRACT(j,'$.name')
5146	8	"test"
update json_test set j=json_set(j,'$.name', 31415926);
select JSON_STORAGE_SIZE(j),JSON_STORAGE_FREE(j),JSON_EXTRACT(j,'$.name') from json_test;
JSON_STORAGE_SIZE(j)	JSON_STORAGE_FREE(j)	JSON_EXTRACT(j,'$.name')
5146	10	31415926
drop table if exists json_test;
set log_row_value_options="";
create table json_test(pk int, j json) JSON(j) STORE AS (CHUNK '1K');
insert into json_test values(10 , json_object('name', 'zero', 'age', 100, 'position', 'software engineer', 'profile', repeat('x', 4096), 'like', json_array('a', 'b', 'c'), 'tags', json_array('sql boy', 'football', 'summer', 1), 'money' , json_object('RMB', 10000, 'Dollers', 20000, 'BTC', 100), 'nickname', 'noone'));
select json_storage_size(j), JSON_STORAGE_FREE(j) from json_test where pk=10;
json_storage_size(j)	JSON_STORAGE_FREE(j)
4335	0
update json_test set j = json_replace(j, '$.position', 'software enginee') where pk=10;
select json_storage_size(j), JSON_STORAGE_FREE(j) from json_test where pk=10;
json_storage_size(j)	JSON_STORAGE_FREE(j)
4334	0
update json_test set j = json_replace(j, '$.position', 'software engineera') where pk=10;
select json_storage_size(j), JSON_STORAGE_FREE(j) from json_test where pk=10;
json_storage_size(j)	JSON_STORAGE_FREE(j)
4336	0
