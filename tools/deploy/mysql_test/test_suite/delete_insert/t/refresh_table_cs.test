# owner: liquanhong.lqh
# owner group: storage
# description: test refresh table using table with auto_increment int primary key and table with string primary key
# notice: run this mysqltest using observer compiled with errsim

--disable_query_log
connect (conn1,$OBMYSQL_MS0,$OBMYSQL_USR,$OBMYSQL_PWD,test,$OBMYSQL_PORT);
connect (syscon, $OBMYSQL_MS0,admin,$OBMYSQL_PWD,test,$OBMYSQL_PORT);
connection syscon;
set @@session.explicit_defaults_for_timestamp=off;
set session ob_trx_timeout=100000000000;
alter system set_tp tp_name = "EN_COMPACTION_DISABLE_ROW_COL_SWITCH", error_code = 4016, frequency = 1;
set @@recyclebin = off;
--enable_query_log

connection conn1;
--disable_warnings
drop table if exists t1, t2;
--enable_warnings

create table t1(id int primary key auto_increment, a int DEFAULT NULL, b int DEFAULT NULL) merge_engine = delete_insert with column group(each column);

--disable_query_log
let $cnt = 1;
while($cnt <= 10)
{
    eval insert into t1(a, b) values ($cnt * 100, $cnt * 100);
    inc $cnt;
}

alter system major freeze;
--source mysql_test/include/wait_daily_merge.inc
--enable_query_log

# update t1

update  t1 set b = 101 where a = 100;


# update t2

--disable_query_log
connection syscon;
--error 0, 1210
alter system set_tp tp_name = "ERRSIM_SET_NEED_REFRESH", error_code = 4016, frequency = 1;
--enable_query_log

connection conn1;

# select t1
select * from t1 order by a;
select * from t1 where a = 800;

# minor freeze
connection conn1;
alter system minor freeze;
--source mysql_test/include/wait_minor_merge.inc

connection conn1;

# select t1
select * from t1 order by a;
select * from t1 where a = 800;

--disable_query_log
connection syscon;
--error 0, 1210
alter system set_tp tp_name = "ERRSIM_SET_NEED_REFRESH", error_code = 4016, frequency = 0;
alter system set_tp tp_name = "EN_COMPACTION_DISABLE_ROW_COL_SWITCH", error_code = 4016, frequency = 0;
set @@recyclebin = on;
--enable_query_log

connection conn1;
drop table t1;
