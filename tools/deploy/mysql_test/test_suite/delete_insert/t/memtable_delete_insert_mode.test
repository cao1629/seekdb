# owner: gengli.wzy
# owner group: transaction
# description:

--disable_query_log
set @@session.explicit_defaults_for_timestamp=off;

connect (conn_sys,$OBMYSQL_MS0,admin,$OBMYSQL_PWD,oceanbase,$OBMYSQL_PORT);
--enable_query_log

let $case_name = mem_scan_perf_test;
let $test_tenant_name = tt1;
let $test_pool_name=pool_$case_name;
let $test_unit_name=unit_$case_name;

--echo $case_name;
--echo $test_tenant_name;
--echo $test_pool_name;
--echo $test_unit_name;

connect (conn_test_tenant,$OBMYSQL_MS0,root,,test,$OBMYSQL_PORT);
let $__timeout_def__ = 5 * 3600 * 1000 * 1000;

connection conn_test_tenant;
eval set SESSION ob_query_timeout = $__timeout_def__;
eval set SESSION ob_trx_timeout = $__timeout_def__;
eval set SESSION ob_trx_idle_timeout = $__timeout_def__;
alter system set freeze_trigger_percentage = 59;

--disable_query_log
--disable_warnings
drop table if exists memtable_delete_insert_test_t;
drop sequence if exists s1;
drop sequence if exists s2;
--enable_warnings
--enable_query_log

create table memtable_delete_insert_test_t (col_0 bigint primary key, col_1 bigint, col_2 bigint, col_3 bigint, col_4 bigint, col_5 varchar(20)) merge_engine = delete_insert;
create sequence s1 cache 1000000 noorder;
create sequence s2 cache 1000000 noorder;

# 构造数据
INSERT INTO memtable_delete_insert_test_t SELECT
  s1.nextval col_0,
  s2.nextval col_1,
  zipf(1, 100, random(269381)) col_2,
  normal(0, 1, random(269381)) col_3,
  uniform(1, 100, random(269381)) col_4,
  randstr(1+zipf(1, 20, random(269381)), random(269381)) col_5
FROM
  table(generator(500));

# 查询纯insert数据
SELECT * FROM memtable_delete_insert_test_t WHERE col_1 >= 100 and col_1 <= 110;

# insert-delete
UPDATE memtable_delete_insert_test_t SET col_2 = 777 WHERE col_1 >= 100 && col_1 <= 110;
SELECT * FROM memtable_delete_insert_test_t WHERE col_1 >= 100 && col_1 <= 111;
UPDATE memtable_delete_insert_test_t SET col_4 = 777 WHERE col_1 >= 100 && col_1 <= 110;
SELECT * FROM memtable_delete_insert_test_t WHERE col_1 >= 100 && col_1 <= 111;

# delete-delete
DELETE FROM memtable_delete_insert_test_t WHERE col_1 >= 100 && col_1 <= 110;
SELECT * FROM memtable_delete_insert_test_t WHERE col_1 >= 100 && col_1 <= 111;

# 转储
alter system minor freeze tenant sys;
--source mysql_test/include/wait_minor_merge.inc

# delte-insert
UPDATE memtable_delete_insert_test_t SET col_3 = 100 WHERE col_1 > 110 and col_1 < 115;
SELECT * FROM memtable_delete_insert_test_t WHERE col_1 > 110 and col_1 + 5 < 120;
UPDATE memtable_delete_insert_test_t SET col_4 = 101 WHERE col_1 > 110 and col_1 < 115;
SELECT * FROM memtable_delete_insert_test_t WHERE col_1 > 110 and col_1 + 5 < 120;
UPDATE memtable_delete_insert_test_t SET col_3 = 102 WHERE col_1 > 110 and col_1 < 115;
SELECT * FROM memtable_delete_insert_test_t WHERE col_1 > 110 and col_1 + 5 < 120;
UPDATE memtable_delete_insert_test_t SET col_4 = 103 WHERE col_1 > 110 and col_1 < 115;
SELECT * FROM memtable_delete_insert_test_t WHERE col_1 > 110 and col_1 + 5 < 120;

# insert-insert
INSERT INTO memtable_delete_insert_test_t VALUES(888666, 888666, 1, 1, 1, 'gengli');
UPDATE memtable_delete_insert_test_t SET col_2 = 600, col_3 = 700 WHERE col_1 = 888666;
SELECT * FROM memtable_delete_insert_test_t WHERE col_1 = 888666;
UPDATE memtable_delete_insert_test_t SET col_2 = 650, col_3 = 750 WHERE col_1 = 888666;
SELECT * FROM memtable_delete_insert_test_t WHERE col_1 = 888666;
UPDATE memtable_delete_insert_test_t SET col_2 = 777, col_3 = 888 WHERE col_1 = 888666;
SELECT * FROM memtable_delete_insert_test_t WHERE col_1 = 888666;
UPDATE memtable_delete_insert_test_t SET col_2 = 999, col_3 = 888 WHERE col_1 = 888666;
SELECT * FROM memtable_delete_insert_test_t WHERE col_1 = 888666;
UPDATE memtable_delete_insert_test_t SET col_2 = 8866, col_3 = 6688 WHERE col_1 = 888666;
SELECT * FROM memtable_delete_insert_test_t WHERE col_1 = 888666;


# 恢复租户配置项
alter system set freeze_trigger_percentage = 20;

--disable_query_log
drop table if exists memtable_delete_insert_test_t;
drop sequence if exists s1;
drop sequence if exists s2;
--enable_query_log
