set @@session.explicit_defaults_for_timestamp=off;
alter system set minor_compact_trigger = 10;
drop table if exists test_check_rows_exist;
drop table if exists test_check_rows_exist2;
create table test_check_rows_exist(c1 int primary key, c2 int);
set SESSION ob_query_timeout = 10000000;
insert /*+ log_level(debug) */ into test_check_rows_exist values(2, 2), (3, 3), (4, 4), (5, 5), (9, 9);
delete /*+ log_level(debug) */ from test_check_rows_exist where c1 = 4;
insert /*+ log_level(debug) */ into test_check_rows_exist values(1, 1), (3, 3), (2, 2);
ERROR 23000: Duplicate entry '3' for key 'PRIMARY'
set SESSION ob_trx_timeout = 10000000000;
begin;
insert /*+ log_level(debug) */ into test_check_rows_exist values(15, 15);
insert /*+ log_level(debug) */ into test_check_rows_exist values(14, 14);
insert /*+ log_level(debug) */ into test_check_rows_exist values(16, 16);
insert /*+ log_level(debug) */ into test_check_rows_exist values(11, 11), (12, 12), (15, 15);
ERROR HY000: Lock wait timeout exceeded; try restarting transaction
begin;
insert /*+ log_level(debug) */ into test_check_rows_exist values(31, 31);
savepoint qcc;
insert /*+ log_level(debug) */ into test_check_rows_exist values(32, 32), (33, 33);
create table test_check_rows_exist2(c1 int primary key, c2 int);
set SESSION transaction isolation level repeatable read;
begin;
insert /*+ log_level(debug) */ into test_check_rows_exist2 values(120, 120), (121, 121), (1, 1);
commit;
insert /*+ log_level(debug) */ into test_check_rows_exist values(133, 133), (131, 131), (132, 132);
alter system minor freeze;
insert /*+ log_level(debug) */ into test_check_rows_exist values(6, 6), (7, 7);
insert /*+ log_level(debug) */ into test_check_rows_exist values(1, 1), (3, 3), (2, 2);
ERROR 23000: Duplicate entry '2' for key 'PRIMARY'
delete /*+ log_level(debug) */ from test_check_rows_exist where c1 = 5;
begin;
insert /*+ log_level(debug) */ into test_check_rows_exist values(1, 1), (4, 4), (5, 5);
rollback;
insert /*+ log_level(debug) */ into test_check_rows_exist values(1, 1), (4, 4), (3, 3), (5, 5), (6, 6);
ERROR 23000: Duplicate entry '6' for key 'PRIMARY'
begin;
insert /*+ log_level(debug) */ into test_check_rows_exist values(1, 1), (4, 4), (5, 5);
delete /*+ log_level(debug) */ from test_check_rows_exist where c1 = 1 or c1 = 4 or c1 = 5;
insert /*+ log_level(debug) */ into test_check_rows_exist values(1, 1), (4, 4);
insert /*+ log_level(debug) */ into test_check_rows_exist values(4, 4), (5, 5);
ERROR 23000: Duplicate entry '4' for key 'PRIMARY'
rollback;
insert /*+ log_level(debug) */ into test_check_rows_exist values(1, 1), (4, 4), (3, 3), (5, 5);
ERROR 23000: Duplicate entry '3' for key 'PRIMARY'
set SESSION ob_trx_timeout = 10000000000;
begin;
insert /*+ log_level(debug) */ into test_check_rows_exist values(18, 18);
insert /*+ log_level(debug) */ into test_check_rows_exist values(11, 11), (12, 12), (15, 15);
ERROR HY000: Lock wait timeout exceeded; try restarting transaction
insert /*+ log_level(debug) */ into test_check_rows_exist values(11, 11), (12, 12), (15, 15), (18, 18);
ERROR HY000: Lock wait timeout exceeded; try restarting transaction
insert /*+ log_level(debug) */ into test_check_rows_exist values(11, 11), (12, 12), (14, 14), (15, 15) on duplicate key update c2 = c2 + 1;
ERROR HY000: Lock wait timeout exceeded; try restarting transaction
insert /*+ log_level(debug) */ into test_check_rows_exist values(11, 11), (12, 12), (15, 15), (16, 16) on duplicate key update c2 = c2 + 1;
ERROR HY000: Lock wait timeout exceeded; try restarting transaction
begin;
insert /*+ log_level(debug) */ into test_check_rows_exist values(11, 11), (12, 12), (14, 14), (16, 16) on duplicate key update c2 = c2 + 1;
rollback;
rollback to savepoint qcc;
commit;
insert /*+ log_level(debug) */ into test_check_rows_exist values(32, 32), (33, 33);
set SESSION transaction isolation level repeatable read;
begin;
select * from test_check_rows_exist2;
c1	c2
1	1
120	120
121	121
begin;
update /*+ log_level(debug) */ test_check_rows_exist2 set c2 = c2 + 1 where c1 >= 100;
commit;
begin;
delete /*+ log_level(debug) */ from test_check_rows_exist where c1 = 131 or c1 = 132;
insert /*+ log_level(debug) */ into test_check_rows_exist values(130, 130), (131, 131), (134, 134);
rollback;
insert /*+ log_level(debug) */ into test_check_rows_exist values(130, 130), (131, 131), (135, 135);
ERROR 23000: Duplicate entry '131' for key 'PRIMARY'
alter system minor freeze;
insert /*+ log_level(debug) */ into test_check_rows_exist values(1, 1), (8, 8);
insert /*+ log_level(debug) */ into test_check_rows_exist values(3, 3), (4, 4), (5, 5);
ERROR 23000: Duplicate entry '3' for key 'PRIMARY'
begin;
insert /*+ log_level(debug) */ into test_check_rows_exist values(4, 4), (5, 5);
rollback;
insert /*+ log_level(debug) */ into test_check_rows_exist values(4, 4), (5, 5), (9, 9);
ERROR 23000: Duplicate entry '9' for key 'PRIMARY'
begin;
insert /*+ log_level(debug) */ into test_check_rows_exist values(1, 1), (2, 2), (3, 3), (4, 4), (5, 5), (6, 6), (7, 7), (8, 8), (9, 9) on duplicate key update c2 = c2 + 1;
rollback;
insert /*+ log_level(debug) */ into test_check_rows_exist values(11, 11), (12, 12), (15, 15);
ERROR HY000: Lock wait timeout exceeded; try restarting transaction
insert /*+ log_level(debug) */ into test_check_rows_exist values(11, 11), (12, 12), (15, 15), (18, 18);
ERROR HY000: Lock wait timeout exceeded; try restarting transaction
insert /*+ log_level(debug) */ into test_check_rows_exist values(11, 11), (12, 12), (14, 14), (15, 15) on duplicate key update c2 = c2 + 1;
ERROR HY000: Lock wait timeout exceeded; try restarting transaction
insert /*+ log_level(debug) */ into test_check_rows_exist values(11, 11), (12, 12), (15, 15), (16, 16) on duplicate key update c2 = c2 + 1;
ERROR HY000: Lock wait timeout exceeded; try restarting transaction
begin;
insert /*+ log_level(debug) */ into test_check_rows_exist values(11, 11), (12, 12), (14, 14), (16, 16) on duplicate key update c2 = c2 + 1;
rollback;
begin;
update /*+ log_level(debug) */ test_check_rows_exist2 set c2 = c2 + 1 where c1 >= 100;
rollback;
update /*+ log_level(debug) */ test_check_rows_exist2 set c2 = c2 + 1 where c1 >= 100;
ERROR 25000: can't serialize access for this transaction
alter system minor freeze;
begin;
insert /*+ log_level(debug) */ into test_check_rows_exist values(1, 1), (2, 2), (3, 3), (4, 4), (5, 5), (6, 6), (7, 7), (8, 8), (9, 9) on duplicate key update c2 = c2 + 1;
rollback;
alter system minor freeze;
insert /*+ log_level(debug) */ into test_check_rows_exist values(4, 4), (5, 5), (9, 9);
ERROR 23000: Duplicate entry '9' for key 'PRIMARY'
insert /*+ log_level(debug) */ into test_check_rows_exist values(4, 4), (5, 5), (10, 10);
begin;
insert /*+ log_level(debug) */ into test_check_rows_exist values(1, 1), (2, 2), (3, 3), (4, 4), (5, 5), (6, 6), (7, 7), (8, 8), (9, 9), (10, 10) on duplicate key update c2 = c2 + 1;
rollback;
insert /*+ log_level(debug) */ into test_check_rows_exist values(11, 11), (12, 12), (15, 15);
ERROR HY000: Lock wait timeout exceeded; try restarting transaction
insert /*+ log_level(debug) */ into test_check_rows_exist values(11, 11), (12, 12), (15, 15), (18, 18);
ERROR HY000: Lock wait timeout exceeded; try restarting transaction
insert /*+ log_level(debug) */ into test_check_rows_exist values(11, 11), (12, 12), (14, 14), (15, 15) on duplicate key update c2 = c2 + 1;
ERROR HY000: Lock wait timeout exceeded; try restarting transaction
insert /*+ log_level(debug) */ into test_check_rows_exist values(11, 11), (12, 12), (15, 15), (16, 16) on duplicate key update c2 = c2 + 1;
ERROR HY000: Lock wait timeout exceeded; try restarting transaction
begin;
insert /*+ log_level(debug) */ into test_check_rows_exist values(11, 11), (12, 12), (14, 14), (16, 16) on duplicate key update c2 = c2 + 1;
rollback;
select  /*+ log_level(debug) */ * from test_check_rows_exist where c1 = 18 for update;
c1	c2
18	18
commit;
commit;
commit;
commit;
commit;
commit;
commit;
select   /*+ log_level(debug) */ * from test_check_rows_exist;
c1	c2
1	1
2	2
3	3
4	4
5	5
6	6
7	7
8	8
9	9
10	10
14	14
15	15
16	16
18	18
31	31
32	32
33	33
131	131
132	132
133	133
drop table if exists test_check_rows_exist;
drop table if exists test_check_rows_exist2;
