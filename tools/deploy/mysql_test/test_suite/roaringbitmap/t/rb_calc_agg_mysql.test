#owner: xuqijia.xqj
#owner group: shenzhen
--echo # ----------------------------------------------------------------------
--echo # Base test of roaringbitmap rb_or_agg, rb_and_agg.
--echo # ----------------------------------------------------------------------


--echo #
--echo # Setup test.
--echo #
--disable_warnings
drop table if exists t1, t2, t3;
--enable_warnings

# empty
SET @p1 = x'0100';
# single: 1
SET @p2 = x'010101000000';
# single: 2
SET @p3 = x'010102000000';
# set: 1,2,3
SET @p4 = x'010303010000000200000003000000';
# set: 2,3,4
SET @p5 = x'010303020000000300000004000000';
# bitmap: 0~32
SET @p6 = x'01060100000000000000000000003a30000001000000000020001000000000000100020003000400050006000700080009000a000b000c000d000e000f0010001100120013001400150016001700180019001a001b001c001d001e001f002000';
# bitmap: 10~42
SET @p7 = x'01060100000000000000000000003a3000000100000000002000100000000a000b000c000d000e000f0010001100120013001400150016001700180019001a001b001c001d001e001f0020002100220023002400250026002700280029002a00';

CREATE TABLE t1 (k int, rb roaringbitmap);
INSERT INTO t1 VALUES
  (1, NULL),
  (1, @p1),
  (1, @p2),
  (2, @p1),
  (2, @p2),
  (3, @p2),
  (3, @p1),
  (4, @p1),
  (4, @p4),
  (5, @p4),
  (5, @p1),
  (6, @p1),
  (6, @p6),
  (7, @p6),
  (7, @p1),
  (8, @p2),
  (8, @p3),
  (9, @p2),
  (9, @p4),
  (10, @p4),
  (10, @p2),
  (11, @p2),
  (11, @p6),
  (12, @p6),
  (12, @p2),
  (13, @p4),
  (13, @p5),
  (14, @p4),
  (14, @p6),
  (15, @p6),
  (15, @p4),
  (16, @p6),
  (16, @p7);

--echo test: rb_or_agg calculate
SELECT k, rb_to_string(rb_or_agg(rb)), hex(rb_or_agg(rb)) FROM t1 GROUP BY k ORDER BY k;
SELECT k, rb_to_string(rb_or_agg(rb)), hex(rb_or_agg(rb)) FROM t1;

--echo rb_and_agg calculate
SELECT k, rb_to_string(rb_and_agg(rb)), hex(rb_and_agg(rb)) FROM t1 GROUP BY k ORDER BY k;
SELECT k, rb_to_string(rb_and_agg(rb)), hex(rb_and_agg(rb)) FROM t1;

--echo test: rb_or_agg param
select rb_or_agg(NULL);
--error 3064
select rb_or_agg(1);
--error 3064
select rb_or_agg('');
--error 3064
select rb_or_agg('a');
--error 4070
select rb_or_agg(x'');

--echo test: rb_and_agg param
select rb_and_agg(NULL);
--error 3064
select rb_and_agg(1);
--error 3064
select rb_and_agg('');
--error 3064
select rb_and_agg('a');
--error 4070
select rb_and_agg(x'');

--echo test: rb_or_agg build from binary
# 00->EMPTY
select hex(rb_or_agg(x'0100'));
--error 4070
select hex(rb_or_agg(x'0200'));
# 01->SINGLE_32
select hex(rb_or_agg(x'010101000000'));
--error 4070
select hex(rb_or_agg(x'01010100000000000000'));
# 02->SINGLE_64
select hex(rb_or_agg(x'01020100000001000000'));
--error 4070
select hex(rb_or_agg(x'010201000000'));
# 03->SET_32
--error 4070
select hex(rb_or_agg(x'0103'));
--error 4070
select hex(rb_or_agg(x'010300'));
--error 4070
select hex(rb_or_agg(x'010301'));
--error 4070
select hex(rb_or_agg(x'01030101000000'));
select hex(rb_or_agg(x'0103020100000002000000'));
--error 4070
select hex(rb_or_agg(x'0103010100000002000000'));
# 04->SET_64
--error 4070
select hex(rb_or_agg(x'0104'));
--error 4070
select hex(rb_or_agg(x'010400'));
--error 4070
select hex(rb_or_agg(x'010401'));
--error 4070
select hex(rb_or_agg(x'01040101000000'));
--error 4070
select hex(rb_or_agg(x'0104010100000001000000'));
--error 4070
select hex(rb_or_agg(x'0104010100000000000000'));
select hex(rb_or_agg(x'01040201000000000000000200000000000000'));
--error 4070
select hex(rb_or_agg(x'01040201000000000000000100000000000000'));
--error 4070
select hex(rb_or_agg(x'01040201000000010000000100000001000000'));
select hex(rb_or_agg(x'01040201000000010000000100000002000000'));
# 05->BITMAP_32
--error 4070
select hex(rb_or_agg(x'0105'));
select hex(rb_or_agg(x'01053a30000000000000'));
select hex(rb_or_agg(x'01053a3000000100000000000000100000000100'));
select hex(rb_or_agg(x'01053a30000001000000000001001000000001000200'));
select hex(rb_or_agg(x'01053a3000000100000000001f001000000000000100020003000400050006000700080009000a000b000c000d000e000f0010001100120013001400150016001700180019001a001b001c001d001e001f00'));
# 06->BITMAP_64
--error 4070
select hex(rb_or_agg(x'0106'));
select hex(rb_or_agg(x'01060000000000000000'));
select hex(rb_or_agg(x'01060100000000000000000000003a3000000100000000000000100000000100'));
select hex(rb_or_agg(x'01060100000000000000010000003a3000000100000000000000100000000000'));
select hex(rb_or_agg(x'01060100000000000000000000003a30000001000000000001001000000001000200'));
select hex(rb_or_agg(x'01060200000000000000000000003a3000000100000000000000100000000100010000003a3000000100000000000000100000000000'));
select hex(rb_or_agg(x'01060100000000000000000000003a3000000100000000001f001000000000000100020003000400050006000700080009000a000b000c000d000e000f0010001100120013001400150016001700180019001a001b001c001d001e001f00'));
select hex(rb_or_agg(x'01060200000000000000000000003a30000001000000ffff000010000000ffff010000003a3000000100000000001e001000000000000100020003000400050006000700080009000a000b000c000d000e000f0010001100120013001400150016001700180019001a001b001c001d001e00'));
select hex(rb_or_agg(x'01062000000000000000000000003a3000000100000000000000100000000000010000003a3000000100000000000000100000000000020000003a3000000100000000000000100000000000030000003a3000000100000000000000100000000000040000003a3000000100000000000000100000000000050000003a3000000100000000000000100000000000060000003a3000000100000000000000100000000000070000003a3000000100000000000000100000000000080000003a3000000100000000000000100000000000090000003a30000001000000000000001000000000000a0000003a30000001000000000000001000000000000b0000003a30000001000000000000001000000000000c0000003a30000001000000000000001000000000000d0000003a30000001000000000000001000000000000e0000003a30000001000000000000001000000000000f0000003a3000000100000000000000100000000000100000003a3000000100000000000000100000000000110000003a3000000100000000000000100000000000120000003a3000000100000000000000100000000000130000003a3000000100000000000000100000000000140000003a3000000100000000000000100000000000150000003a3000000100000000000000100000000000160000003a3000000100000000000000100000000000170000003a3000000100000000000000100000000000180000003a3000000100000000000000100000000000190000003a30000001000000000000001000000000001a0000003a30000001000000000000001000000000001b0000003a30000001000000000000001000000000001c0000003a30000001000000000000001000000000001d0000003a30000001000000000000001000000000001e0000003a30000001000000000000001000000000001f0000003a3000000100000000000000100000000000'));

# user scenario
--disable_warnings
drop table if exists user_table;
--enable_warnings
create table user_table (rb roaringbitmap, brand_group varchar(10), dim varchar(10));
insert into user_table values(@p1, 'bg1', '0'),
                             (@p2, 'bg2', '1'),
                             (@p3, 'bg1', '2'),
                             (@p4, 'bg3', '3'),
                             (@p5, 'bg1', '4'),
                             (@p6, 'bg2', '10'),
                             (@p7, 'bg1', '21'),
                             (@p6, 'bg2', '4'),
                             (@p5, 'bg3', '1');
SELECT hex(rb_or_agg(rb)) AS aid, brand_group, dim
FROM user_table
WHERE dim IN ('0', '1', '2', '10')
GROUP BY brand_group, dim;

# 2-pahse aggregate optimization
CREATE TABLE t2 (id bigint primary key, k int, rb roaringbitmap);
insert into t2 values (1, 1, @p1),
                      (2, 1, @p2),
                      (3, 1, @p3),
                      (4, 1, @p4),
                      (5, 1, @p5),
                      (6, 1, @p6),
                      (7, 1, @p7),
                      (8, 2, rb_from_string('1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,100')),
                      (9, 2, rb_from_string('1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,101')),
                      (10, 2, rb_from_string('1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,102')),
                      (11, 2, rb_from_string('1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,103')),
                      (12, 2, rb_from_string('1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,104'));

explain select /*+ parallel(1) */ rb_to_string(rb_or_agg(rb)) from t2;
select /*+ parallel(1) */ rb_to_string(rb_or_agg(rb)) from t2;
explain select /*+ parallel(1) */ rb_to_string(rb_and_agg(rb)) from t2;
select /*+ parallel(1) */ rb_to_string(rb_and_agg(rb)) from t2;

explain select /*+ parallel(2) */ k, rb_to_string(rb_or_agg(rb)) from t2 group by k;
--sorted_result
select /*+ parallel(2) */ k, rb_to_string(rb_or_agg(rb)) from t2 group by k;
explain select /*+ parallel(2) */ k, rb_to_string(rb_and_agg(rb)) from t2 group by k;
--sorted_result
select /*+ parallel(2) */ k, rb_to_string(rb_and_agg(rb)) from t2 group by k;

explain select /*+ parallel(2) NO_GBY_PUSHDOWN */ k, rb_to_string(rb_or_agg(rb)) from t2 group by k;
--sorted_result
select /*+ parallel(2) NO_GBY_PUSHDOWN */ k, rb_to_string(rb_or_agg(rb)) from t2 group by k;
explain select /*+ parallel(2) NO_GBY_PUSHDOWN */ k, rb_to_string(rb_and_agg(rb)) from t2 group by k;
--sorted_result
select /*+ parallel(2) NO_GBY_PUSHDOWN */ k, rb_to_string(rb_and_agg(rb)) from t2 group by k;

explain select /*+ parallel(2) GBY_PUSHDOWN */ rb_to_string(rb_or_agg(rb)) from t2;
--sorted_result
select /*+ parallel(2) GBY_PUSHDOWN */ rb_to_string(rb_or_agg(rb)) from t2;
explain select /*+ parallel(2) GBY_PUSHDOWN */ k, rb_to_string(rb_and_agg(rb)) from t2;
--sorted_result
select /*+ parallel(2) GBY_PUSHDOWN*/ k, rb_to_string(rb_and_agg(rb)) from t2;

create table t3(id bigint primary key, c1 bigint, rb roaringbitmap) partition by key(id) partitions 8;
insert into t3 select abs(random(0)), (abs(random(1))%500+455876444690), rb_from_string(cast(abs(random(1))%500+455876444690 as char(10000))) from table(generator(1000));

select count(c1) from t3;
select count(distinct c1)from t3;

explain select /*+ parallel(2) */ rb_cardinality(rb_or_agg(rb)) from t3;
--sorted_result
select /*+ parallel(2) */ rb_cardinality(rb_or_agg(rb)) from t3;
explain select /*+ parallel(2) */ rb_cardinality(rb_and_agg(rb)) from t3;
--sorted_result
select /*+ parallel(2) */ rb_cardinality(rb_and_agg(rb)) from t3;

explain select /*+ parallel(2) opt_param('pushdown_storage_level', 0) */ rb_cardinality(rb_or_agg(rb)) from t3;
--sorted_result
select /*+ parallel(2) opt_param('pushdown_storage_level', 0) */ rb_cardinality(rb_or_agg(rb)) from t3;
explain select /*+ parallel(2) opt_param('pushdown_storage_level', 0) */ rb_cardinality(rb_and_agg(rb)) from t3;
--sorted_result
select /*+ parallel(2) opt_param('pushdown_storage_level', 0) */ rb_cardinality(rb_and_agg(rb)) from t3;

# cleanup
--disable_warnings
drop table if exists t1, t2, t3;
--enable_warnings
