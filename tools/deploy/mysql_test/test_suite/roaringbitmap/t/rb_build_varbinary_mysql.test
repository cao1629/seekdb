#owner: xuqijia.xqj
#owner group: shenzhen
--echo # ----------------------------------------------------------------------
--echo # Base test of rb_build_varbinary.
--echo # ----------------------------------------------------------------------

--disable_warnings
drop table if exists t1,t2;
--enable_warnings

select hex(rb_build_varbinary(null));
--error 4070
select hex(rb_build_varbinary(''));
--error 4070
select hex(rb_build_varbinary(x''));
--error 4070
select hex(rb_build_varbinary('aa'));
--error 3064
select hex(rb_build_varbinary(2));

# 00->EMPTY
select hex(rb_build_varbinary(x'0100'));
--error 4070
select hex(rb_build_varbinary(x'0200'));
# 01->SINGLE_32
select hex(rb_build_varbinary(x'010101000000'));
--error 4070
select hex(rb_build_varbinary(x'01010100000000000000'));
# 02->SINGLE_64
select hex(rb_build_varbinary(x'01020100000001000000'));
--error 4070
select hex(rb_build_varbinary(x'010201000000'));
# 03->SET_32
--error 4070
select hex(rb_build_varbinary(x'0103'));
--error 4070
select hex(rb_build_varbinary(x'010300'));
--error 4070
select hex(rb_build_varbinary(x'010301'));
--error 4070
select hex(rb_build_varbinary(x'01030101000000'));
select hex(rb_build_varbinary(x'0103020100000002000000'));
--error 4070
select hex(rb_build_varbinary(x'0103010100000002000000'));
# 04->SET_64
--error 4070
select hex(rb_build_varbinary(x'0104'));
--error 4070
select hex(rb_build_varbinary(x'010400'));
--error 4070
select hex(rb_build_varbinary(x'010401'));
--error 4070
select hex(rb_build_varbinary(x'01040101000000'));
--error 4070
select hex(rb_build_varbinary(x'0104010100000001000000'));
--error 4070
select hex(rb_build_varbinary(x'0104010100000000000000'));
select hex(rb_build_varbinary(x'01040201000000000000000200000000000000'));
--error 4070
select hex(rb_build_varbinary(x'01040201000000000000000100000000000000'));
--error 4070
select hex(rb_build_varbinary(x'01040201000000010000000100000001000000'));
select hex(rb_build_varbinary(x'01040201000000010000000100000002000000'));
# 05->BITMAP_32
--error 4070
select hex(rb_build_varbinary(x'0105'));
--error 4070
select hex(rb_build_varbinary(x'010500'));
--error 4070
select hex(rb_build_varbinary(x'01053a300000000000000100'));
--error 4070
select hex(rb_build_varbinary(x'01053a300000000000'));
select hex(rb_build_varbinary(x'01053a30000000000000'));
select hex(rb_build_varbinary(x'01053a3000000100000000000000100000000100'));
select hex(rb_build_varbinary(x'01053a30000001000000000001001000000001000200'));
select hex(rb_build_varbinary(x'01053a3000000100000000001f001000000000000100020003000400050006000700080009000a000b000c000d000e000f0010001100120013001400150016001700180019001a001b001c001d001e001f00'));
# 06->BITMAP_64
--error 4070
select hex(rb_build_varbinary(x'0106'));
--error 4070
select hex(rb_build_varbinary(x'010600'));
select hex(rb_build_varbinary(x'01060000000000000000'));
--error 4070
select hex(rb_build_varbinary(x'01060100000000000000000000003a30000001000000000000001000000001000200'));
--error 4070
select hex(rb_build_varbinary(x'01060100000000000000000000003a30000001000000000000001000000001'));
select hex(rb_build_varbinary(x'01060100000000000000000000003a3000000100000000000000100000000100'));
select hex(rb_build_varbinary(x'01060100000000000000010000003a3000000100000000000000100000000000'));
select hex(rb_build_varbinary(x'01060100000000000000000000003a30000001000000000001001000000001000200'));
select hex(rb_build_varbinary(x'01060200000000000000000000003a3000000100000000000000100000000100010000003a3000000100000000000000100000000000'));
select hex(rb_build_varbinary(x'01060100000000000000000000003a3000000100000000001f001000000000000100020003000400050006000700080009000a000b000c000d000e000f0010001100120013001400150016001700180019001a001b001c001d001e001f00'));
select hex(rb_build_varbinary(x'01060200000000000000000000003a30000001000000ffff000010000000ffff010000003a3000000100000000001e001000000000000100020003000400050006000700080009000a000b000c000d000e000f0010001100120013001400150016001700180019001a001b001c001d001e00'));
select hex(rb_build_varbinary(x'01062000000000000000000000003a3000000100000000000000100000000000010000003a3000000100000000000000100000000000020000003a3000000100000000000000100000000000030000003a3000000100000000000000100000000000040000003a3000000100000000000000100000000000050000003a3000000100000000000000100000000000060000003a3000000100000000000000100000000000070000003a3000000100000000000000100000000000080000003a3000000100000000000000100000000000090000003a30000001000000000000001000000000000a0000003a30000001000000000000001000000000000b0000003a30000001000000000000001000000000000c0000003a30000001000000000000001000000000000d0000003a30000001000000000000001000000000000e0000003a30000001000000000000001000000000000f0000003a3000000100000000000000100000000000100000003a3000000100000000000000100000000000110000003a3000000100000000000000100000000000120000003a3000000100000000000000100000000000130000003a3000000100000000000000100000000000140000003a3000000100000000000000100000000000150000003a3000000100000000000000100000000000160000003a3000000100000000000000100000000000170000003a3000000100000000000000100000000000180000003a3000000100000000000000100000000000190000003a30000001000000000000001000000000001a0000003a30000001000000000000001000000000001b0000003a30000001000000000000001000000000001c0000003a30000001000000000000001000000000001d0000003a30000001000000000000001000000000001e0000003a30000001000000000000001000000000001f0000003a3000000100000000000000100000000000'));

--echo test: rb_to_varbinary
--error 3064
select rb_to_varbinary(1);
--error 3064
select rb_to_varbinary(x'0100');
--error 1235
select rb_to_varbinary(rb_build_varbinary(x'0100'), 'Roari');
--error 1235
select rb_to_varbinary(rb_build_varbinary(x'0100'), 'R');
--error 1235
select rb_to_varbinary(rb_build_varbinary(x'0100'), '');
--error 3064
select rb_to_varbinary(rb_build_varbinary(x'0100'), 1);
select hex(rb_to_varbinary(rb_build_varbinary(x'0100'), 'Roaring'));
select hex(rb_to_varbinary(rb_build_varbinary(x'0100'), 'ROARING'));

create table t1(rb roaringbitmap);
INSERT INTO t1 values(rb_build_varbinary(x'0100')),
                     (rb_build_varbinary(x'010101000000')),
                     (rb_build_varbinary(x'01020100000001000000')),
                     (rb_build_varbinary(x'0103020100000002000000')),
                     (rb_build_varbinary(x'01040201000000010000000100000002000000')),
                     (rb_build_varbinary(x'01053a3000000100000000001f001000000000000100020003000400050006000700080009000a000b000c000d000e000f0010001100120013001400150016001700180019001a001b001c001d001e001f00')),
                     (rb_build_varbinary(x'01062000000000000000000000003a3000000100000000000000100000000000010000003a3000000100000000000000100000000000020000003a3000000100000000000000100000000000030000003a3000000100000000000000100000000000040000003a3000000100000000000000100000000000050000003a3000000100000000000000100000000000060000003a3000000100000000000000100000000000070000003a3000000100000000000000100000000000080000003a3000000100000000000000100000000000090000003a30000001000000000000001000000000000a0000003a30000001000000000000001000000000000b0000003a30000001000000000000001000000000000c0000003a30000001000000000000001000000000000d0000003a30000001000000000000001000000000000e0000003a30000001000000000000001000000000000f0000003a3000000100000000000000100000000000100000003a3000000100000000000000100000000000110000003a3000000100000000000000100000000000120000003a3000000100000000000000100000000000130000003a3000000100000000000000100000000000140000003a3000000100000000000000100000000000150000003a3000000100000000000000100000000000160000003a3000000100000000000000100000000000170000003a3000000100000000000000100000000000180000003a3000000100000000000000100000000000190000003a30000001000000000000001000000000001a0000003a30000001000000000000001000000000001b0000003a30000001000000000000001000000000001c0000003a30000001000000000000001000000000001d0000003a30000001000000000000001000000000001e0000003a30000001000000000000001000000000001f0000003a3000000100000000000000100000000000'));
select hex(rb) from t1;
select hex(rb_to_varbinary(rb)) from t1;

create table t2(rb_bin varbinary(100), rb roaringbitmap generated always as (rb_build_varbinary(rb_bin)));
INSERT INTO t2(rb_bin) values(x'0100'), (x'010101000000');
select hex(rb_bin), hex(rb) from t2;

--echo test: rb_to_varbinary inner format
# 00->EMPTY
select hex(rb_to_varbinary(rb_build_varbinary(x'0100')));
# 01->SINGLE_32
select hex(rb_to_varbinary(rb_build_varbinary(x'010101000000')));
# 02->SINGLE_64
select hex(rb_to_varbinary(rb_build_varbinary(x'01020100000001000000')));
# 03->SET_32
--error 4070
select hex(rb_to_varbinary(rb_build_varbinary(x'010300')));
--error 4070
select hex(rb_to_varbinary(rb_build_varbinary(x'01030101000000')));
select hex(rb_to_varbinary(rb_build_varbinary(x'0103020100000002000000')));
# 04->SET_64
--error 4070
select hex(rb_to_varbinary(rb_build_varbinary(x'010400')));
--error 4070
select hex(rb_to_varbinary(rb_build_varbinary(x'0104010100000001000000')));
--error 4070
select hex(rb_to_varbinary(rb_build_varbinary(x'0104010100000000000000')));
select hex(rb_to_varbinary(rb_build_varbinary(x'01040201000000000000000200000000000000')));
--error 4070
select hex(rb_to_varbinary(rb_build_varbinary(x'01040201000000000000000100000000000000')));
--error 4070
select hex(rb_to_varbinary(rb_build_varbinary(x'01040201000000010000000100000001000000')));
select hex(rb_to_varbinary(rb_build_varbinary(x'01040201000000010000000100000002000000')));
# 05->BITMAP_32
select hex(rb_to_varbinary(rb_build_varbinary(x'01053a30000000000000')));
select hex(rb_to_varbinary(rb_build_varbinary(x'01053a3000000100000000000000100000000100')));
select hex(rb_to_varbinary(rb_build_varbinary(x'01053a30000001000000000001001000000001000200')));
select hex(rb_to_varbinary(rb_build_varbinary(x'01053a3000000100000000001f001000000000000100020003000400050006000700080009000a000b000c000d000e000f0010001100120013001400150016001700180019001a001b001c001d001e001f00')));
# 06->BITMAP_64
select hex(rb_to_varbinary(rb_build_varbinary(x'01060000000000000000')));
select hex(rb_to_varbinary(rb_build_varbinary(x'01060100000000000000000000003a3000000100000000000000100000000100')));
select hex(rb_to_varbinary(rb_build_varbinary(x'01060100000000000000010000003a3000000100000000000000100000000000')));
select hex(rb_to_varbinary(rb_build_varbinary(x'01060100000000000000000000003a30000001000000000001001000000001000200')));
select hex(rb_to_varbinary(rb_build_varbinary(x'01060200000000000000000000003a3000000100000000000000100000000100010000003a3000000100000000000000100000000000')));
select hex(rb_to_varbinary(rb_build_varbinary(x'01060100000000000000000000003a3000000100000000001f001000000000000100020003000400050006000700080009000a000b000c000d000e000f0010001100120013001400150016001700180019001a001b001c001d001e001f00')));
select hex(rb_to_varbinary(rb_build_varbinary(x'01060200000000000000000000003a30000001000000ffff000010000000ffff010000003a3000000100000000001e001000000000000100020003000400050006000700080009000a000b000c000d000e000f0010001100120013001400150016001700180019001a001b001c001d001e00')));
select hex(rb_to_varbinary(rb_build_varbinary(x'01062000000000000000000000003a3000000100000000000000100000000000010000003a3000000100000000000000100000000000020000003a3000000100000000000000100000000000030000003a3000000100000000000000100000000000040000003a3000000100000000000000100000000000050000003a3000000100000000000000100000000000060000003a3000000100000000000000100000000000070000003a3000000100000000000000100000000000080000003a3000000100000000000000100000000000090000003a30000001000000000000001000000000000a0000003a30000001000000000000001000000000000b0000003a30000001000000000000001000000000000c0000003a30000001000000000000001000000000000d0000003a30000001000000000000001000000000000e0000003a30000001000000000000001000000000000f0000003a3000000100000000000000100000000000100000003a3000000100000000000000100000000000110000003a3000000100000000000000100000000000120000003a3000000100000000000000100000000000130000003a3000000100000000000000100000000000140000003a3000000100000000000000100000000000150000003a3000000100000000000000100000000000160000003a3000000100000000000000100000000000170000003a3000000100000000000000100000000000180000003a3000000100000000000000100000000000190000003a30000001000000000000001000000000001a0000003a30000001000000000000001000000000001b0000003a30000001000000000000001000000000001c0000003a30000001000000000000001000000000001d0000003a30000001000000000000001000000000001e0000003a30000001000000000000001000000000001f0000003a3000000100000000000000100000000000')));

--echo test: rb_to_varbinary to roaring format
# 00->EMPTY
select hex(rb_to_varbinary(rb_build_varbinary(x'0100'), 'roaring'));
# 01->SINGLE_32
select hex(rb_to_varbinary(rb_build_varbinary(x'010101000000'), 'roaring'));
# 02->SINGLE_64
select hex(rb_to_varbinary(rb_build_varbinary(x'01020100000001000000'), 'roaring'));
# 03->SET_32
--error 4070
select hex(rb_to_varbinary(rb_build_varbinary(x'010300'), 'roaring'));
--error 4070
select hex(rb_to_varbinary(rb_build_varbinary(x'01030101000000'), 'roaring'));
select hex(rb_to_varbinary(rb_build_varbinary(x'0103020100000002000000'), 'roaring'));
# 04->SET_64
--error 4070
select hex(rb_to_varbinary(rb_build_varbinary(x'010400'), 'roaring'));
--error 4070
select hex(rb_to_varbinary(rb_build_varbinary(x'0104010100000001000000'), 'roaring'));
--error 4070
select hex(rb_to_varbinary(rb_build_varbinary(x'0104010100000000000000'), 'roaring'));
select hex(rb_to_varbinary(rb_build_varbinary(x'01040201000000000000000200000000000000'), 'roaring'));
select hex(rb_to_varbinary(rb_build_varbinary(x'01040201000000010000000100000002000000'), 'roaring'));
# 05->BITMAP_32
select hex(rb_to_varbinary(rb_build_varbinary(x'01053a30000000000000'), 'roaring'));
select hex(rb_to_varbinary(rb_build_varbinary(x'01053a3000000100000000000000100000000100'), 'roaring'));
select hex(rb_to_varbinary(rb_build_varbinary(x'01053a30000001000000000001001000000001000200'), 'roaring'));
select hex(rb_to_varbinary(rb_build_varbinary(x'01053a3000000100000000001f001000000000000100020003000400050006000700080009000a000b000c000d000e000f0010001100120013001400150016001700180019001a001b001c001d001e001f00'), 'roaring'));
# 06->BITMAP_64
select hex(rb_to_varbinary(rb_build_varbinary(x'01060000000000000000'), 'roaring'));
select hex(rb_to_varbinary(rb_build_varbinary(x'01060100000000000000000000003a3000000100000000000000100000000100'), 'roaring'));
select hex(rb_to_varbinary(rb_build_varbinary(x'01060100000000000000010000003a3000000100000000000000100000000000'), 'roaring'));
select hex(rb_to_varbinary(rb_build_varbinary(x'01060100000000000000000000003a30000001000000000001001000000001000200'), 'roaring'));
select hex(rb_to_varbinary(rb_build_varbinary(x'01060200000000000000000000003a3000000100000000000000100000000100010000003a3000000100000000000000100000000000'), 'roaring'));
select hex(rb_to_varbinary(rb_build_varbinary(x'01060100000000000000000000003a3000000100000000001f001000000000000100020003000400050006000700080009000a000b000c000d000e000f0010001100120013001400150016001700180019001a001b001c001d001e001f00'), 'roaring'));
select hex(rb_to_varbinary(rb_build_varbinary(x'01060200000000000000000000003a30000001000000ffff000010000000ffff010000003a3000000100000000001e001000000000000100020003000400050006000700080009000a000b000c000d000e000f0010001100120013001400150016001700180019001a001b001c001d001e00'), 'roaring'));
select hex(rb_to_varbinary(rb_build_varbinary(x'01062000000000000000000000003a3000000100000000000000100000000000010000003a3000000100000000000000100000000000020000003a3000000100000000000000100000000000030000003a3000000100000000000000100000000000040000003a3000000100000000000000100000000000050000003a3000000100000000000000100000000000060000003a3000000100000000000000100000000000070000003a3000000100000000000000100000000000080000003a3000000100000000000000100000000000090000003a30000001000000000000001000000000000a0000003a30000001000000000000001000000000000b0000003a30000001000000000000001000000000000c0000003a30000001000000000000001000000000000d0000003a30000001000000000000001000000000000e0000003a30000001000000000000001000000000000f0000003a3000000100000000000000100000000000100000003a3000000100000000000000100000000000110000003a3000000100000000000000100000000000120000003a3000000100000000000000100000000000130000003a3000000100000000000000100000000000140000003a3000000100000000000000100000000000150000003a3000000100000000000000100000000000160000003a3000000100000000000000100000000000170000003a3000000100000000000000100000000000180000003a3000000100000000000000100000000000190000003a30000001000000000000001000000000001a0000003a30000001000000000000001000000000001b0000003a30000001000000000000001000000000001c0000003a30000001000000000000001000000000001d0000003a30000001000000000000001000000000001e0000003a30000001000000000000001000000000001f0000003a3000000100000000000000100000000000'), 'roaring'));

# bugfix: 2024071200103692281
select hex(rb_to_varbinary(rb_build_varbinary(x'0100'), '  roaring'));
select hex(rb_to_varbinary(rb_build_varbinary(x'0100'), 'roaring  '));
--error 1235
select hex(rb_to_varbinary(rb_build_varbinary(x'0100'), ' roa ring  '));
--error 1235
select hex(rb_to_varbinary(rb_build_varbinary(x'0100'), 'roar
ing  '));

# bugfix: 2024072000103866107
select hex(rb_from_string('10,
-2'));
select hex(rb_from_string('10
,2'));
select hex(rb_from_string('10 \n, \n2'));
select hex(rb_from_string('10 \t, \t\n2'));
select hex(rb_from_string('10 \t, \t\n-2'));
--error 4070
select rb_from_string('10 \t, \t-\n2');

# cleanup
--disable_warnings
drop table if exists t1,t2;
--enable_warnings
