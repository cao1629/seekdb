#owner: xuqijia.xqj
#owner group: shenzhen
--echo # ----------------------------------------------------------------------
--echo # Base test of roaringbitmap rb_build_agg.
--echo # ----------------------------------------------------------------------


--echo #
--echo # Setup test.
--echo #
--disable_warnings
drop table if exists t1, t2, t3, t4, t5;
--enable_warnings

CREATE TABLE t1 (id int, k int, val bigint);
INSERT INTO t1 VALUES
  (1, 1, NULL),
  (2, 1, 1),
  (3, 2, 4294967295 + 2),
  (4, 2, 3),
  (5, 3, 4),
  (6, 3, 5),
  (7, 3, 6),
  (8, 4, 1),
  (9, 4, 4294967295 + 2),
  (10, 5, 4294967295 + 3),
  (11, 5, 4294967295 + 4),
  (12, 5, 4294967295 + 5);

SELECT k, RB_TO_STRING(RB_BUILD_AGG(val)), hex(RB_BUILD_AGG(val)) FROM t1 GROUP BY k;
SELECT RB_TO_STRING(RB_BUILD_AGG(val)), hex(RB_BUILD_AGG(val)) FROM t1 ;

CREATE TABLE t2 (val bigint);
insert into t2 values (0),(1),(2),(3),(4),(5),(6),(7),(8),(9),(10),(11),(12),(13),(14),(15),(16),(17),(18),(19),(20),(21),(22),(23),(24),(25),(26),(27),(28),(29),(30),(31),(32);
SELECT RB_TO_STRING(RB_BUILD_AGG(val)), hex(RB_BUILD_AGG(val)) FROM t2;
insert into t2 values (4294967295 + 1);
SELECT RB_TO_STRING(RB_BUILD_AGG(val)), hex(RB_BUILD_AGG(val)) FROM t2;

CREATE TABLE t3 (id int, k int, val int);
INSERT INTO t3 VALUES
  (1, 1, NULL),
  (2, 1, 1),
  (3, 2, 2),
  (4, 3, 3),
  (5, 3, 4),
  (6, 3, 5),
  (7, 4, NULL);

SELECT k, RB_TO_STRING(RB_BUILD_AGG(val)), hex(RB_BUILD_AGG(val)) FROM t3 GROUP BY k;

CREATE TABLE t4 (id int, var_float float, var_double double, var_varchar varchar(10));
insert into t4 values(1, NULL, NULL, NULL);
--error 3064
SELECT RB_BUILD_AGG(var_float) FROM t4;
--error 3064
SELECT RB_BUILD_AGG(var_double) FROM t4;
--error 3064
SELECT RB_BUILD_AGG(var_varchar) FROM t4;
insert into t4 values(2, 1, 1, '1');
--error 3064
SELECT RB_BUILD_AGG(var_float) FROM t4;
--error 3064
SELECT RB_BUILD_AGG(var_double) FROM t4;
--error 3064
SELECT RB_BUILD_AGG(var_varchar) FROM t4;

CREATE TABLE t5 (var_bool bool, var_tinyint tinyint, var_smallint smallint, var_mediumint mediumint, var_integer integer, var_bigint bigint);
insert into t5 values(1, 127, 32767, 8388607, 2147483647, 9223372036854775807);
SELECT RB_TO_STRING(RB_BUILD_AGG(var_bool)) FROM t5;
SELECT RB_TO_STRING(RB_BUILD_AGG(var_tinyint)) FROM t5;
SELECT RB_TO_STRING(RB_BUILD_AGG(var_smallint)) FROM t5;
SELECT RB_TO_STRING(RB_BUILD_AGG(var_mediumint)) FROM t5;
SELECT RB_TO_STRING(RB_BUILD_AGG(var_integer)) FROM t5;
SELECT RB_TO_STRING(RB_BUILD_AGG(var_bigint)) FROM t5;
insert into t5 values(0, -128, -32768, -8388608, -2147483648, -9223372036854775808);
SELECT RB_TO_STRING(RB_BUILD_AGG(var_bool)) FROM t5;
SELECT RB_TO_STRING(RB_BUILD_AGG(var_tinyint)) FROM t5;
SELECT RB_TO_STRING(RB_BUILD_AGG(var_smallint)) FROM t5;
SELECT RB_TO_STRING(RB_BUILD_AGG(var_mediumint)) FROM t5;
SELECT RB_TO_STRING(RB_BUILD_AGG(var_integer)) FROM t5;
--error 4019
SELECT RB_TO_STRING(RB_BUILD_AGG(var_bigint)) FROM t5;

select rb_to_string(RB_BUILD_AGG(-1));
select rb_to_string(RB_BUILD_AGG(-2147483648));
--error 4019
select rb_to_string(RB_BUILD_AGG(-2147483649));
--error 4019
select rb_to_string(RB_BUILD_AGG(-9223372036854775808));
select rb_to_string(RB_BUILD_AGG(2147483647));
select rb_to_string(RB_BUILD_AGG(2147483648));
select rb_to_string(RB_BUILD_AGG(18446744073709551615));
--error 3064
select rb_to_string(RB_BUILD_AGG(18446744073709551616));

select hex(RB_BUILD_AGG(NULL));
select hex(RB_BUILD_AGG(1));
select hex(RB_BUILD_AGG(-1));
--error 1241
SELECT RB_BUILD_AGG((SELECT 1, 1));

# cleanup
--disable_warnings
drop table if exists t1, t2, t3, t4, t5;
--enable_warnings

create table t1(id bigint primary key, c1 bigint) partition by key(id) partitions 8;
insert into t1 select abs(random(0)), (abs(random(1))%500+455876444690) from table(generator(1000));

select count(c1) from t1;
select count(distinct c1)from t1;

explain basic select RB_CARDINALITY(rb_build_agg(c1)) from t1;
select RB_CARDINALITY(rb_build_agg(c1)) from t1;

explain basic select /*+ NO_GBY_PUSHDOWN */ RB_CARDINALITY(rb_build_agg(c1)) from t1;
select /*+ NO_GBY_PUSHDOWN */ RB_CARDINALITY(rb_build_agg(c1)) from t1;

explain basic select /*+ opt_param('pushdown_storage_level', 0) */  RB_CARDINALITY(rb_build_agg(c1)) from t1;
select /*+ opt_param('pushdown_storage_level', 0) */  RB_CARDINALITY(rb_build_agg(c1)) from t1;

#explain basic select /*+ opt_param('enable_rich_vector_format', 'false') */  RB_CARDINALITY(rb_build_agg(c1)) from t1;
select /*+ opt_param('enable_rich_vector_format', 'false') */  RB_CARDINALITY(rb_build_agg(c1)) from t1;

explain basic select /*+ NO_GBY_PUSHDOWN opt_param('pushdown_storage_level', 0) */  count(distinct c1) from t1;
select /*+ NO_GBY_PUSHDOWN opt_param('pushdown_storage_level', 0) */  count(distinct c1) from t1;

explain basic select RB_CARDINALITY(rb_build_agg(c1)),  count(distinct c1)from t1;
select RB_CARDINALITY(rb_build_agg(c1)),  count(distinct c1)from t1;

drop table if exists t1;
#set ob_sql_work_area_percentage = 100;
#alter system set _hash_area_size = '10G';
#alter system set _sort_area_size = '10G';

create table t1(id bigint primary key, c1 bigint, c2 bigint, c3 bigint) partition by key(id) partitions 8 with column group (all columns, each column);
insert into t1 select abs(random(0)), (abs(random(1))%50000000+455876444690), (abs(random(1))%20+455876444690), abs(random(1)%50000000) from table(generator(1000));

select /*+ NO_USE_HASH_AGGREGATION  */ RB_CARDINALITY(rb_build_agg(c1)), sum(c3) from t1 group by c2 ;
select /*+ NO_USE_HASH_AGGREGATION  */ count(distinct c1), sum(c3) from t1 group by c2;

select c2, RB_CARDINALITY(rb_build_agg(c1)), sum(c3) from t1 group by c2;
select c2, count(distinct c1), sum(c3) from t1 group by c2;

select c2, RB_CARDINALITY(rb_build_agg(c1)), sum(c3) from t1 group by c2 with rollup ;
select /*+ NO_GBY_PUSHDOWN */ c2, RB_CARDINALITY(rb_build_agg(c1)), sum(c3) from t1 group by c2 with rollup ;

drop table if exists t1;

create table t1(id bigint primary key, c1 bigint, c2 bigint, c3 bigint) partition by key(id) partitions 8;
insert into t1 select abs(random(0)), NULL, (abs(random(1))%5+455876444690), abs(random(1)%50000000) from table(generator(100));
select /*+ NO_GBY_PUSHDOWN */ c2, RB_CARDINALITY(rb_build_agg(c1)), sum(c3) from t1 group by c2 with rollup ;
drop table if exists t1;

create table t1(id bigint primary key, c1 decimal(6,2));
# decimal may not be integer, so not support
--error 3064
select RB_CARDINALITY(rb_build_agg(c1)) from t1;
drop table if exists t1;
