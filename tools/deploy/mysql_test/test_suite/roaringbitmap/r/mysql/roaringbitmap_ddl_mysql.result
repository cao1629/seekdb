# ----------------------------------------------------------------------
# Base test of roaringbitmap ddl.
# ----------------------------------------------------------------------
Verify that ROARINGBITMAP columns do not support indexes on create table
CREATE TABLE bad(i INT, rb ROARINGBITMAP NOT NULL PRIMARY KEY);
ERROR 42000: The used storage engine can't index column 'rb'
CREATE TABLE bad(i INT, rb ROARINGBITMAP NOT NULL, INDEX rbindex (rb));
ERROR 42000: The used storage engine can't index column 'rb'
CREATE TABLE bad(i INT, rb ROARINGBITMAP NOT NULL, UNIQUE INDEX rbindex (rb));
ERROR 42000: The used storage engine can't index column 'rb'
CREATE TABLE bad(i INT, rb ROARINGBITMAP NOT NULL, UNIQUE INDEX rbindex (rb) USING HASH);
ERROR 42000: The used storage engine can't index column 'rb'
drop table if exists t1,t2,t3,t4,t5,t6,t7,t8,t9;
drop table if exists tt1, tt2, tt3, tt4;
drop table if exists roaringbitmap_ddl_t;
CREATE TABLE t1(i INT PRIMARY KEY);
ALTER TABLE t1 ADD COLUMN rb1 ROARINGBITMAP;
ALTER TABLE t1 ADD COLUMN rb2 ROARINGBITMAP NOT NULL;
ALTER TABLE t1 ADD COLUMN rb3 ROARINGBITMAP default NULL;
ALTER TABLE t1 ADD COLUMN rb4 ROARINGBITMAP default x'0100';
ALTER TABLE t1 ADD COLUMN rb5 ROARINGBITMAP default x'01060100000000000000000000003a3000000100000000000000100000000100';
CREATE INDEX t1_idx_rb ON t1(rb1);
ERROR 42000: The used storage engine can't index column 'rb1'
CREATE INDEX t1_idx_i_rb ON t1(i, rb1);
ERROR 42000: The used storage engine can't index column 'rb1'
CREATE INDEX t1_idx_rb_i ON t1(rb1, i);
ERROR 42000: The used storage engine can't index column 'rb1'
CREATE INDEX t1_idx_i ON t1(i);
DROP INDEX t1_idx_i ON t1;
DROP TABLE t1;
Verify that ROARINGBITMAP columns do not support indexes on alter table
CREATE TABLE t2(i INT PRIMARY KEY, rb1 ROARINGBITMAP, rb2 ROARINGBITMAP NOT NULL);
ALTER TABLE t2 ADD INDEX rb1_idx (rb1);
ERROR 42000: The used storage engine can't index column 'rb1'
ALTER TABLE t2 ADD UNIQUE INDEX rb1_idx (rb1);
ERROR 42000: The used storage engine can't index column 'rb1'
ALTER TABLE t2 ADD UNIQUE INDEX rb1_idx (rb1) USING HASH;
ERROR 42000: The used storage engine can't index column 'rb1'
Verify that ROARINGBITMAP columns can be dropped
ALTER TABLE t2 DROP COLUMN rb1;
ALTER TABLE t2 DROP COLUMN rb2;
desc t2;
Field	Type	Null	Key	Default	Extra
i	int(11)	NO	PRI	NULL
DROP TABLE t2;
CREATE TABLE roaringbitmap(roaringbitmap int);
INSERT INTO roaringbitmap(roaringbitmap) VALUES (1);
SELECT roaringbitmap FROM roaringbitmap;
roaringbitmap
1
DROP TABLE roaringbitmap;
DROP PROCEDURE p;
CREATE PROCEDURE p()
BEGIN
roaringbitmap: LOOP
LEAVE roaringbitmap;
END LOOP roaringbitmap;
END|
CALL p();
CREATE TABLE t1(txt TEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_bin);
ALTER TABLE t1 MODIFY COLUMN txt ROARINGBITMAP;
ERROR 0A000: Modify other type to roaringbitmap not supported
ALTER TABLE t1 CHANGE COLUMN txt rb ROARINGBITMAP;
ERROR 0A000: Modify other type to roaringbitmap not supported
drop table t1;
CREATE TABLE t1(txt TEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_bin);
INSERT INTO t1 VALUES ('not ROARINGBITMAP');
ALTER TABLE t1 MODIFY COLUMN txt ROARINGBITMAP;
ERROR 0A000: Modify other type to roaringbitmap not supported
SELECT * FROM t1;
txt
not ROARINGBITMAP
CREATE TABLE t2(rb ROARINGBITMAP);
INSERT INTO t2 VALUES (x'0100');
ALTER TABLE t2 MODIFY COLUMN rb ROARINGBITMAP NOT NULL;
SELECT hex(rb) FROM t2;
hex(rb)
0100
ALTER TABLE t2 MODIFY COLUMN rb TEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_bin;
SELECT hex(rb) FROM t2;
hex(rb)
0100
ALTER TABLE t2 MODIFY COLUMN rb ROARINGBITMAP;
ERROR 0A000: Modify other type to roaringbitmap not supported
CREATE TABLE t3 (rb ROARINGBITMAP);
INSERT INTO t3 VALUES (x'0100');
select hex(rb) from t3;
hex(rb)
0100
CREATE TABLE t4 AS SELECT UPPER(rb) AS rb_text FROM t3;
INSERT INTO t4 VALUES ('not ROARINGBITMAP');
ALTER TABLE t4 MODIFY COLUMN rb_text ROARINGBITMAP;
ERROR 0A000: Modify other type to roaringbitmap not supported
SELECT hex(rb_text) FROM t4 order by rb_text;
hex(rb_text)
0100
6E6F7420524F4152494E474249544D4150
create table t5 (c1 int);
insert into t5 values(1),(2);
alter table t5 add column rb1 roaringbitmap;
alter table t5 add column rb2 roaringbitmap not null;
alter table t5 add column rb3 roaringbitmap default null;
alter table t5 add column rb4 roaringbitmap default x'01020000000000000002';
alter table t5 add column rb5 roaringbitmap default x'01053a30000001000000000001001000000001000200';
select c1, hex(rb1), hex(rb2), hex(rb3), hex(rb4), hex(rb5)  from t5;
c1	hex(rb1)	hex(rb2)	hex(rb3)	hex(rb4)	hex(rb5)
1	NULL	0100	NULL	01020000000000000002	0103020100000002000000
2	NULL	0100	NULL	01020000000000000002	0103020100000002000000
alter table t5 change rb1 rb1 roaringbitmap default null;
alter table t5 change rb2 rb2 roaringbitmap not null;
alter table t5 change rb3 rb3 roaringbitmap;
select c1, hex(rb1), hex(rb2), hex(rb3), hex(rb4), hex(rb5) from t5;
c1	hex(rb1)	hex(rb2)	hex(rb3)	hex(rb4)	hex(rb5)
1	NULL	0100	NULL	01020000000000000002	0103020100000002000000
2	NULL	0100	NULL	01020000000000000002	0103020100000002000000
create table t6(rb1 roaringbitmap,rb2 roaringbitmap);
insert into t6 values(x'0100', x'010100000002'), (null, null);
select hex(rb1), hex(rb2) from t6;
hex(rb1)	hex(rb2)
0100	010100000002
NULL	NULL
create table t7 select cast(rb1 as char character set utf8mb4) a from t6 order by 1;
ERROR 22001: Data too long for column
drop table t1, t2;
create table t8(rb roaringbitmap not null);
insert ignore into t8 values(null);
ERROR 23000: Column 'rb' cannot be null
select hex(rb) from t8;
hex(rb)
drop table t8;
create table t9(rb roaringbitmap);
ALTER TABLE t9 MODIFY COLUMN rb INT;
ERROR 0A000: Modify roaringbitmap to other type except string not supported
ALTER TABLE t9 CHANGE COLUMN rb i INT;
ERROR 0A000: Modify roaringbitmap to other type except string not supported
insert into t9 values(x'0100');
alter table t9 change rb rb text;
select hex(rb) from t9;
hex(rb)
0100
alter table t9 modify rb roaringbitmap;
ERROR 0A000: Modify other type to roaringbitmap not supported
create table tt1 as select rb_build_empty();
desc tt1;
Field	Type	Null	Key	Default	Extra
rb_build_empty()	roaringbitmap	YES		NULL
create table tt2 as select rb_from_string('');
desc tt2;
Field	Type	Null	Key	Default	Extra
rb_from_string('')	roaringbitmap	YES		NULL
create table tt3 as select rb_build_varbinary(0x01030401000000020000000300000004000000);
desc tt3;
Field	Type	Null	Key	Default	Extra
rb_build_varbinary(0x01030401000000020000000300000004000000)	roaringbitmap	YES		NULL
create table tt4 as select rb_build_agg(1);
desc tt4;
Field	Type	Null	Key	Default	Extra
rb_build_agg(1)	roaringbitmap	YES		NULL
create table roaringbitmap_ddl_t (rb roaringbitmap DEFAULT 0x0100);
show create table roaringbitmap_ddl_t;
Table	Create Table
roaringbitmap_ddl_t	CREATE TABLE `roaringbitmap_ddl_t` (
  `rb` roaringbitmap DEFAULT X'0100'
) ORGANIZATION INDEX DEFAULT CHARSET = utf8mb4 ROW_FORMAT = DYNAMIC COMPRESSION = 'zstd_1.3.8' REPLICA_NUM =  BLOCK_SIZE = 16384 USE_BLOOM_FILTER = FALSE ENABLE_MACRO_BLOCK_BLOOM_FILTER = FALSE TABLET_SIZE = 134217728 PCTFREE = 0
desc roaringbitmap_ddl_t;
Field	Type	Null	Key	Default	Extra
rb	roaringbitmap	YES		X'0100'
select ddl_stmt_str from oceanbase.__all_ddl_operation where ddl_stmt_str like '%roaringbitmap%' order by gmt_create desc limit 22;
ddl_stmt_str
create table roaringbitmap_ddl_t (rb roaringbitmap DEFAULT 0x0100)
create table t9(rb roaringbitmap)
create table t8(rb roaringbitmap not null)
create table t6(rb1 roaringbitmap,rb2 roaringbitmap)
alter table t5 change rb3 rb3 roaringbitmap
alter table t5 change rb2 rb2 roaringbitmap not null
alter table t5 change rb1 rb1 roaringbitmap default null
alter table t5 add column rb5 roaringbitmap default x'01053a30000001000000000001001000000001000200'
alter table t5 add column rb4 roaringbitmap default x'01020000000000000002'
alter table t5 add column rb3 roaringbitmap default null
alter table t5 add column rb2 roaringbitmap not null
alter table t5 add column rb1 roaringbitmap
CREATE TABLE t3 (rb ROARINGBITMAP)
ALTER TABLE t2 MODIFY COLUMN rb ROARINGBITMAP NOT NULL
CREATE TABLE t2(rb ROARINGBITMAP)
CREATE PROCEDURE p()
BEGIN
roaringbitmap: LOOP
LEAVE roaringbitmap;
END LOOP roaringbitmap;
END
DROP TABLE `test`.`roaringbitmap`
CREATE TABLE roaringbitmap(roaringbitmap int)
CREATE TABLE t2(i INT PRIMARY KEY, rb1 ROARINGBITMAP, rb2 ROARINGBITMAP NOT NULL)
ALTER TABLE t1 ADD COLUMN rb5 ROARINGBITMAP default x'01060100000000000000000000003a3000000100000000000000100000000100'
ALTER TABLE t1 ADD COLUMN rb4 ROARINGBITMAP default x'0100'
ALTER TABLE t1 ADD COLUMN rb3 ROARINGBITMAP default NULL
select TABLE_NAME, COLUMN_NAME, DATA_TYPE, DATA_LENGTH, DATA_PRECISION, DATA_SCALE from  CDB_TAB_COLS_V$ where table_name='roaringbitmap_ddl_t';
TABLE_NAME	COLUMN_NAME	DATA_TYPE	DATA_LENGTH	DATA_PRECISION	DATA_SCALE
roaringbitmap_ddl_t	rb	ROARINGBITMAP	0	NULL	NULL
drop table if exists t1,t2,t3,t4,t5,t6,t7,t8,t9;
drop table if exists tt1, tt2, tt3, tt4;
drop table if exists roaringbitmap_ddl_t;
create table tt1 (c1 roaringbitmap DEFAULT X'0100');
create table tt2 (c1 int, c2 blob NOT NULL);
insert into  tt2 values (1,unhex('4450534e3731')),(1,unhex('3829'));
select * from tt2 order by c1, c2;
c1	c2
1	8)
1	DPSN71
replace /*+USE_PLAN_CACHE(NONE)*/into tt1 (c1) values (x'0100');
select * from tt2 order by c1, c2;
c1	c2
1	8)
1	DPSN71
drop table if exists test;
create table test(rb roaringbitmap, c1 int, c2 float, c3 decimal(3,3), c4 bit(20), c5 geometry, c6 roaringbitmap, c7 json);
select * from test where rb = c1;
ERROR 22000: Invalid data type for the operation
select * from test where rb = c2;
ERROR 22000: Invalid data type for the operation
select * from test where rb = c3;
ERROR 22000: Invalid data type for the operation
select * from test where rb = c4;
ERROR 22000: Invalid data type for the operation
select * from test where rb = c5;
ERROR 22000: Invalid data type for the operation
select * from test where rb = c6;
ERROR 22000: Invalid data type for the operation
select * from test where rb = c7;
ERROR 22000: Invalid data type for the operation
drop table test;
