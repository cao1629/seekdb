# ----------------------------------------------------------------------
# Base test of roaringbitmap rb_or_agg, rb_and_agg.
# ----------------------------------------------------------------------
#
# Setup test.
#
drop table if exists t1, t2, t3;
SET @p1 = x'0100';
SET @p2 = x'010101000000';
SET @p3 = x'010102000000';
SET @p4 = x'010303010000000200000003000000';
SET @p5 = x'010303020000000300000004000000';
SET @p6 = x'01060100000000000000000000003a30000001000000000020001000000000000100020003000400050006000700080009000a000b000c000d000e000f0010001100120013001400150016001700180019001a001b001c001d001e001f002000';
SET @p7 = x'01060100000000000000000000003a3000000100000000002000100000000a000b000c000d000e000f0010001100120013001400150016001700180019001a001b001c001d001e001f0020002100220023002400250026002700280029002a00';
CREATE TABLE t1 (k int, rb roaringbitmap);
INSERT INTO t1 VALUES
(1, NULL),
(1, @p1),
(1, @p2),
(2, @p1),
(2, @p2),
(3, @p2),
(3, @p1),
(4, @p1),
(4, @p4),
(5, @p4),
(5, @p1),
(6, @p1),
(6, @p6),
(7, @p6),
(7, @p1),
(8, @p2),
(8, @p3),
(9, @p2),
(9, @p4),
(10, @p4),
(10, @p2),
(11, @p2),
(11, @p6),
(12, @p6),
(12, @p2),
(13, @p4),
(13, @p5),
(14, @p4),
(14, @p6),
(15, @p6),
(15, @p4),
(16, @p6),
(16, @p7);
test: rb_or_agg calculate
SELECT k, rb_to_string(rb_or_agg(rb)), hex(rb_or_agg(rb)) FROM t1 GROUP BY k ORDER BY k;
k	rb_to_string(rb_or_agg(rb))	hex(rb_or_agg(rb))
1	1	010101000000
2	1	010101000000
3	1	010101000000
4	1,2,3	010303010000000200000003000000
5	1,2,3	010303010000000200000003000000
6	0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32	01060100000000000000000000003A30000001000000000020001000000000000100020003000400050006000700080009000A000B000C000D000E000F0010001100120013001400150016001700180019001A001B001C001D001E001F002000
7	0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32	01060100000000000000000000003A30000001000000000020001000000000000100020003000400050006000700080009000A000B000C000D000E000F0010001100120013001400150016001700180019001A001B001C001D001E001F002000
8	1,2	0103020100000002000000
9	1,2,3	010303010000000200000003000000
10	1,2,3	010303010000000200000003000000
11	0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32	01060100000000000000000000003A30000001000000000020001000000000000100020003000400050006000700080009000A000B000C000D000E000F0010001100120013001400150016001700180019001A001B001C001D001E001F002000
12	0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32	01060100000000000000000000003A30000001000000000020001000000000000100020003000400050006000700080009000A000B000C000D000E000F0010001100120013001400150016001700180019001A001B001C001D001E001F002000
13	1,2,3,4	01030401000000020000000300000004000000
14	0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32	01060100000000000000000000003A30000001000000000020001000000000000100020003000400050006000700080009000A000B000C000D000E000F0010001100120013001400150016001700180019001A001B001C001D001E001F002000
15	0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32	01060100000000000000000000003A30000001000000000020001000000000000100020003000400050006000700080009000A000B000C000D000E000F0010001100120013001400150016001700180019001A001B001C001D001E001F002000
16	0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42	01060100000000000000000000003A3000000100000000002A001000000000000100020003000400050006000700080009000A000B000C000D000E000F0010001100120013001400150016001700180019001A001B001C001D001E001F0020002100220023002400250026002700280029002A00
SELECT k, rb_to_string(rb_or_agg(rb)), hex(rb_or_agg(rb)) FROM t1;
k	rb_to_string(rb_or_agg(rb))	hex(rb_or_agg(rb))
1	0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42	01060100000000000000000000003A3000000100000000002A001000000000000100020003000400050006000700080009000A000B000C000D000E000F0010001100120013001400150016001700180019001A001B001C001D001E001F0020002100220023002400250026002700280029002A00
rb_and_agg calculate
SELECT k, rb_to_string(rb_and_agg(rb)), hex(rb_and_agg(rb)) FROM t1 GROUP BY k ORDER BY k;
k	rb_to_string(rb_and_agg(rb))	hex(rb_and_agg(rb))
1		0100
2		0100
3		0100
4		0100
5		0100
6		0100
7		0100
8		0100
9	1	010101000000
10	1	010101000000
11	1	010101000000
12	1	010101000000
13	2,3	0103020200000003000000
14	1,2,3	010303010000000200000003000000
15	1,2,3	010303010000000200000003000000
16	10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32	0103170A0000000B0000000C0000000D0000000E0000000F000000100000001100000012000000130000001400000015000000160000001700000018000000190000001A0000001B0000001C0000001D0000001E0000001F00000020000000
SELECT k, rb_to_string(rb_and_agg(rb)), hex(rb_and_agg(rb)) FROM t1;
k	rb_to_string(rb_and_agg(rb))	hex(rb_and_agg(rb))
1		0100
test: rb_or_agg param
select rb_or_agg(NULL);
rb_or_agg(NULL)
NULL
select rb_or_agg(1);
ERROR HY000: invalid type given for an argument
select rb_or_agg('');
ERROR HY000: invalid type given for an argument
select rb_or_agg('a');
ERROR HY000: invalid type given for an argument
select rb_or_agg(x'');
ERROR HY000: Invalid data
test: rb_and_agg param
select rb_and_agg(NULL);
rb_and_agg(NULL)
NULL
select rb_and_agg(1);
ERROR HY000: invalid type given for an argument
select rb_and_agg('');
ERROR HY000: invalid type given for an argument
select rb_and_agg('a');
ERROR HY000: invalid type given for an argument
select rb_and_agg(x'');
ERROR HY000: Invalid data
test: rb_or_agg build from binary
select hex(rb_or_agg(x'0100'));
hex(rb_or_agg(x'0100'))
0100
select hex(rb_or_agg(x'0200'));
ERROR HY000: Invalid data
select hex(rb_or_agg(x'010101000000'));
hex(rb_or_agg(x'010101000000'))
010101000000
select hex(rb_or_agg(x'01010100000000000000'));
ERROR HY000: Invalid data
select hex(rb_or_agg(x'01020100000001000000'));
hex(rb_or_agg(x'01020100000001000000'))
01020100000001000000
select hex(rb_or_agg(x'010201000000'));
ERROR HY000: Invalid data
select hex(rb_or_agg(x'0103'));
ERROR HY000: Invalid data
select hex(rb_or_agg(x'010300'));
ERROR HY000: Invalid data
select hex(rb_or_agg(x'010301'));
ERROR HY000: Invalid data
select hex(rb_or_agg(x'01030101000000'));
ERROR HY000: Invalid data
select hex(rb_or_agg(x'0103020100000002000000'));
hex(rb_or_agg(x'0103020100000002000000'))
0103020100000002000000
select hex(rb_or_agg(x'0103010100000002000000'));
ERROR HY000: Invalid data
select hex(rb_or_agg(x'0104'));
ERROR HY000: Invalid data
select hex(rb_or_agg(x'010400'));
ERROR HY000: Invalid data
select hex(rb_or_agg(x'010401'));
ERROR HY000: Invalid data
select hex(rb_or_agg(x'01040101000000'));
ERROR HY000: Invalid data
select hex(rb_or_agg(x'0104010100000001000000'));
ERROR HY000: Invalid data
select hex(rb_or_agg(x'0104010100000000000000'));
ERROR HY000: Invalid data
select hex(rb_or_agg(x'01040201000000000000000200000000000000'));
hex(rb_or_agg(x'01040201000000000000000200000000000000'))
0103020100000002000000
select hex(rb_or_agg(x'01040201000000000000000100000000000000'));
ERROR HY000: Invalid data
select hex(rb_or_agg(x'01040201000000010000000100000001000000'));
ERROR HY000: Invalid data
select hex(rb_or_agg(x'01040201000000010000000100000002000000'));
hex(rb_or_agg(x'01040201000000010000000100000002000000'))
01040201000000020000000100000001000000
select hex(rb_or_agg(x'0105'));
ERROR HY000: Invalid data
select hex(rb_or_agg(x'01053a30000000000000'));
hex(rb_or_agg(x'01053a30000000000000'))
0100
select hex(rb_or_agg(x'01053a3000000100000000000000100000000100'));
hex(rb_or_agg(x'01053a3000000100000000000000100000000100'))
010101000000
select hex(rb_or_agg(x'01053a30000001000000000001001000000001000200'));
hex(rb_or_agg(x'01053a30000001000000000001001000000001000200'))
0103020100000002000000
select hex(rb_or_agg(x'01053a3000000100000000001f001000000000000100020003000400050006000700080009000a000b000c000d000e000f0010001100120013001400150016001700180019001a001b001c001d001e001f00'));
hex(rb_or_agg(x'01053a3000000100000000001f001000000000000100020003000400050006000700080009000a000b000c000d000e000f0010001100120013001400150016001700180019001a001b001c001d001e001f00'))
010320000000000100000002000000030000000400000005000000060000000700000008000000090000000A0000000B0000000C0000000D0000000E0000000F000000100000001100000012000000130000001400000015000000160000001700000018000000190000001A0000001B0000001C0000001D0000001E0000001F000000
select hex(rb_or_agg(x'0106'));
ERROR HY000: Invalid data
select hex(rb_or_agg(x'01060000000000000000'));
hex(rb_or_agg(x'01060000000000000000'))
0100
select hex(rb_or_agg(x'01060100000000000000000000003a3000000100000000000000100000000100'));
hex(rb_or_agg(x'01060100000000000000000000003a3000000100000000000000100000000100'))
010101000000
select hex(rb_or_agg(x'01060100000000000000010000003a3000000100000000000000100000000000'));
hex(rb_or_agg(x'01060100000000000000010000003a3000000100000000000000100000000000'))
01020000000001000000
select hex(rb_or_agg(x'01060100000000000000000000003a30000001000000000001001000000001000200'));
hex(rb_or_agg(x'01060100000000000000000000003a30000001000000000001001000000001000200'))
0103020100000002000000
select hex(rb_or_agg(x'01060200000000000000000000003a3000000100000000000000100000000100010000003a3000000100000000000000100000000000'));
hex(rb_or_agg(x'01060200000000000000000000003a3000000100000000000000100000000100010000003a3000000100000000000000100000000000'))
01040201000000000000000000000001000000
select hex(rb_or_agg(x'01060100000000000000000000003a3000000100000000001f001000000000000100020003000400050006000700080009000a000b000c000d000e000f0010001100120013001400150016001700180019001a001b001c001d001e001f00'));
hex(rb_or_agg(x'01060100000000000000000000003a3000000100000000001f001000000000000100020003000400050006000700080009000a000b000c000d000e000f0010001100120013001400150016001700180019001a001b001c001d001e001f00'))
010320000000000100000002000000030000000400000005000000060000000700000008000000090000000A0000000B0000000C0000000D0000000E0000000F000000100000001100000012000000130000001400000015000000160000001700000018000000190000001A0000001B0000001C0000001D0000001E0000001F000000
select hex(rb_or_agg(x'01060200000000000000000000003a30000001000000ffff000010000000ffff010000003a3000000100000000001e001000000000000100020003000400050006000700080009000a000b000c000d000e000f0010001100120013001400150016001700180019001a001b001c001d001e00'));
hex(rb_or_agg(x'01060200000000000000000000003a30000001000000ffff000010000000ffff010000003a3000000100000000001e001000000000000100020003000400050006000700080009000a000b000c000d000e000f0010001100120013001400150016001700180019001a001b001c001d001e00'))
0104200B000000010000000C000000010000000D000000010000000E000000010000000F0000000100000010000000010000001100000001000000120000000100000013000000010000001400000001000000150000000100000016000000010000001700000001000000180000000100000019000000010000001A000000010000001B000000010000001C000000010000001D000000010000001E00000001000000FFFFFFFF0000000000000000010000000100000001000000020000000100000003000000010000000400000001000000050000000100000006000000010000000700000001000000080000000100000009000000010000000A00000001000000
select hex(rb_or_agg(x'01062000000000000000000000003a3000000100000000000000100000000000010000003a3000000100000000000000100000000000020000003a3000000100000000000000100000000000030000003a3000000100000000000000100000000000040000003a3000000100000000000000100000000000050000003a3000000100000000000000100000000000060000003a3000000100000000000000100000000000070000003a3000000100000000000000100000000000080000003a3000000100000000000000100000000000090000003a30000001000000000000001000000000000a0000003a30000001000000000000001000000000000b0000003a30000001000000000000001000000000000c0000003a30000001000000000000001000000000000d0000003a30000001000000000000001000000000000e0000003a30000001000000000000001000000000000f0000003a3000000100000000000000100000000000100000003a3000000100000000000000100000000000110000003a3000000100000000000000100000000000120000003a3000000100000000000000100000000000130000003a3000000100000000000000100000000000140000003a3000000100000000000000100000000000150000003a3000000100000000000000100000000000160000003a3000000100000000000000100000000000170000003a3000000100000000000000100000000000180000003a3000000100000000000000100000000000190000003a30000001000000000000001000000000001a0000003a30000001000000000000001000000000001b0000003a30000001000000000000001000000000001c0000003a30000001000000000000001000000000001d0000003a30000001000000000000001000000000001e0000003a30000001000000000000001000000000001f0000003a3000000100000000000000100000000000'));
hex(rb_or_agg(x'01062000000000000000000000003a3000000100000000000000100000000000010000003a3000000100000000000000100000000000020000003a3000000100000000000000100000000000030000003a3000000100000000000000100000000000040000003a300000010000000000000010000000000
010420000000000000000000000000180000000000000013000000000000000E00000000000000090000000000000004000000000000001C00000000000000170000000000000012000000000000000D00000000000000080000000000000003000000000000001B00000000000000160000000000000011000000000000000C0000000000000007000000000000001F0000000000000002000000000000001A00000000000000150000000000000010000000000000000B0000000000000006000000000000001E000000000000000100000000000000190000000000000014000000000000000F000000000000000A0000000000000005000000000000001D000000
drop table if exists user_table;
create table user_table (rb roaringbitmap, brand_group varchar(10), dim varchar(10));
insert into user_table values(@p1, 'bg1', '0'),
(@p2, 'bg2', '1'),
(@p3, 'bg1', '2'),
(@p4, 'bg3', '3'),
(@p5, 'bg1', '4'),
(@p6, 'bg2', '10'),
(@p7, 'bg1', '21'),
(@p6, 'bg2', '4'),
(@p5, 'bg3', '1');
SELECT hex(rb_or_agg(rb)) AS aid, brand_group, dim
FROM user_table
WHERE dim IN ('0', '1', '2', '10')
GROUP BY brand_group, dim;
aid	brand_group	dim
0100	bg1	0
010101000000	bg2	1
010102000000	bg1	2
01060100000000000000000000003A30000001000000000020001000000000000100020003000400050006000700080009000A000B000C000D000E000F0010001100120013001400150016001700180019001A001B001C001D001E001F002000	bg2	10
010303020000000300000004000000	bg3	1
CREATE TABLE t2 (id bigint primary key, k int, rb roaringbitmap);
insert into t2 values (1, 1, @p1),
(2, 1, @p2),
(3, 1, @p3),
(4, 1, @p4),
(5, 1, @p5),
(6, 1, @p6),
(7, 1, @p7),
(8, 2, rb_from_string('1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,100')),
(9, 2, rb_from_string('1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,101')),
(10, 2, rb_from_string('1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,102')),
(11, 2, rb_from_string('1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,103')),
(12, 2, rb_from_string('1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,104'));
explain select /*+ parallel(1) */ rb_to_string(rb_or_agg(rb)) from t2;
Query Plan
=================================================
|ID|OPERATOR         |NAME|EST.ROWS|EST.TIME(us)|
-------------------------------------------------
|0 |SCALAR GROUP BY  |    |1       |3           |
|1 |└─TABLE FULL SCAN|t2  |12      |3           |
=================================================
Outputs & filters:
-------------------------------------
  0 - output([rb_to_string(T_FUN_SYS_RB_OR_AGG(T_FUN_SYS_RB_OR_AGG(t2.rb)))]), filter(nil), rowset=16
      group(nil), agg_func([T_FUN_SYS_RB_OR_AGG(T_FUN_SYS_RB_OR_AGG(t2.rb))])
  1 - output([T_FUN_SYS_RB_OR_AGG(t2.rb)]), filter(nil), rowset=16
      access([t2.rb]), partitions(p0)
      is_index_back=false, is_global_index=false,
      range_key([t2.id]), range(MIN ; MAX)always true,
      pushdown_aggregation([T_FUN_SYS_RB_OR_AGG(t2.rb)])
select /*+ parallel(1) */ rb_to_string(rb_or_agg(rb)) from t2;
rb_to_string(rb_or_agg(rb))
0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,100,101,102,103,104
explain select /*+ parallel(1) */ rb_to_string(rb_and_agg(rb)) from t2;
Query Plan
=================================================
|ID|OPERATOR         |NAME|EST.ROWS|EST.TIME(us)|
-------------------------------------------------
|0 |SCALAR GROUP BY  |    |1       |3           |
|1 |└─TABLE FULL SCAN|t2  |12      |3           |
=================================================
Outputs & filters:
-------------------------------------
  0 - output([rb_to_string(T_FUN_SYS_RB_AND_AGG(T_FUN_SYS_RB_AND_AGG(t2.rb)))]), filter(nil), rowset=16
      group(nil), agg_func([T_FUN_SYS_RB_AND_AGG(T_FUN_SYS_RB_AND_AGG(t2.rb))])
  1 - output([T_FUN_SYS_RB_AND_AGG(t2.rb)]), filter(nil), rowset=16
      access([t2.rb]), partitions(p0)
      is_index_back=false, is_global_index=false,
      range_key([t2.id]), range(MIN ; MAX)always true,
      pushdown_aggregation([T_FUN_SYS_RB_AND_AGG(t2.rb)])
select /*+ parallel(1) */ rb_to_string(rb_and_agg(rb)) from t2;
rb_to_string(rb_and_agg(rb))

explain select /*+ parallel(2) */ k, rb_to_string(rb_or_agg(rb)) from t2 group by k;
Query Plan
=====================================================================
|ID|OPERATOR                         |NAME    |EST.ROWS|EST.TIME(us)|
---------------------------------------------------------------------
|0 |PX COORDINATOR                   |        |12      |45          |
|1 |└─EXCHANGE OUT DISTR             |:EX10001|12      |35          |
|2 |  └─HASH GROUP BY                |        |12      |23          |
|3 |    └─EXCHANGE IN DISTR          |        |12      |21          |
|4 |      └─EXCHANGE OUT DISTR (HASH)|:EX10000|12      |15          |
|5 |        └─HASH GROUP BY          |        |12      |4           |
|6 |          └─PX BLOCK ITERATOR    |        |12      |2           |
|7 |            └─TABLE FULL SCAN    |t2      |12      |2           |
=====================================================================
Outputs & filters:
-------------------------------------
  0 - output([INTERNAL_FUNCTION(t2.k, rb_to_string(T_FUN_SYS_RB_OR_AGG(T_FUN_SYS_RB_OR_AGG(t2.rb))))]), filter(nil), rowset=16
  1 - output([INTERNAL_FUNCTION(t2.k, rb_to_string(T_FUN_SYS_RB_OR_AGG(T_FUN_SYS_RB_OR_AGG(t2.rb))))]), filter(nil), rowset=16
      dop=2
  2 - output([t2.k], [T_FUN_SYS_RB_OR_AGG(T_FUN_SYS_RB_OR_AGG(t2.rb))]), filter(nil), rowset=16
      group([t2.k]), agg_func([T_FUN_SYS_RB_OR_AGG(T_FUN_SYS_RB_OR_AGG(t2.rb))])
  3 - output([t2.k], [T_FUN_SYS_RB_OR_AGG(t2.rb)]), filter(nil), rowset=16
  4 - output([t2.k], [T_FUN_SYS_RB_OR_AGG(t2.rb)]), filter(nil), rowset=16
      (#keys=1, [t2.k]), dop=2
  5 - output([t2.k], [T_FUN_SYS_RB_OR_AGG(t2.rb)]), filter(nil), rowset=16
      group([t2.k]), agg_func([T_FUN_SYS_RB_OR_AGG(t2.rb)])
  6 - output([t2.k], [t2.rb]), filter(nil), rowset=16
  7 - output([t2.k], [t2.rb]), filter(nil), rowset=16
      access([t2.k], [t2.rb]), partitions(p0)
      is_index_back=false, is_global_index=false,
      range_key([t2.id]), range(MIN ; MAX)always true
select /*+ parallel(2) */ k, rb_to_string(rb_or_agg(rb)) from t2 group by k;
k	rb_to_string(rb_or_agg(rb))
1	0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42
2	1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,100,101,102,103,104
explain select /*+ parallel(2) */ k, rb_to_string(rb_and_agg(rb)) from t2 group by k;
Query Plan
=====================================================================
|ID|OPERATOR                         |NAME    |EST.ROWS|EST.TIME(us)|
---------------------------------------------------------------------
|0 |PX COORDINATOR                   |        |12      |45          |
|1 |└─EXCHANGE OUT DISTR             |:EX10001|12      |35          |
|2 |  └─HASH GROUP BY                |        |12      |23          |
|3 |    └─EXCHANGE IN DISTR          |        |12      |21          |
|4 |      └─EXCHANGE OUT DISTR (HASH)|:EX10000|12      |15          |
|5 |        └─HASH GROUP BY          |        |12      |4           |
|6 |          └─PX BLOCK ITERATOR    |        |12      |2           |
|7 |            └─TABLE FULL SCAN    |t2      |12      |2           |
=====================================================================
Outputs & filters:
-------------------------------------
  0 - output([INTERNAL_FUNCTION(t2.k, rb_to_string(T_FUN_SYS_RB_AND_AGG(T_FUN_SYS_RB_AND_AGG(t2.rb))))]), filter(nil), rowset=16
  1 - output([INTERNAL_FUNCTION(t2.k, rb_to_string(T_FUN_SYS_RB_AND_AGG(T_FUN_SYS_RB_AND_AGG(t2.rb))))]), filter(nil), rowset=16
      dop=2
  2 - output([t2.k], [T_FUN_SYS_RB_AND_AGG(T_FUN_SYS_RB_AND_AGG(t2.rb))]), filter(nil), rowset=16
      group([t2.k]), agg_func([T_FUN_SYS_RB_AND_AGG(T_FUN_SYS_RB_AND_AGG(t2.rb))])
  3 - output([t2.k], [T_FUN_SYS_RB_AND_AGG(t2.rb)]), filter(nil), rowset=16
  4 - output([t2.k], [T_FUN_SYS_RB_AND_AGG(t2.rb)]), filter(nil), rowset=16
      (#keys=1, [t2.k]), dop=2
  5 - output([t2.k], [T_FUN_SYS_RB_AND_AGG(t2.rb)]), filter(nil), rowset=16
      group([t2.k]), agg_func([T_FUN_SYS_RB_AND_AGG(t2.rb)])
  6 - output([t2.k], [t2.rb]), filter(nil), rowset=16
  7 - output([t2.k], [t2.rb]), filter(nil), rowset=16
      access([t2.k], [t2.rb]), partitions(p0)
      is_index_back=false, is_global_index=false,
      range_key([t2.id]), range(MIN ; MAX)always true
select /*+ parallel(2) */ k, rb_to_string(rb_and_agg(rb)) from t2 group by k;
k	rb_to_string(rb_and_agg(rb))
1
2	1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33
explain select /*+ parallel(2) NO_GBY_PUSHDOWN */ k, rb_to_string(rb_or_agg(rb)) from t2 group by k;
Query Plan
=====================================================================
|ID|OPERATOR                         |NAME    |EST.ROWS|EST.TIME(us)|
---------------------------------------------------------------------
|0 |PX COORDINATOR                   |        |12      |33          |
|1 |└─EXCHANGE OUT DISTR             |:EX10001|12      |22          |
|2 |  └─HASH GROUP BY                |        |12      |10          |
|3 |    └─EXCHANGE IN DISTR          |        |12      |9           |
|4 |      └─EXCHANGE OUT DISTR (HASH)|:EX10000|12      |6           |
|5 |        └─PX BLOCK ITERATOR      |        |12      |2           |
|6 |          └─TABLE FULL SCAN      |t2      |12      |2           |
=====================================================================
Outputs & filters:
-------------------------------------
  0 - output([INTERNAL_FUNCTION(t2.k, rb_to_string(T_FUN_SYS_RB_OR_AGG(t2.rb)))]), filter(nil), rowset=16
  1 - output([INTERNAL_FUNCTION(t2.k, rb_to_string(T_FUN_SYS_RB_OR_AGG(t2.rb)))]), filter(nil), rowset=16
      dop=2
  2 - output([t2.k], [T_FUN_SYS_RB_OR_AGG(t2.rb)]), filter(nil), rowset=16
      group([t2.k]), agg_func([T_FUN_SYS_RB_OR_AGG(t2.rb)])
  3 - output([t2.k], [t2.rb]), filter(nil), rowset=16
  4 - output([t2.k], [t2.rb]), filter(nil), rowset=16
      (#keys=1, [t2.k]), dop=2
  5 - output([t2.k], [t2.rb]), filter(nil), rowset=16
  6 - output([t2.k], [t2.rb]), filter(nil), rowset=16
      access([t2.k], [t2.rb]), partitions(p0)
      is_index_back=false, is_global_index=false,
      range_key([t2.id]), range(MIN ; MAX)always true
select /*+ parallel(2) NO_GBY_PUSHDOWN */ k, rb_to_string(rb_or_agg(rb)) from t2 group by k;
k	rb_to_string(rb_or_agg(rb))
1	0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42
2	1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,100,101,102,103,104
explain select /*+ parallel(2) NO_GBY_PUSHDOWN */ k, rb_to_string(rb_and_agg(rb)) from t2 group by k;
Query Plan
=====================================================================
|ID|OPERATOR                         |NAME    |EST.ROWS|EST.TIME(us)|
---------------------------------------------------------------------
|0 |PX COORDINATOR                   |        |12      |33          |
|1 |└─EXCHANGE OUT DISTR             |:EX10001|12      |22          |
|2 |  └─HASH GROUP BY                |        |12      |10          |
|3 |    └─EXCHANGE IN DISTR          |        |12      |9           |
|4 |      └─EXCHANGE OUT DISTR (HASH)|:EX10000|12      |6           |
|5 |        └─PX BLOCK ITERATOR      |        |12      |2           |
|6 |          └─TABLE FULL SCAN      |t2      |12      |2           |
=====================================================================
Outputs & filters:
-------------------------------------
  0 - output([INTERNAL_FUNCTION(t2.k, rb_to_string(T_FUN_SYS_RB_AND_AGG(t2.rb)))]), filter(nil), rowset=16
  1 - output([INTERNAL_FUNCTION(t2.k, rb_to_string(T_FUN_SYS_RB_AND_AGG(t2.rb)))]), filter(nil), rowset=16
      dop=2
  2 - output([t2.k], [T_FUN_SYS_RB_AND_AGG(t2.rb)]), filter(nil), rowset=16
      group([t2.k]), agg_func([T_FUN_SYS_RB_AND_AGG(t2.rb)])
  3 - output([t2.k], [t2.rb]), filter(nil), rowset=16
  4 - output([t2.k], [t2.rb]), filter(nil), rowset=16
      (#keys=1, [t2.k]), dop=2
  5 - output([t2.k], [t2.rb]), filter(nil), rowset=16
  6 - output([t2.k], [t2.rb]), filter(nil), rowset=16
      access([t2.k], [t2.rb]), partitions(p0)
      is_index_back=false, is_global_index=false,
      range_key([t2.id]), range(MIN ; MAX)always true
select /*+ parallel(2) NO_GBY_PUSHDOWN */ k, rb_to_string(rb_and_agg(rb)) from t2 group by k;
k	rb_to_string(rb_and_agg(rb))
1
2	1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33
explain select /*+ parallel(2) GBY_PUSHDOWN */ rb_to_string(rb_or_agg(rb)) from t2;
Query Plan
=============================================================
|ID|OPERATOR                 |NAME    |EST.ROWS|EST.TIME(us)|
-------------------------------------------------------------
|0 |SCALAR GROUP BY          |        |1       |5           |
|1 |└─PX COORDINATOR         |        |2       |5           |
|2 |  └─EXCHANGE OUT DISTR   |:EX10000|2       |3           |
|3 |    └─MERGE GROUP BY     |        |2       |2           |
|4 |      └─PX BLOCK ITERATOR|        |12      |2           |
|5 |        └─TABLE FULL SCAN|t2      |12      |2           |
=============================================================
Outputs & filters:
-------------------------------------
  0 - output([rb_to_string(T_FUN_SYS_RB_OR_AGG(T_FUN_SYS_RB_OR_AGG(T_FUN_SYS_RB_OR_AGG(t2.rb))))]), filter(nil), rowset=16
      group(nil), agg_func([T_FUN_SYS_RB_OR_AGG(T_FUN_SYS_RB_OR_AGG(T_FUN_SYS_RB_OR_AGG(t2.rb)))])
  1 - output([T_FUN_SYS_RB_OR_AGG(T_FUN_SYS_RB_OR_AGG(t2.rb))]), filter(nil), rowset=16
  2 - output([T_FUN_SYS_RB_OR_AGG(T_FUN_SYS_RB_OR_AGG(t2.rb))]), filter(nil), rowset=16
      dop=2
  3 - output([T_FUN_SYS_RB_OR_AGG(T_FUN_SYS_RB_OR_AGG(t2.rb))]), filter(nil), rowset=16
      group(nil), agg_func([T_FUN_SYS_RB_OR_AGG(T_FUN_SYS_RB_OR_AGG(t2.rb))])
  4 - output([T_FUN_SYS_RB_OR_AGG(t2.rb)]), filter(nil), rowset=16
  5 - output([T_FUN_SYS_RB_OR_AGG(t2.rb)]), filter(nil), rowset=16
      access([t2.rb]), partitions(p0)
      is_index_back=false, is_global_index=false,
      range_key([t2.id]), range(MIN ; MAX)always true,
      pushdown_aggregation([T_FUN_SYS_RB_OR_AGG(t2.rb)])
select /*+ parallel(2) GBY_PUSHDOWN */ rb_to_string(rb_or_agg(rb)) from t2;
rb_to_string(rb_or_agg(rb))
0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,100,101,102,103,104
explain select /*+ parallel(2) GBY_PUSHDOWN */ k, rb_to_string(rb_and_agg(rb)) from t2;
Query Plan
=============================================================
|ID|OPERATOR                 |NAME    |EST.ROWS|EST.TIME(us)|
-------------------------------------------------------------
|0 |SCALAR GROUP BY          |        |1       |6           |
|1 |└─PX COORDINATOR         |        |2       |6           |
|2 |  └─EXCHANGE OUT DISTR   |:EX10000|2       |4           |
|3 |    └─MERGE GROUP BY     |        |2       |2           |
|4 |      └─PX BLOCK ITERATOR|        |12      |2           |
|5 |        └─TABLE FULL SCAN|t2      |12      |2           |
=============================================================
Outputs & filters:
-------------------------------------
  0 - output([t2.k], [rb_to_string(T_FUN_SYS_RB_AND_AGG(T_FUN_SYS_RB_AND_AGG(t2.rb)))]), filter(nil), rowset=16
      group(nil), agg_func([T_FUN_SYS_RB_AND_AGG(T_FUN_SYS_RB_AND_AGG(t2.rb))])
  1 - output([t2.k], [T_FUN_SYS_RB_AND_AGG(t2.rb)]), filter(nil), rowset=16
  2 - output([t2.k], [T_FUN_SYS_RB_AND_AGG(t2.rb)]), filter(nil), rowset=16
      dop=2
  3 - output([t2.k], [T_FUN_SYS_RB_AND_AGG(t2.rb)]), filter(nil), rowset=16
      group(nil), agg_func([T_FUN_SYS_RB_AND_AGG(t2.rb)])
  4 - output([t2.k], [t2.rb]), filter(nil), rowset=16
  5 - output([t2.k], [t2.rb]), filter(nil), rowset=16
      access([t2.k], [t2.rb]), partitions(p0)
      is_index_back=false, is_global_index=false,
      range_key([t2.id]), range(MIN ; MAX)always true
select /*+ parallel(2) GBY_PUSHDOWN*/ k, rb_to_string(rb_and_agg(rb)) from t2;
k	rb_to_string(rb_and_agg(rb))
1
create table t3(id bigint primary key, c1 bigint, rb roaringbitmap) partition by key(id) partitions 8;
insert into t3 select abs(random(0)), (abs(random(1))%500+455876444690), rb_from_string(cast(abs(random(1))%500+455876444690 as char(10000))) from table(generator(1000));
select count(c1) from t3;
count(c1)
1000
select count(distinct c1)from t3;
count(distinct c1)
424
explain select /*+ parallel(2) */ rb_cardinality(rb_or_agg(rb)) from t3;
Query Plan
=============================================================
|ID|OPERATOR                 |NAME    |EST.ROWS|EST.TIME(us)|
-------------------------------------------------------------
|0 |SCALAR GROUP BY          |        |1       |34          |
|1 |└─PX COORDINATOR         |        |2       |34          |
|2 |  └─EXCHANGE OUT DISTR   |:EX10000|2       |33          |
|3 |    └─MERGE GROUP BY     |        |2       |31          |
|4 |      └─PX BLOCK ITERATOR|        |1000    |22          |
|5 |        └─TABLE FULL SCAN|t3      |1000    |22          |
=============================================================
Outputs & filters:
-------------------------------------
  0 - output([rb_cardinality(T_FUN_SYS_RB_OR_AGG(T_FUN_SYS_RB_OR_AGG(T_FUN_SYS_RB_OR_AGG(t3.rb))))]), filter(nil), rowset=256
      group(nil), agg_func([T_FUN_SYS_RB_OR_AGG(T_FUN_SYS_RB_OR_AGG(T_FUN_SYS_RB_OR_AGG(t3.rb)))])
  1 - output([T_FUN_SYS_RB_OR_AGG(T_FUN_SYS_RB_OR_AGG(t3.rb))]), filter(nil), rowset=256
  2 - output([T_FUN_SYS_RB_OR_AGG(T_FUN_SYS_RB_OR_AGG(t3.rb))]), filter(nil), rowset=256
      dop=2
  3 - output([T_FUN_SYS_RB_OR_AGG(T_FUN_SYS_RB_OR_AGG(t3.rb))]), filter(nil), rowset=256
      group(nil), agg_func([T_FUN_SYS_RB_OR_AGG(T_FUN_SYS_RB_OR_AGG(t3.rb))])
  4 - output([T_FUN_SYS_RB_OR_AGG(t3.rb)]), filter(nil), rowset=256
  5 - output([T_FUN_SYS_RB_OR_AGG(t3.rb)]), filter(nil), rowset=256
      access([t3.rb]), partitions(p[0-7])
      is_index_back=false, is_global_index=false,
      range_key([t3.id]), range(MIN ; MAX)always true,
      pushdown_aggregation([T_FUN_SYS_RB_OR_AGG(t3.rb)])
select /*+ parallel(2) */ rb_cardinality(rb_or_agg(rb)) from t3;
rb_cardinality(rb_or_agg(rb))
424
explain select /*+ parallel(2) */ rb_cardinality(rb_and_agg(rb)) from t3;
Query Plan
=============================================================
|ID|OPERATOR                 |NAME    |EST.ROWS|EST.TIME(us)|
-------------------------------------------------------------
|0 |SCALAR GROUP BY          |        |1       |34          |
|1 |└─PX COORDINATOR         |        |2       |34          |
|2 |  └─EXCHANGE OUT DISTR   |:EX10000|2       |33          |
|3 |    └─MERGE GROUP BY     |        |2       |31          |
|4 |      └─PX BLOCK ITERATOR|        |1000    |22          |
|5 |        └─TABLE FULL SCAN|t3      |1000    |22          |
=============================================================
Outputs & filters:
-------------------------------------
  0 - output([rb_cardinality(T_FUN_SYS_RB_AND_AGG(T_FUN_SYS_RB_AND_AGG(T_FUN_SYS_RB_AND_AGG(t3.rb))))]), filter(nil), rowset=256
      group(nil), agg_func([T_FUN_SYS_RB_AND_AGG(T_FUN_SYS_RB_AND_AGG(T_FUN_SYS_RB_AND_AGG(t3.rb)))])
  1 - output([T_FUN_SYS_RB_AND_AGG(T_FUN_SYS_RB_AND_AGG(t3.rb))]), filter(nil), rowset=256
  2 - output([T_FUN_SYS_RB_AND_AGG(T_FUN_SYS_RB_AND_AGG(t3.rb))]), filter(nil), rowset=256
      dop=2
  3 - output([T_FUN_SYS_RB_AND_AGG(T_FUN_SYS_RB_AND_AGG(t3.rb))]), filter(nil), rowset=256
      group(nil), agg_func([T_FUN_SYS_RB_AND_AGG(T_FUN_SYS_RB_AND_AGG(t3.rb))])
  4 - output([T_FUN_SYS_RB_AND_AGG(t3.rb)]), filter(nil), rowset=256
  5 - output([T_FUN_SYS_RB_AND_AGG(t3.rb)]), filter(nil), rowset=256
      access([t3.rb]), partitions(p[0-7])
      is_index_back=false, is_global_index=false,
      range_key([t3.id]), range(MIN ; MAX)always true,
      pushdown_aggregation([T_FUN_SYS_RB_AND_AGG(t3.rb)])
select /*+ parallel(2) */ rb_cardinality(rb_and_agg(rb)) from t3;
rb_cardinality(rb_and_agg(rb))
0
explain select /*+ parallel(2) opt_param('pushdown_storage_level', 0) */ rb_cardinality(rb_or_agg(rb)) from t3;
Query Plan
=============================================================
|ID|OPERATOR                 |NAME    |EST.ROWS|EST.TIME(us)|
-------------------------------------------------------------
|0 |SCALAR GROUP BY          |        |1       |34          |
|1 |└─PX COORDINATOR         |        |2       |34          |
|2 |  └─EXCHANGE OUT DISTR   |:EX10000|2       |33          |
|3 |    └─MERGE GROUP BY     |        |2       |31          |
|4 |      └─PX BLOCK ITERATOR|        |1000    |22          |
|5 |        └─TABLE FULL SCAN|t3      |1000    |22          |
=============================================================
Outputs & filters:
-------------------------------------
  0 - output([rb_cardinality(T_FUN_SYS_RB_OR_AGG(T_FUN_SYS_RB_OR_AGG(t3.rb)))]), filter(nil), rowset=256
      group(nil), agg_func([T_FUN_SYS_RB_OR_AGG(T_FUN_SYS_RB_OR_AGG(t3.rb))])
  1 - output([T_FUN_SYS_RB_OR_AGG(t3.rb)]), filter(nil), rowset=256
  2 - output([T_FUN_SYS_RB_OR_AGG(t3.rb)]), filter(nil), rowset=256
      dop=2
  3 - output([T_FUN_SYS_RB_OR_AGG(t3.rb)]), filter(nil), rowset=256
      group(nil), agg_func([T_FUN_SYS_RB_OR_AGG(t3.rb)])
  4 - output([t3.rb]), filter(nil), rowset=256
  5 - output([t3.rb]), filter(nil), rowset=256
      access([t3.rb]), partitions(p[0-7])
      is_index_back=false, is_global_index=false,
      range_key([t3.id]), range(MIN ; MAX)always true
select /*+ parallel(2) opt_param('pushdown_storage_level', 0) */ rb_cardinality(rb_or_agg(rb)) from t3;
rb_cardinality(rb_or_agg(rb))
424
explain select /*+ parallel(2) opt_param('pushdown_storage_level', 0) */ rb_cardinality(rb_and_agg(rb)) from t3;
Query Plan
=============================================================
|ID|OPERATOR                 |NAME    |EST.ROWS|EST.TIME(us)|
-------------------------------------------------------------
|0 |SCALAR GROUP BY          |        |1       |34          |
|1 |└─PX COORDINATOR         |        |2       |34          |
|2 |  └─EXCHANGE OUT DISTR   |:EX10000|2       |33          |
|3 |    └─MERGE GROUP BY     |        |2       |31          |
|4 |      └─PX BLOCK ITERATOR|        |1000    |22          |
|5 |        └─TABLE FULL SCAN|t3      |1000    |22          |
=============================================================
Outputs & filters:
-------------------------------------
  0 - output([rb_cardinality(T_FUN_SYS_RB_AND_AGG(T_FUN_SYS_RB_AND_AGG(t3.rb)))]), filter(nil), rowset=256
      group(nil), agg_func([T_FUN_SYS_RB_AND_AGG(T_FUN_SYS_RB_AND_AGG(t3.rb))])
  1 - output([T_FUN_SYS_RB_AND_AGG(t3.rb)]), filter(nil), rowset=256
  2 - output([T_FUN_SYS_RB_AND_AGG(t3.rb)]), filter(nil), rowset=256
      dop=2
  3 - output([T_FUN_SYS_RB_AND_AGG(t3.rb)]), filter(nil), rowset=256
      group(nil), agg_func([T_FUN_SYS_RB_AND_AGG(t3.rb)])
  4 - output([t3.rb]), filter(nil), rowset=256
  5 - output([t3.rb]), filter(nil), rowset=256
      access([t3.rb]), partitions(p[0-7])
      is_index_back=false, is_global_index=false,
      range_key([t3.id]), range(MIN ; MAX)always true
select /*+ parallel(2) opt_param('pushdown_storage_level', 0) */ rb_cardinality(rb_and_agg(rb)) from t3;
rb_cardinality(rb_and_agg(rb))
0
drop table if exists t1, t2, t3;
