--disable_query_log
set @@session.explicit_defaults_for_timestamp=off;
--enable_query_log
# owner: dachuan.sdc
# owner group: SQL3
# description: foobar
# testing of the minimal feature set (no exception cases)
# only use BIGINT and VARCHAR data types in the case
#--disable_query_log
#--disable_result_log
#--disable_abort_on_error

set global ob_query_timeout = DEFAULT;
set global ob_trx_idle_timeout = DEFAULT;
set global ob_trx_timeout = DEFAULT;
connect (obsys,$OBMYSQL_MS0,admin,$OBMYSQL_PWD,test,$OBMYSQL_PORT);
#connection obsys;
#--error 0,5157
#drop tenant tenant force;
#--error 0,4650
#drop resource pool new_pool1;
#--error 0,4648
#drop resource unit new_box1;

#--disable_query_log
#eval create resource unit new_box1 max_cpu 1, memory_size '2G';
#let $zone_name=query_get_value(select zone from oceanbase.__all_zone where zone != '' limit 1, zone, 1);

#let $obs_num = query_get_value(select count(1) as cnt from oceanbase.__all_server group by zone limit 1,cnt, 1);
#eval create resource pool new_pool1 unit = 'new_box1', unit_num = $obs_num;
#eval create tenant tenant primary_zone='$zone_name', resource_pool_list('new_pool1') set ob_tcp_invited_nodes='%';
#--enable_result_log
#--enable_query_log
#--source mysql_test/include/check_tenant_sync.inc
#disconnect obsys;

connect (conn1,$OBMYSQL_MS0,root@sys,,test,$OBMYSQL_PORT);
--disable_info
--disable_metadata

--echo ================ basic DDL & DML ================
# basic DDL and DML
set ob_enable_index_direct_select =0;
--disable_warnings
create database if not exists test;
--enable_warnings
use test;
select database();
show databases like 'test';

--disable_warnings
drop table if exists t0, t1, t2;
--enable_warnings
create table t0 (c1 int, c2 int);
create table t1 (c1 bigint primary key, c2 bigint, v1 varchar(128), v2 varchar(64));
show tables like 't0';
show tables like 't1';

insert into t1 values (1, 2, 'a', 'b'), (10, NULL, 'c', NULL);
select * from t1;
--error 1062
insert into t1 values (1, NULL, NULL, NULL);

update t1 set c2 = 100 where c1 = 1;
update t1 set c2 = c2+1 where c1 = 1;
select * from t1;
delete from t1 where c1 < 10;
select * from t1;
# primary key update
update t1 set c1 = c1 + 1 where c1 > 0;
select * from t1;
delete from t1;
select * from t1;


# ref update
create table all_table (index_status int primary key, id int, schema_version int);
insert into all_table values (1,2,3);
select * from all_table;
update all_table SET index_status = 5, schema_version=schema_version+10 WHERE id=2;
select * from all_table;
drop table all_table;

drop table t1;
drop database test;
--sleep 3
show databases like 'test';
create database test;
--sleep 3
use test;

# transaction
--echo ================ transaction ================
create table t1 (c1 bigint primary key, c2 bigint, v1 varchar(128), v2 varchar(64));
start transaction;
insert into t1 (c1, c2) values (1, 2);
select * from t1;
rollback;
select * from t1;

start transaction;
insert into t1 (c1, c2) values (1, 2);
select * from t1;
commit;
select * from t1;
delete from t1;
# show variables like 'autocommit';
# set autocommit = 0;
# insert into t1 (c1, c2) values (2, 3);
# select * from t1;
# rollback;
# select * from t1;
# insert into t1 (c1, c2) values (2, 3);
# select * from t1;
# commit;
# select * from t1;
# delete * from t1;

--echo ================ alias ================
# alias
insert into t1 values (1, 2, 'a', 'b'), (10, 2, 'a', 'f'), (100, 3, 'e', 'f'), (1000, 3, 'a', 'e');
select * from t1;
select c1+c2 added from t1;

--echo ================ aggregate ================
# aggregate
select count(*), count(c1), sum(c1), max(v1), max(c2), avg(c2) from t1;
--sorted_result
select count(*), count(c1), sum(c1), max(v1), max(c2), avg(c2), count(c1)+sum(c2) from t1 group by c2;
--sorted_result
select count(*), count(c1), sum(c1), max(v1), max(c2), avg(c2) from t1 group by c2, v1;
--sorted_result
select count(*), count(c1), sum(c1), max(v1), max(c2), avg(c2) from t1 group by c2, v1 having sum(c1+1) > 100;
# distinct
select distinct c2, c2+1 from t1;

--echo ================ order ================
# order
select * from t1 order by v1;
select * from t1 order by v1, c1 desc;
select * from t1 order by c1;
select * from t1 order by c1 desc;

--echo ================ limit ================
# limit
select * from t1 limit 1;
select * from t1 limit 1, 1;
select * from t1 limit 1 offset 1;
--error 1064
select * from t1 limit -1, 1;
select * from t1 limit 0, 1;
select * from t1 limit 0, 10;

--echo ================ set ================
# set
(select * from t1) union all (select * from t1);
# (select * from t1) union all (select * from t1) order by c1;
# (select * from t1 where c1 > 1) union (select * from t1 where c1 < 1000);
# (select * from t1 where c1 > 1) intersect (select * from t1 where c1 < 1000);
# (select * from t1 where c1 > 1) except (select * from t1 where c1 < 1000);

--echo ================ join ================
# join
select * from t1 X, t1 Y where X.c1 = Y.c1;
create table t2 (c1 bigint primary key, c2 bigint);
insert into t2 (c2, c1) values (1, 2), (100, 0), (50, -1);
--sorted_result
select * from t1, t2;
--sorted_result
select * from t1, t2 where t1.c1 < t2.c2;
--sorted_result
select * from t1 inner join t2 on t1.c1 = t2.c2;
--sorted_result
select * from t1 left join t2 on t1.c1 = t2.c2;
--sorted_result
select * from t1 right join t2 on t1.c1 = t2.c2;
--sorted_result
select * from t1 full join t2 on t1.c1 = t2.c2;

--echo ================ virtual table & show ================
# virtual tables & show
set global max_allowed_packet=default;
show tables like 't1';
show tables like '%c%';
show variables where Variable_name like 'ob%' and Variable_name != 'ob_proxy_partition_hit' and Variable_name != 'ob_last_schema_version' and Variable_name != 'ob_compatibility_version'  and Variable_name != 'ob_security_version';
show variables like 'ob_trx_timeout';
set ob_trx_timeout = 200000000;
show variables like 'ob_trx_timeout';
show global variables where Variable_name like 'ob%' and Variable_name != 'ob_compatibility_version'  and Variable_name != 'ob_security_version';
show global variables like 'max_allowed_packet';
set global max_allowed_packet=8388608;
show global variables like 'max_allowed_packet';
set global max_allowed_packet=default;
show global variables like 'max_allowed_packet';
--error 1621
set max_allowed_packet=8388608;
disconnect obsys;
connect (obsys,$OBMYSQL_MS0,admin,$OBMYSQL_PWD,test,$OBMYSQL_PORT);
connection obsys;
show columns from oceanbase.__all_core_table;
show index from oceanbase.__all_core_table;
--error 1238
set version_comment = 'aaa';
disconnect obsys;
connection default;

--echo ================ partition selection ================
# partition selection
--disable_warnings
drop table if exists t_part;
--enable_warnings
create table t_part (c1 int primary key, c2 int) partition by hash(c1) partitions 2;
--error 1264
insert into t_part(c1) values(1231346464513131231313);
insert into t_part values(1, 2), (3, 1);
insert into t_part values(2, 3), (4, 3);
insert into t_part partition(p0, p1) values(5, 6);
# can calc partition id with column type cast
insert into t_part values('6', '6'), ('8', '8');
--error 1748
insert into t_part partition(p1) values(6, 3);
update t_part partition(p0) set c2 = 6 where c1 = 2;
update t_part partition(p1) set c2 = 7 where c1 = 2;
select * from t_part partition (p0);
select * from t_part partition(p1);
--error 1735
select * from t_part partition(p1, p3);
#cross partition test
create table t_single(c1 int);
--error 0,1235
delete from t_single where c1 in (select c1 from t_part);
--error 0,1235
delete from t_single where c1 in (select/*+read_consistency(weak)*/ c1 from t_part);
delete from t_part where c1 in (select c1 from t_single);
drop table t_single;

# tenant

# UK/PK err msg
create table t3(a int, b float, c varchar(30), d double, e varchar(50), primary key(a,b,c), unique index(e, d));
insert into t3 values(1, 2.00000, 'aaaa', '1.000000000', 'aaaaaaaaaaaaaaaa');
insert into t3 values(2, 2.00000, 'aaaa', '2.000000000', 'aaaaaaaaaaaaaaaa');
--error 1062
insert into t3 values(1, 2.00000, 'aaaa', '1.000000000', 'aaaaaaaaaaaaaaaa');
--error 1062
update t3 set a=1 where a=2;
--error 1062
insert into t3 values(3, 2.00000, 'aaaa', '1.000000000', 'aaaaaaaaaaaaaaaa');

--echo ================ regexp ================
create table t4 (a int primary key, b varchar(100));
insert into t4 values(1, 'hello');
insert into t4 values(2, 'aaaaabaaaabaaaabaaaabweeknights');
insert into t4 values(3, 'dsfsdaaagd');
select * from t4 where b regexp 'aaa';
select * from t4 where b regexp '^h.*';
select * from t4 where b not regexp 'aaa';
select * from t4 where b not regexp '^h.*';
select * from t4 where b rlike 'aaa';
select * from t4 where b rlike '^h.*';
select * from t4 where b not rlike 'aaa';
select * from t4 where b not rlike '^h.*';
create table t5(c1 varchar(2) primary key, c2 varchar(2));
insert into t5 values('aa','a'),('bb','b'), ('cc', 'd');
select c1 regexp c2, c1 rlike c2 from t5;
select true = (1234 regexp 23);
select true = (1234 regexp 99);

--echo ================ system variable or user variable ================
set @now_time=now();
--replace_column 1 cur_time
select @now_time;
set @cur_time=CURRENT_TIMESTAMP();
--replace_column 1 cur_time
select @cur_time;
show variables like 'character_set_results';
set character_set_results = NULL;
show variables like 'character_set_results';
select @@session.character_set_results;
show global variables like 'auto_increment_increment';
set global auto_increment_increment = 5;
show global variables like 'auto_increment_increment';
show variables like 'auto_increment_increment';
set auto_increment_increment = default;
show variables like 'auto_increment_increment';
set global auto_increment_increment = default;
show global variables like 'auto_increment_increment';

--echo ================ weak read ================
--disable_warnings
drop table if exists t6;
--enable_warnings
create table t6 (pk int primary key, c1 int, c2 int);
begin;
select pk from t6;
select /*+read_consistency(weak)*/ c1 from t6;
rollback;
begin;
#select /*+read_consistency(weak)*/ database_name from oceanbase.__all_virtual_database where database_name = 'oceanbase' and tenant_id = 1;
#select /*+read_consistency(weak)*/ t1.database_name from oceanbase.__all_virtual_database t1, t6 where t1.database_name = 'oceanbase' and t1.tenant_id = 1;
show tables like 't6';
select * from t6;
select table_name from information_schema.tables where table_name = 't6';
select /*+read_consistency(weak)*/ c2 from t6;
rollback;
#connect (obsys,$OBMYSQL_MS0,admin,$OBMYSQL_PWD,test,$OBMYSQL_PORT);
#connection obsys;
# 再跑一遍，走plan cache
begin;
select pk from t6;
select /*+read_consistency(weak)*/ c1 from t6;
rollback;
begin;
#select /*+read_consistency(weak)*/ database_name from oceanbase.__all_virtual_database where database_name = 'oceanbase' and tenant_id = 1;
#select /*+read_consistency(weak)*/ t1.database_name from oceanbase.__all_virtual_database t1, t6 where t1.database_name = 'oceanbase' and t1.tenant_id = 1;
show tables like 't6';
select * from t6;
select table_name from information_schema.tables where table_name = 't6';
select /*+read_consistency(weak)*/ c2 from t6;
rollback;
#disconnect obsys;
#connection default;


--echo ================ partition by range ================
--disable_warnings
drop table if exists t7;
--enable_warnings
create table t7 (pk int, c1 int, primary key (pk))
partition by range columns(pk)
(
  partition p_2016_11_02_00 values less than (100),
  partition p_2016_11_04_00 values less than (200),
  partition p_2016_11_03_00 values less than (300),
  partition p_max_value values less than (MAXVALUE)
);
insert into t7 values (1, 1), (2, 2), (3, 3);
insert into t7 values (101, 1), (102, 2), (103, 3);
insert into t7 values (201, 1), (202, 2), (203, 3);
select * from t7;
select * from t7 order by pk;
select * from t7 order by pk;
select * from t7 order by pk desc;
select * from t7 order by pk desc;

--echo ================ intra partition parallelism ================
--disable_warnings
drop table if exists t8;
--enable_warnings
create table t8(c1 int primary key, c2 varchar(1000));
select /*+ parallel(2) */ count(*) from t8;

--echo ================ teardown ================
# tear down
--disable_warnings
drop table if exists t0, t1, t2, t_part, t3, t4, t5, t6, t7, t8;
--enable_warnings
--disable_query_log
--disable_result_log
#connect (conn_admin,$OBMYSQL_MS0,root@sys,admin,*NO-ONE*,$OBMYSQL_PORT);
#drop tenant tenant force;
#drop resource pool new_pool1;
#drop resource unit new_box1;
#--enable_result_log
#--enable_query_log
